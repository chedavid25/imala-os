document.addEventListener("DOMContentLoaded",function(){let m=window.Imala.db,g=window.Imala.auth,p=(g.onAuthStateChanged(e=>{e?(m.collection("users").get().then(e=>{r=[],e.forEach(e=>r.push({id:e.id,...e.data()})),s()}),m.collection("offices").get().then(e=>{c=[],e.forEach(e=>c.push({id:e.id,...e.data()})),n()}),m.collection("teams").get().then(e=>{u=[],e.forEach(e=>u.push({id:e.id,...e.data()})),n()}),m.collection("assigned_tasks").orderBy("createdAt","desc").onSnapshot(e=>{o=[],e.forEach(e=>o.push({id:e.id,...e.data()}));{e=o;let a=(new Date).toISOString().split("T")[0];e.forEach(t=>{if(t.dueDate){let e="";t.dueDate.seconds?e=new Date(1e3*t.dueDate.seconds).toISOString().split("T")[0]:"string"==typeof t.dueDate?e=t.dueDate:t.dueDate instanceof Date&&(e=t.dueDate.toISOString().split("T")[0]),"PENDING"===t.status&&e&&e<a&&(console.log(`Marcando tarea ${t.id} como Atrasada`),m.collection("assigned_tasks").doc(t.id).update({status:"LATE"}))}})}{e=o;let t=0,a="";e.forEach(e=>{e.hasAdminUnread&&(t++,a+=`
                    <a href="javascript:void(0);" onclick="openAdminChat('${e.id}')" class="text-reset notification-item">
                        <div class="d-flex">
                            <div class="avatar-xs me-3">
                                <span class="avatar-title bg-danger rounded-circle font-size-16">
                                    <i class="bx bx-chat"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${e.title}</h6>
                                <div class="font-size-12 text-muted">
                                    <p class="mb-1">Nuevo mensaje en bitácora</p>
                                </div>
                            </div>
                        </div>
                    </a>
                `)}),0<t?(A.style.display="block",A.textContent=t,x.innerHTML=a):(A.style.display="none",x.innerHTML='<div class="text-center p-3 text-muted">No hay notificaciones nuevas.</div>')}h.options.length<=1&&0<u.length&&n(),d()})):window.location.href="auth-login.html"}),new bootstrap.Modal(document.getElementById("task-modal"))),r=[],c=[],u=[],i;var e=document.getElementById("btn-new-task");let f=document.getElementById("form-task");var t=document.getElementsByName("assign-type");let a=document.getElementById("assign-target");function s(){var t=document.querySelector('input[name="assign-type"]:checked').value;if(a.innerHTML="",a.classList.remove("d-none"),"ALL"===t)a.classList.add("d-none");else{let e=[];"USER"===t?e=r.map(e=>({id:e.id,name:e.displayName+` (${e.email})`})):"OFFICE"===t?e=c.map(e=>({id:e.id,name:e.name})):"TEAM"===t?e=u.map(e=>({id:e.id,name:e.name})):"ROLE"===t&&(e=[{id:"ADMIN",name:"Administradores"},{id:"BROKER",name:"Brokers"},{id:"TEAM_LEADER",name:"Team Leaders"},{id:"MEMBER",name:"Miembros"},{id:"ASSISTANT",name:"Asistentes"}]),e.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,a.appendChild(t)})}}t.forEach(e=>{e.addEventListener("change",s)});let E=window.Imala.storage,y=null,o=(e.addEventListener("click",()=>{f.reset(),y=null,document.getElementById("taskModalLabel").textContent="Crear Nueva Tarea",document.getElementById("btn-save-task").textContent="Asignar Tarea",document.getElementById("type-user").checked=!0,s(),p.show()}),f.addEventListener("submit",async e=>{e.preventDefault();var e=f.querySelector('button[type="submit"]'),t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin font-size-16 align-middle me-2"></i> Guardando...';try{var n,d,i=document.getElementById("task-title").value,s=document.getElementById("task-priority").value,o=document.getElementById("task-desc").value,l=document.getElementById("task-date").value,r=document.getElementById("task-file"),c=document.querySelector('input[name="assign-type"]:checked').value;let e=null,t=("ALL"!==c&&(e=document.getElementById("assign-target").value),null),a=null;0<r.files.length&&(n=r.files[0],await(d=E.ref().child(`assigned_tasks/${Date.now()}_`+n.name)).put(n),t=await d.getDownloadURL(),a=n.name);var u={title:i,priority:s,description:o,assignedToType:c,assignedToId:e,dueDate:l?new Date(l):null};t&&(u.fileUrl=t,u.fileName=a),y?(await m.collection("assigned_tasks").doc(y).update(u),Swal.fire({title:"¡Actualizado!",text:"La tarea se ha actualizado correctamente.",icon:"success",confirmButtonColor:"#556ee6"})):(u.status="PENDING",u.createdAt=new Date,u.createdBy=g.currentUser.uid,await m.collection("assigned_tasks").add(u),Swal.fire({title:"¡Tarea Creada!",text:"La tarea se ha asignado correctamente.",icon:"success",confirmButtonColor:"#556ee6"})),p.hide(),f.reset(),y=null}catch(e){console.error(e),Swal.fire({title:"Error",text:"Hubo un problema: "+e.message,icon:"error",confirmButtonColor:"#f46a6a"})}finally{e.disabled=!1,e.innerHTML=t}}),window.editTask=function(t){let a=o.find(e=>e.id===t);if(a){if(y=t,document.getElementById("taskModalLabel").textContent="Editar Tarea",document.getElementById("btn-save-task").textContent="Guardar Cambios",document.getElementById("task-title").value=a.title,document.getElementById("task-priority").value=a.priority,document.getElementById("task-desc").value=a.description||"",a.dueDate){let e=a.dueDate;e.seconds?e=new Date(1e3*e.seconds):"string"==typeof e&&(e=new Date(e));var n=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");document.getElementById("task-date").value=n+`-${d}-`+i}document.getElementsByName("assign-type").forEach(e=>{e.value===a.assignedToType&&(e.checked=!0)}),s(),setTimeout(()=>{a.assignedToId&&(document.getElementById("assign-target").value=a.assignedToId)},50),p.show()}},[]),l=document.getElementById("filter-user-search"),h=document.getElementById("filter-team"),b=document.getElementById("filter-office"),v=document.getElementById("filter-month"),T=document.getElementById("filter-priority"),L=document.getElementById("filter-status");t=document.getElementById("btn-clear-filters"),e=(new Date).toISOString().slice(0,7);function n(){let t='<option value="ALL">Todos los Equipos</option>',a=(u.forEach(e=>t+=`<option value="${e.id}">${e.name}</option>`),h.innerHTML=t,'<option value="ALL">Todas las Oficinas</option>');c.forEach(e=>a+=`<option value="${e.id}">${e.name}</option>`),b.innerHTML=a}function d(){let e=[...o];l.value.toLowerCase(),h.value,b.value;let a=v.value,t=T.value,n=L.value;a&&(e=e.filter(e=>{let t="";return e.dueDate?t=e.dueDate.seconds?new Date(1e3*e.dueDate.seconds).toISOString():e.dueDate instanceof Date?e.dueDate.toISOString():e.dueDate:e.createdAt&&e.createdAt.seconds&&(t=new Date(1e3*e.createdAt.seconds).toISOString()),!!t&&t.startsWith(a)})),"ALL"!==t&&(e=e.filter(e=>e.priority===t)),"ALL"!==n&&(e=e.filter(e=>e.status===n));{var d=e;i&&(i.clear(),i.destroy());let l=document.querySelector("#datatable-tasks tbody");l.innerHTML="",d.forEach(t=>{let e="badge bg-secondary",a=("HIGH"===t.priority&&(e="badge bg-danger"),"MEDIUM"===t.priority&&(e="badge bg-warning text-dark"),"LOW"===t.priority&&(e="badge bg-success"),"badge bg-secondary"),n=t.status||"PENDING",d=("PENDING"===n&&(a="badge bg-warning text-dark",n="Pendiente"),"COMPLETED"===n&&(a="badge bg-success",n="Completado"),"LATE"===n&&(a="badge bg-danger",n="Atrasado"),"");"ALL"===t.assignedToType?d='<span class="badge bg-dark">Todos</span>':"ROLE"===t.assignedToType?d=`<span class="badge bg-info">Rol: ${t.assignedToId}</span>`:"USER"===t.assignedToType?(o=r.find(e=>e.id===t.assignedToId),d='<i class="mdi mdi-account"></i> '+(o?o.displayName:"Usuario")):"OFFICE"===t.assignedToType?(o=c.find(e=>e.id===t.assignedToId),d='<i class="mdi mdi-building"></i> '+(o?o.name:"Oficina")):"TEAM"===t.assignedToType&&(o=u.find(e=>e.id===t.assignedToId),d='<i class="mdi mdi-account-group"></i> '+(o?o.name:"Equipo"));let i="btn-soft-primary";let s="";t.hasAdminUnread&&(i="btn-soft-danger position-relative",o=t.adminUnreadCount||0,s=0<o?`<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">${o}</span>`:'<span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"></span>');var o=document.createElement("tr");o.innerHTML=`
                <td>
                    <h5 class="text-truncate font-size-14 mb-1">${t.title}</h5>
                    <p class="text-muted mb-0 font-size-12">${t.description||""}</p>
                </td>
                <td><span class="${e}">${"HIGH"===t.priority?"Alta":"MEDIUM"===t.priority?"Media":"Baja"}</span></td>
                <td>${d}</td>
                <td>${t.dueDate?new Date(1e3*t.dueDate.seconds).toLocaleDateString():"string"==typeof t.dueDate?t.dueDate:"-"}</td>
                <td><span class="${a}">${n}</span></td>
                <td>${t.createdAt?new Date(1e3*t.createdAt.seconds).toLocaleDateString():"-"}</td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm ${i}" onclick="openAdminChat('${t.id}')" title="Bitácora">
                           <i class="bx bx-chat font-size-16"></i>
                           ${s}
                        </button>
                        <button class="btn btn-sm btn-soft-info" onclick="editTask('${t.id}')" title="Editar">
                           <i class="mdi mdi-pencil font-size-16"></i>
                        </button>
                        <button class="btn btn-sm btn-soft-danger" onclick="deleteTask('${t.id}')" title="Eliminar">
                           <i class="mdi mdi-trash-can font-size-16"></i>
                        </button>
                    </div>
                </td>
            `,l.appendChild(o)}),i=$("#datatable-tasks").DataTable({language:{emptyTable:"No hay tareas encontradas con estos filtros",search:"Buscar:",paginate:{first:"Primero",last:"Último",next:"Sig",previous:"Ant"},info:"Mostrando _START_ a _END_ de _TOTAL_",lengthMenu:"Mostrar _MENU_"}})}}v.value=e,[h,b,v,T,L].forEach(e=>e.addEventListener("change",d)),l.addEventListener("input",d),t.addEventListener("click",()=>{l.value="",h.value="ALL",b.value="ALL",v.value="",T.value="ALL",L.value="ALL",d()});let I=null,w=null,D=new bootstrap.Modal(document.getElementById("admin-chat-modal")),B=document.getElementById("admin-chat-history"),k=document.getElementById("admin-chat-input");e=document.getElementById("btn-admin-send");let A=document.getElementById("noti-badge"),x=document.getElementById("noti-list");window.openAdminChat=function(e){w=e,m.collection("assigned_tasks").doc(e).update({hasAdminUnread:!1,adminUnreadCount:0}),I&&I(),B.innerHTML='<li class="text-center text-muted mt-5">Cargando bitácora...</li>',I=m.collection("assigned_tasks").doc(e).collection("messages").orderBy("createdAt","asc").onSnapshot(e=>{B.innerHTML="",e.empty?B.innerHTML='<li class="text-center text-muted mt-5">No hay mensajes. Escribe uno para iniciar.</li>':(e.forEach(e=>{var e=e.data(),t=e.senderId===g.currentUser.uid,a=document.createElement("li"),n=e.createdAt?new Date(1e3*e.createdAt.seconds).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";a.innerHTML=`
                         <div class="d-flex ${t?"justify-content-end":""} mb-3">
                             <div class="${t?"bg-primary text-white":"bg-light"} p-2 rounded" style="max-width: 80%;">
                                 <small class="d-block ${t?"text-white-50":"text-muted"} font-size-10">${e.senderName} - ${n}</small>
                                 <span>${e.text}</span>
                             </div>
                         </div>
                     `,B.appendChild(a)}),B.scrollTop=B.scrollHeight)}),D.show()},e.addEventListener("click",()=>{var e=k.value.trim();e&&w&&m.collection("assigned_tasks").doc(w).collection("messages").add({text:e,senderId:g.currentUser.uid,senderName:"Equipo Imalá",createdAt:new Date}).then(()=>{k.value="",m.collection("assigned_tasks").doc(w).update({hasUserUnread:!0,userUnreadCount:firebase.firestore.FieldValue.increment(1)})})}),window.deleteTask=function(t){Swal.fire({title:"¿Estás seguro?",text:"Esta acción no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#f46a6a",cancelButtonColor:"#74788d",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&m.collection("assigned_tasks").doc(t).delete().then(()=>{Swal.fire("Eliminado","La tarea ha sido eliminada.","success")}).catch(e=>{Swal.fire("Error","No se pudo eliminar: "+e.message,"error")})})}});