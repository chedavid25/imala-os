document.addEventListener("DOMContentLoaded",function(){let E,b,f=[],T=["General","Ventas","Marketing"],I="TODAY",D="",h="";let w=[],L=[],B=null,M=window.Imala.db;var S=window.Imala.auth,k=document.getElementById("event-modal");if(k){let n=new bootstrap.Modal(k);k=document.getElementById("categories-modal");let e=k?new bootstrap.Modal(k):null,a=document.getElementById("form-event"),i=document.getElementById("kanban-todo"),d=document.getElementById("kanban-late"),s=document.getElementById("kanban-completed"),t=document.querySelectorAll(".filter-bar button");var C,k=document.getElementById("top-search-input");let o=document.getElementById("filter-month-history");window.innerWidth<768&&(O=document.querySelector('a[href="#tab-kanban"]'),A=document.querySelector('a[href="#tab-list"]'),x=document.getElementById("tab-kanban"),C=document.getElementById("tab-list"),O)&&A&&x&&C&&(O.classList.remove("active"),A.classList.add("active"),x.classList.remove("active"),C.classList.add("active")),S.onAuthStateChanged(e=>{e?(N(),N(),M.collection("users").get().then(e=>{w=[],e.forEach(e=>{var t=e.data();w.push({uid:e.id,name:t.displayName||"Usuario",email:t.email})});{let a=document.getElementById("event-assignedTo");a&&(a.innerHTML=`
            <option value="David">David (Default)</option>
            <option value="Ambos">Ambos</option>
        `,w.forEach(e=>{var t;"David"!==e.name&&((t=document.createElement("option")).value=e.name,t.textContent=e.name,a.appendChild(t))}))}}).catch(e=>console.log("Error loading members",e)),M.collection("clients").where("type","==","CLIENT").get().then(e=>{L=[],e.forEach(e=>{L.push({id:e.id,...e.data()})}),H()}),e.uid,M.collection("tasks").onSnapshot(t=>{f=[],t.forEach(e=>{"settings_categories"!==e.id&&f.push({id:e.id,...e.data()})});{let e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),i=t+`-${a}-`+n,d=e.toTimeString().split(" ")[0].substring(0,5);f.forEach(e=>{"COMPLETED"!==e.status&&"LATE"!==e.status&&e.dueDate&&(e.dueDate<i||e.dueDate===i&&e.dueTime&&e.dueTime<d)&&U(e.id,"LATE")})}j();var t=document.getElementById("stat-gen-week"),r=document.getElementById("stat-gen-month"),c=document.getElementById("stat-gen-trend");if(t&&r&&c){var u=new Date,m=u.getFullYear(),g=u.getMonth(),v=u.getDay();let a=new Date(u);u=u.getDate()-v+(0===v?-6:1);a.setDate(u),a.setHours(0,0,0,0);let n=new Date(m,g,1),i=new Date(m,g-1,1),d=new Date(m,g,0,23,59,59),s=0,o=0,l=0,e=(f.forEach(t=>{if(t.createdAt){let e;(e=t.createdAt.seconds?new Date(1e3*t.createdAt.seconds):new Date(t.createdAt))>=a&&s++,e>=n&&o++,e>=i&&e<=d&&l++}}),t.textContent=s,r.textContent=o,0);0<l?e=(o-l)/l*100:0<o&&(e=100);v=Math.round(e);0<e?c.innerHTML=`<span class="text-success"><i class="mdi mdi-arrow-up"></i> ${v}%</span>`:e<0?c.innerHTML=`<span class="text-danger"><i class="mdi mdi-arrow-down"></i> ${v}%</span>`:c.innerHTML='<span class="text-muted"><i class="mdi mdi-minus"></i> 0%</span>'}_()},e=>{console.error("Error loading tasks:",e),"permission-denied"===e.code&&alert("Error de Permisos: No tienes acceso a la colección de tareas. Verifica las Reglas de Firestore.")})):(console.log("No User - Redirecting"),window.location.href="auth-login.html")}),k&&k.addEventListener("input",e=>{D=e.target.value.toLowerCase(),_()}),o&&o.addEventListener("change",e=>{(h=e.target.value)?(t.forEach(e=>e.classList.remove("active")),I="HISTORY"):(I="ALL",document.querySelector('[data-filter="ALL"]').classList.add("active")),_()}),t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(e=>e.classList.remove("active")),e.classList.add("active"),I=e.dataset.filter,o&&(o.value=""),h="",_()})}),a.addEventListener("submit",e=>{e.preventDefault();var t,e=document.getElementById("task-id").value;let a={title:document.getElementById("event-title").value,description:document.getElementById("event-description").value,category:document.getElementById("event-category").value,priority:document.getElementById("event-priority").value,status:document.getElementById("event-status").value,assignedTo:document.getElementById("event-assignedTo").value,recurrence:document.getElementById("event-recurrence").value,dueDate:document.getElementById("event-dueDate").value,dueTime:document.getElementById("event-dueTime").value,dueTime:document.getElementById("event-dueTime").value,clientId:document.getElementById("event-client-id").value||null,updatedAt:new Date};a.clientId&&(t=L.find(e=>e.id===a.clientId))&&(a.clientName=t.name),e?(M.collection("tasks").doc(e).update(a).then(()=>n.hide()),"COMPLETED"===a.status&&Y(e)):(a.createdAt=new Date,M.collection("tasks").add(a).then(()=>n.hide()))}),document.getElementById("btn-delete-event").addEventListener("click",()=>{confirm("¿Eliminar?")&&M.collection("tasks").doc(document.getElementById("task-id").value).delete().then(()=>n.hide())}),document.getElementById("btn-edit-cats-modal")&&document.getElementById("btn-edit-cats-modal").addEventListener("click",()=>e?e.show():null),document.getElementById("btn-manage-categories")&&document.getElementById("btn-manage-categories").addEventListener("click",()=>e?e.show():null),document.getElementById("btn-add-cat")&&document.getElementById("btn-add-cat").addEventListener("click",()=>{var e=document.getElementById("new-cat-name").value;e&&(e=[...T,e],M.collection("tasks").doc("settings_categories").set({list:e}).then(()=>{document.getElementById("new-cat-name").value=""}))});var O=document.getElementById("btn-new-task-main"),A=(O&&O.addEventListener("click",()=>z()),document.getElementById("btn-new-task-kanban")),x=(A&&A.addEventListener("click",()=>z()),document.getElementById("btn-new-task-calendar")&&document.getElementById("btn-new-task-calendar").addEventListener("click",()=>z()),window.ImalaConfig?window.ImalaConfig.googleCalendar:{});let l=x.clientId||"MISSING_CLIENT_ID",r=x.apiKey||"MISSING_API_KEY",c=x.discoveryDocs?x.discoveryDocs[0]:"https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",u=x.scopes||"https://www.googleapis.com/auth/calendar",m,g=!1,v=!1,y=!1,p=document.getElementById("btn-sync-gcal");function N(){let t=M.collection("tasks").doc("settings_categories");t.onSnapshot(e=>{e.exists&&e.data().list?T=e.data().list:t.set({list:T}),F();{let a=document.getElementById("categories-list");a&&(a.innerHTML="",T.forEach(t=>{var e=document.createElement("li");e.className="list-group-item d-flex justify-content-between align-items-center",e.innerHTML=`
                ${t} 
                <button class="btn btn-sm btn-soft-danger"><i class="mdi mdi-trash-can"></i></button>
            `,e.querySelector("button").addEventListener("click",()=>{var e=T.filter(e=>e!==t);M.collection("tasks").doc("settings_categories").set({list:e})}),a.appendChild(e)}))}})}function H(){let a=document.getElementById("event-client-id");var e;a&&(e=a.value,a.innerHTML='<option value="">- Ninguno -</option>',L.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,a.appendChild(t)}),a.value=e)}function _(){var e=(()=>{let a=new Date;return a.setHours(0,0,0,0),f.filter(e=>{var t;if(D&&!(e.title&&e.title.toLowerCase().includes(D)||e.description&&e.description.toLowerCase().includes(D)))return!1;return h&&"HISTORY"===I?!!e.dueDate&&e.dueDate.startsWith(h):"ALL"===I||("LATE"===I?"LATE"===e.status:"COMPLETED"===I?"COMPLETED"===e.status:!!e.dueDate&&(e=new Date(e.dueDate+"T00:00:00"),"TODAY"===I?e.getTime()===a.getTime():"WEEK"===I?((t=new Date(a)).setDate(a.getDate()+7),e>=a&&e<=t):"MONTH"!==I||e.getMonth()===a.getMonth()&&e.getFullYear()===a.getFullYear()))})})(),t=(t=e,i&&(B&&B.destroy(),i.innerHTML="",d.innerHTML="",s.innerHTML="",t.forEach(e=>{var t=(t=>{var e=document.createElement("div");e.className="card task-card mb-3 priority-"+(t.priority||"MEDIUM"),e.setAttribute("data-id",t.id),e.setAttribute("data-priority",t.priority||"MEDIUM");let a="",n=("google"===t.source&&(e.className+=" bg-light border-secondary text-muted",a='<i class="mdi mdi-google text-danger me-1"></i>',e.style.borderStyle="dashed"),e.style.touchAction="none","");"Ambos"===t.assignedTo&&(n='<div class="avatar-group-item"><span class="avatar-title rounded-circle bg-info text-white font-size-10">A</span></div>');var i,d,s=w.find(e=>e.name===t.assignedTo);s&&(i=s.name.charAt(0),d=(d=["bg-primary","bg-success","bg-warning","bg-info","bg-danger"])[s.name.length%d.length],n=`<div class="avatar-group-item" title="${s.name}">
                                <span class="avatar-title rounded-circle ${d} text-white font-size-10">${i}</span>
                               </div>`);let o="",l=(t.dueTime&&(o=`<span class="ms-2"><i class="mdi mdi-clock-outline"></i> ${t.dueTime}</span>`),"");return t.clientName&&(l=`<small class="d-block text-primary mt-1 mb-1"><i class="mdi mdi-account-circle me-1"></i>${t.clientName}</small>`),e.innerHTML=`
            <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge ${"Ventas"===t.category?"bg-success":"bg-secondary"} font-size-10">${t.category||"General"}</span>
                    <small class="text-muted fw-bold">${R(t.priority)}</small>
                </div>
                <h5 class="font-size-15 mb-1 text-truncate">${a}${t.title}</h5>
                <p class="text-muted mb-1 font-size-12 text-truncate">${t.description||""}</p>
                ${l}
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <p class="text-muted mb-0 font-size-12"><i class="mdi mdi-calendar"></i> ${q(t.dueDate)} ${o}</p>
                    <div class="avatar-group">${n}</div>
                </div>
            </div>
        `,e.addEventListener("click",e=>{z(t.id)}),e})(e);("TODO"===e.status?i:"LATE"===e.status?d:"COMPLETED"===e.status?s:i).appendChild(t)}),(B=dragula([i,d,s],{moves:function(e,t,a){return!0},accepts:function(e,t,a,n){return!0}})).on("drop",function(e,t,a,n){t&&(U(e=e.getAttribute("data-id"),t=t.getAttribute("data-status")),"COMPLETED"===t)&&Y(e)})),e);if(b&&b.destroy(),document.getElementById("datatable-tasks")){let d=document.querySelector("#datatable-tasks tbody");d.innerHTML="",t.forEach(e=>{var t,a=document.createElement("tr");"google"===e.source&&a.classList.add("table-light","text-muted");let n="",i=(n="google"===e.source?'<span class="badge badge-soft-secondary"><i class="mdi mdi-google"></i> GCal</span>':"COMPLETED"!==e.status?`<button class="btn btn-sm btn-success complete-btn me-1" data-id="${e.id}">Listo!</button>`:'<span class="badge badge-soft-success me-2"><i class="mdi mdi-check"></i></span>',"");e.clientName&&(i=`<span class="badge badge-soft-info ms-2"><i class="mdi mdi-account me-1"></i>${e.clientName}</span>`),a.innerHTML=`
                <td data-label="Tarea">
                    <div class="fw-bold">${"google"===e.source?'<i class="mdi mdi-google text-danger me-1"></i> ':""}${e.title} ${i}</div>
                    <small class="text-muted">${e.description?e.description.substring(0,30)+"...":""}</small>
                </td>
                <td data-label="Vencimiento">
                    ${q(e.dueDate)} ${e.dueTime||""}
                </td>
                <td data-label="Prioridad"><span class="badge ${t=e.priority,"HIGH"===t?"badge-soft-danger":"MEDIUM"===t?"badge-soft-warning":"LOW"===t?"badge-soft-success":"badge-soft-primary"}">${R(e.priority)}</span></td>
                <td data-label="Estado"><span class="badge ${t=e.status,"TODO"===t?"badge-soft-warning":"COMPLETED"===t?"badge-soft-success":"LATE"===t?"badge-soft-danger":"badge-soft-secondary"}">${t=e.status,"TODO"===t?"Pendiente":"COMPLETED"===t?"Completado":"LATE"===t?"Atrasado":t}</span></td>
                <td data-label="Asignado a" class="fw-bold text-primary">${e.assignedTo||"David"}</td>
                <td data-label="Acciones">
                    <div class="d-flex gap-2">
                        ${n}
                        ${"google"!==e.source?`<button class="btn btn-sm btn-soft-primary edit-btn" data-id="${e.id}"><i class="mdi mdi-pencil"></i></button>`:""}
                        ${"google"!==e.source?`<button class="btn btn-sm btn-soft-danger delete-btn" data-id="${e.id}"><i class="mdi mdi-trash-can"></i></button>`:""}
                    </div>
                </td>
            `,d.appendChild(a)}),b=$("#datatable-tasks").DataTable({language:{decimal:"",emptyTable:"No hay información",info:"Mostrando _START_ a _END_ de _TOTAL_ Entradas",infoEmpty:"Mostrando 0 a 0 de 0 Entradas",infoFiltered:"(Filtrado de _MAX_ total entradas)",infoPostFix:"",thousands:",",lengthMenu:"Mostrar _MENU_ Entradas",loadingRecords:"Cargando...",processing:"Procesando...",search:"Buscar:",zeroRecords:"Sin resultados encontrados",paginate:{first:"Primero",last:"Ultimo",next:"Siguiente",previous:"Anterior"}},order:[[1,"asc"]]}),d.onclick=function(e){var t,a,e=e.target.closest("button");e&&(t=e.dataset.id,e.classList.contains("edit-btn")&&z(t),e.classList.contains("delete-btn")&&(a=t,confirm("¿Seguro?"))&&M.collection("tasks").doc(a).delete(),e.classList.contains("complete-btn"))&&(U(t,"COMPLETED"),Y(t))}}t=e,(e=document.getElementById("calendar"))&&(E?(E.removeAllEvents(),E.addEventSource(P(t))):((E=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"es",events:P(t),headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},dayMaxEvents:!0,eventDisplay:"block",eventContent:function(e){var t=e.timeText,a=e.event.title;let n="#fff",i=`<div style="padding: 2px; color: ${n="#f1b44c"===e.event.backgroundColor?"#000":n}; overflow: hidden;">`;return t&&(i+=`<div style="font-weight:bold; font-size:11px;">${t}</div>`),{html:i+=`<div style="font-size:12px; line-height:1.2;">${a}</div></div>`}},editable:!0,droppable:!0,eventClick:e=>z(e.event.id),eventDrop:e=>{var t=e.event.id,e=e.event.start;e=e.toISOString().split("T")[0],M.collection("tasks").doc(t).update({dueDate:e})}})).render(),$('a[data-bs-toggle="tab"]').on("shown.bs.tab",function(e){"#tab-calendar"===e.target.hash&&E.updateSize()})))}function P(e){return e.map(e=>{let t="#f1b44c";var a=[];return"google"===e.source?t="#74788d":"LATE"===e.status?t="#f46a6a":"COMPLETED"===e.status?(t="#34c38f",a.push("text-decoration-line-through")):t="#f1b44c",{id:e.id,title:e.title,start:e.dueDate+(e.dueTime?"T"+e.dueTime:""),backgroundColor:t,borderColor:t,classNames:a}})}function G(){var e=new Date;return e.getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}function Y(t){var e,a,n=f.find(e=>e.id===t);n&&n.recurrence&&"NONE"!==n.recurrence&&(e=new Date(n.dueDate||new Date),"WEEKLY"===n.recurrence&&e.setDate(e.getDate()+7),"MONTHLY"===n.recurrence&&e.setMonth(e.getMonth()+1),"YEARLY"===n.recurrence&&e.setFullYear(e.getFullYear()+1),delete(a={...n}).id,delete a.createdAt,a.status="TODO",a.dueDate=e.toISOString().split("T")[0],a.title=n.title,M.collection("tasks").add(a))}function z(t=null){var e;F(),H(),t?(e=f.find(e=>e.id===t),document.getElementById("task-id").value=t,document.getElementById("event-title").value=e.title,document.getElementById("event-description").value=e.description||"",document.getElementById("event-category").value=e.category||"General",document.getElementById("event-status").value=e.status||"TODO",document.getElementById("event-priority").value=e.priority||"MEDIUM",document.getElementById("event-assignedTo").value=e.assignedTo||"David",document.getElementById("event-assignedTo").value=e.assignedTo||"David",document.getElementById("event-recurrence").value=e.recurrence||"NONE",document.getElementById("event-client-id").value=e.clientId||"",document.getElementById("event-dueDate").value=e.dueDate||G(),document.getElementById("event-dueTime").value=e.dueTime||"",document.getElementById("btn-delete-event").style.display="block",document.getElementById("modal-title").textContent="Editar Tarea"):(a.reset(),document.getElementById("task-id").value="",document.getElementById("event-dueDate").value=G(),document.getElementById("event-status").value="TODO",document.getElementById("event-priority").value="MEDIUM",document.getElementById("event-assignedTo").value="David",document.getElementById("event-client-id").value="",document.getElementById("btn-delete-event").style.display="none",document.getElementById("modal-title").textContent="Nueva Tarea"),n.show()}function F(){let a=document.getElementById("event-category");var e;a&&(e=a.value,a.innerHTML="",T.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)}),a.value=e||"General")}function U(e,t){M.collection("tasks").doc(e).update({status:t})}function G(){var e=new Date;return e.getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}function q(e){var t,a;return e?([e,t,a]=e.split("-"),a+`/${t}/`+e):""}function R(e){return"HIGH"===e?"Alta":"MEDIUM"===e?"Media":"LOW"===e?"Baja":e}function W(){"undefined"==typeof gapi||"undefined"==typeof google||g||(gapi.load("client",async()=>{await gapi.client.init({apiKey:r,discoveryDocs:[c]}),g=!0;var e,t=localStorage.getItem("gcal_token");t&&(t=JSON.parse(t),e=Date.now(),t.expires_at&&e<t.expires_at-3e5?(gapi.client.setToken(t),K(!0)):K(!1))}),m=google.accounts.oauth2.initTokenClient({client_id:l,scope:u,callback:V}),v=!0)}async function V(e){if(e.error){if(y)return console.log("Silent refresh failed",e),void(y=!1);throw e}var t=Date.now(),t={...e,expires_at:t+1e3*e.expires_in};if(localStorage.setItem("gcal_token",JSON.stringify(t)),K(!0),!y){Swal.fire({title:"Sincronizando...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});try{if(f&&0!==f.length){var d,s=new Date,o=(s.setDate(s.getDate()-30),await gapi.client.calendar.events.list({calendarId:"primary",timeMin:s.toISOString(),showDeleted:!1,singleEvents:!0,orderBy:"startTime"})),l=o.result.items;let e=0;for(let t of l){var r,c=f.find(e=>e.googleId===t.id);c?"google"===c.source&&M.collection("tasks").doc(c.id).update({title:t.summary,dueDate:t.start.dateTime?t.start.dateTime.split("T")[0]:t.start.date||"",dueTime:t.start.dateTime?t.start.dateTime.split("T")[1].substring(0,5):"",description:t.description||""}):(r={title:t.summary,description:t.description||"",status:"TODO",priority:"MEDIUM",source:"google",category:"General",assignedTo:"Google Calendar",googleId:t.id,createdAt:new Date,dueDate:t.start.dateTime?t.start.dateTime.split("T")[0]:t.start.date||"",dueTime:t.start.dateTime?t.start.dateTime.split("T")[1].substring(0,5):""},await M.collection("tasks").add(r),e++)}let a=0,n=0,i="";for(d of f)if("google"!==d.source&&d.dueDate){Swal.update({title:"Sincronizando...",text:"Procesando: "+d.title});var u,m,g,v=`${d.title} (${d.assignedTo||"Unassigned"})`;let e={},t={};t=d.dueTime?(u=new Date(d.dueDate+"T"+d.dueTime),m=new Date(u.getTime()+36e5),e={dateTime:u.toISOString()},{dateTime:m.toISOString()}):(e={date:d.dueDate},(g=new Date(d.dueDate)).setDate(g.getDate()+1),{date:g.toISOString().split("T")[0]});var p,E={summary:v,description:d.description||"",start:e,end:t};try{d.googleId?(await gapi.client.calendar.events.update({calendarId:"primary",eventId:d.googleId,resource:E}),a++):(p=await gapi.client.calendar.events.insert({calendarId:"primary",resource:E})).result.id&&(await M.collection("tasks").doc(d.id).update({googleId:p.result.id}),a++)}catch(e){console.error("GCal Sync Error for task:",d.title,e),404===e.status||404===e.code?await M.collection("tasks").doc(d.id).update({googleId:firebase.firestore.FieldValue.delete()}):(n++,i=e.result?e.result.error.message:e.message||JSON.stringify(e))}}let t=`Importadas: ${e}, Exportadas: `+a;0<n&&(t+=`. Errores: ${n} (${i})`),Swal.fire("Sincronización Completada",t,0<n?"warning":"success")}else Swal.fire("Atención","No hay tareas cargadas para sincronizar aún. Espera unos segundos y prueba de nuevo.","warning")}catch(e){console.error("Sync Error",e),Swal.fire("Error Crítico","Hubo un problema: "+(e.message||JSON.stringify(e)),"error")}await 0,Swal.fire("¡Sincronizado!","Tus tareas y calendario están al día.","success")}y=!1}function K(e){p&&(e?(p.classList.remove("btn-soft-danger"),p.classList.add("btn-soft-success"),p.innerHTML='<i class="mdi mdi-check"></i> Conectado'):(p.classList.remove("btn-soft-success"),p.classList.add("btn-soft-danger"),p.innerHTML='<i class="mdi mdi-google"></i> Sync'))}function j(){let a=new Date,n=!1;f.forEach(e=>{var t;"google"===e.source&&"COMPLETED"!==e.status&&e.dueDate&&(t=e.dueDate+(e.dueTime?"T"+e.dueTime:"T23:59:59"),new Date(t)<a)&&(U(e.id,"COMPLETED"),n=!0)}),n&&Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0}).fire({icon:"info",title:"Tareas de Google actualizadas automáticamente"})}p&&p.addEventListener("click",function(){console.log("Sync button clicked"),y=!1,g&&v?(console.log("Requesting access token..."),null===gapi.client.getToken()?m.requestAccessToken({prompt:"consent"}):m.requestAccessToken({prompt:""})):(console.log("GAPI/GIS not inited yet, attempting init..."),W())}),setTimeout(W,2e3),setInterval(j,3e5)}});