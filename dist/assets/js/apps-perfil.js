document.addEventListener("DOMContentLoaded",()=>{var e=firebase.auth();let o=firebase.firestore(),l=firebase.storage();var t=document.getElementById("form-perfil");let a=document.getElementById("avatar-upload"),n=document.getElementById("avatar-preview"),i=document.getElementById("profile-avatar-display"),d=document.getElementById("profile-name"),s=document.getElementById("profile-email"),m=document.getElementById("profile-phone"),u=document.getElementById("profile-office"),c=document.getElementById("profile-full-name"),f=document.getElementById("profile-email-display"),p=document.getElementById("btn-save-profile"),g=null,v=null;e.onAuthStateChanged(e=>{e?(async e=>{s.value=e.email||"",f.textContent=e.email||"-",d.value=e.displayName||"",c.textContent=e.displayName||"Usuario",e.photoURL&&(n.src=e.photoURL,i.src=e.photoURL);try{var t,a,r=await o.collection("users").doc(e.uid).get();r.exists&&(t=r.data(),m.value=t.telefono||"",u.value=t.rol||"Agente",a=document.getElementById("profile-role"))&&(a.textContent=t.rol||"Agente Inmobiliario")}catch(e){console.error("Error loading profile from Firestore:",e)}})(g=e):window.location.href="auth-login.html"}),a&&a.addEventListener("change",e=>{var t,e=e.target.files[0];e&&(2097152<e.size?(Swal.fire("Error","La imagen es demasiado grande. Máximo 2MB.","error"),a.value=""):(v=e,(t=new FileReader).onload=function(e){n&&(n.src=e.target.result)},t.readAsDataURL(e)))}),t&&t.addEventListener("submit",async e=>{if(e.preventDefault(),g){p.disabled=!0,p.innerHTML='<i class="bx bx-loader bx-spin font-size-16 align-middle me-2"></i> Guardando...';try{let e=g.photoURL;v&&(t=await l.ref("avatars/"+g.uid).put(v),e=await t.ref.getDownloadURL()),await g.updateProfile({displayName:d.value,photoURL:e}),await o.collection("users").doc(g.uid).set({nombre:d.value,telefono:m.value,avatarUrl:e,lastUpdate:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),c.textContent=d.value,i&&(i.src=e);var t,a=document.getElementById("header-user-avatar"),r=document.getElementById("header-user-name");a&&(a.src=e),r&&(r.textContent=d.value),Swal.fire({icon:"success",title:"¡Perfil Actualizado!",text:"Tus cambios han sido guardados correctamente.",timer:2e3,showConfirmButton:!1})}catch(e){console.error("Error updating profile:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo actualizar el perfil: "+e.message})}finally{p.disabled=!1,p.innerHTML='<i class="bx bx-save me-1"></i> Guardar Cambios'}}})});