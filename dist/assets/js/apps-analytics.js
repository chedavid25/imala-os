let chartInstances={},invoicesData=[],tasksData=[],clientsData=[],now=new Date,filterYear=now.getFullYear(),filterPeriod="MONTH",filterMonth=now.getMonth(),filterQuarter=Math.floor(now.getMonth()/3)+1,filterSemester=now.getMonth()<6?1:2,filterCurrency="ARS";function populateYearSelect(){var t=document.getElementById("analytics-year");if(t){t.innerHTML="";for(let e=filterYear+1;2024<=e;e--){var a=document.createElement("option");a.value=e,(a.textContent=e)===filterYear&&(a.selected=!0),t.appendChild(a)}}}function loadData(){db.collection("transactions").onSnapshot(e=>{invoicesData=[],e.forEach(e=>{var t=e.data();let a=null;t.date&&t.date.seconds?a=new Date(1e3*t.date.seconds):t.date&&(a=new Date(t.date)),a&&!isNaN(a.getTime())&&invoicesData.push({id:e.id,...t,dateObj:a})}),updateDashboard()}),db.collection("tasks").onSnapshot(e=>{tasksData=[],e.forEach(e=>{var t=e.data();let a=null;t.createdAt&&t.createdAt.seconds?a=new Date(1e3*t.createdAt.seconds):t.createdAt&&(a=new Date(t.createdAt)),tasksData.push({id:e.id,...t,dateObj:a})}),updateDashboard()}),db.collection("clients").onSnapshot(e=>{clientsData=[],e.forEach(e=>{clientsData.push({id:e.id,...e.data()})}),updateDashboard()})}document.addEventListener("DOMContentLoaded",function(){populateYearSelect(),document.getElementById("analytics-month").value=filterMonth,document.getElementById("analytics-quarter").value=filterQuarter,document.getElementById("analytics-semester").value=filterSemester,updatePeriodButtons(),updateSelectorsVisibility(),window.Imala.auth.checkAuth(e=>{console.log("Analytics Auth:",e),loadData()})});let appAnalytics={setPeriod:e=>{filterPeriod=e,updatePeriodButtons(),updateSelectorsVisibility(),updateDashboard()},setCurrency:t=>{filterCurrency=t,document.querySelectorAll(".currency-label").forEach(e=>e.innerText=t),updateDashboard()},switchTab:e=>{currentTab=e,setTimeout(()=>{Object.values(chartInstances).forEach(e=>{e&&"function"==typeof e.resize&&e.resize()}),updateDashboard()},200)},showChartHelp:e=>{e={WEALTH_EVOLUTION:{title:"Ayuda: Evolución del Patrimonio",content:`
                    <p>Este gráfico muestra la trayectoria de tu capital durante todo el año:</p>
                    <ul class="text-muted">
                        <li><strong>Caja Disponible (Línea Azul):</strong> Es tu liquidez real. Dinero libre para gastar después de operar y ahorrar.</li>
                        <li><strong>Reservas Totales (Línea Verde):</strong> Es el acumulado de todos tus ahorros y fondos de reserva activos.</li>
                    </ul>
                    <p class="mb-0"><strong>Tip:</strong> Busca que la línea verde siempre suba, indicando que tu patrimonio crece mes a mes.</p>
                `},SAVINGS_DISTRIBUTION:{title:"Ayuda: Distribución por Metas",content:`
                    <p>Muestra cómo tienes repartido tu capital de reserva actual:</p>
                    <p class="text-muted">Toma el total de tus ahorros y los divide por las categorías que has definido (ej. Inversiones, Fondo de Emergencia, Viajes).</p>
                    <p class="mb-0"><strong>Tip:</strong> Te ayuda a detectar si estás demasiado concentrado en una sola meta.</p>
                `},MONTHLY_SAVINGS:{title:"Ayuda: Ahorro Mensual",content:`
                    <p>Mide tu ritmo de ahorro o "capitalización" mensual:</p>
                    <p class="text-muted">Cada barra representa el monto neto que lograste mover del saldo disponible hacia tus ahorros en ese mes específico.</p>
                    <p class="mb-0"><strong>Tip:</strong> Compara los picos y valles para entender qué meses son más propicios para tu ahorro.</p>
                `},SURVIVAL_RATE:{title:"Ayuda: Supervivencia Estimada",content:`
                    <p>Indica cuántos meses podrías mantener tu estilo de vida actual sin percibir ingresos:</p>
                    <ul class="text-muted">
                        <li><strong>Cálculo:</strong> Divide tus Reservas Totales por tu promedio de gastos de la <strong>moneda seleccionada</strong> de los últimos 6 meses.</li>
                        <li><strong>Significado:</strong> Si el valor es 6.0, significa que tienes ahorros para cubrir 6 meses de gastos en esa moneda.</li>
                        <li><strong>Nota:</strong> Si no tienes gastos registrados en esta moneda, el sistema asumirá una supervivencia prolongada (+99).</li>
                    </ul>
                    <p class="mb-0"><strong>Tip:</strong> Los expertos recomiendan tener entre 3 y 6 meses de "pista financiera" como fondo de emergencia.</p>
                `},SAVINGS_PROGRESS:{title:"Ayuda: Progreso de Metas",content:`
                    <p>Muestra qué tan cerca estás de alcanzar tus objetivos financieros definidos:</p>
                    <ul class="text-muted">
                        <li><strong>Rojo:</strong> Menos del 30% completado.</li>
                        <li><strong>Amarillo:</strong> Entre el 30% y 70%.</li>
                        <li><strong>Verde:</strong> Más del 70% del camino recorrido.</li>
                    </ul>
                    <p class="mb-0"><strong>Tip:</strong> Define un "Monto Objetivo" al crear un ahorro para que aparezca en este panel.</p>
                `}}[e];e&&(document.getElementById("help-title").innerText=e.title,document.getElementById("help-content").innerHTML=e.content,new bootstrap.Modal(document.getElementById("modal-chart-help")).show())},applyFilters:()=>{filterYear=parseInt(document.getElementById("analytics-year").value),filterMonth=parseInt(document.getElementById("analytics-month").value),filterQuarter=parseInt(document.getElementById("analytics-quarter").value),filterSemester=parseInt(document.getElementById("analytics-semester").value),updateDashboard()}},currentTab="BILLING";function updatePeriodButtons(){document.querySelectorAll(".btn-group button").forEach(e=>e.classList.remove("active"));var e="btn-period-"+filterPeriod.toLowerCase(),e=document.getElementById(e);e&&e.classList.add("active")}function updateSelectorsVisibility(){document.getElementById("analytics-month").classList.add("d-none"),document.getElementById("analytics-quarter").classList.add("d-none"),document.getElementById("analytics-semester").classList.add("d-none"),"MONTH"===filterPeriod&&document.getElementById("analytics-month").classList.remove("d-none"),"QUARTER"===filterPeriod&&document.getElementById("analytics-quarter").classList.remove("d-none"),"SEMESTER"===filterPeriod&&document.getElementById("analytics-semester").classList.remove("d-none")}function updateDashboard(){var e=invoicesData.filter(e=>(e.currency||"ARS")===filterCurrency),t=e.filter(e=>{var t,a;return!!e.dateObj&&e.dateObj.getFullYear()===filterYear&&(e=e.dateObj.getMonth(),t=Math.floor(e/3)+1,a=e<6?1:2,"MONTH"===filterPeriod?e===filterMonth:"QUARTER"===filterPeriod?t===filterQuarter:"SEMESTER"!==filterPeriod||a===filterSemester)});calculateKPIs(t,e),"BILLING"===currentTab?renderBillingCharts(t):"SAVINGS"===currentTab?renderSavingsDashboard(t,e):"CRM"===currentTab&&updateCRMDashboard()}function calculateKPIs(e,a){let r=0,n=0,o=0,s=0,l=(e.forEach(e=>{var t=parseFloat(e.amount)||0;"INCOME"===e.type?(r+=t,"PAID"!==e.status&&(o+=t)):"EXPENSE"===e.type?n+=t:"SAVING"===e.type&&"USED"!==e.status&&(s+=t)}),new Date(filterYear,"MONTH"===filterPeriod?filterMonth+1:12,0,23,59,59));var e=a.filter(e=>e.dateObj<=l),i=(e,a,r=null,n=!1)=>e.reduce((e,t)=>t.type!==a||r&&t.status!==r||n&&t.isInitial?e:e+(parseFloat(t.amount)||0),0),t=i(e,"INCOME","PAID"),d=i(e,"EXPENSE","PAID"),c=i(e,"SAVING","ACTIVE"),t=t-d-i(e,"SAVING","ACTIVE",!0)+c;if(document.getElementById("kpi-billed")&&(document.getElementById("kpi-billed").innerText=formatCurrency(r)),document.getElementById("kpi-expenses")&&(document.getElementById("kpi-expenses").innerText=formatCurrency(n)),document.getElementById("kpi-profit")&&(document.getElementById("kpi-profit").innerText=formatCurrency(r-n)),document.getElementById("kpi-total-wealth")&&(document.getElementById("kpi-total-wealth").innerText=formatCurrency(t)),document.getElementById("kpi-savings-total")&&(document.getElementById("kpi-savings-total").innerText=formatCurrency(c)),document.getElementById("kpi-savings-period")&&(document.getElementById("kpi-savings-period").innerText=formatCurrency(s)),document.getElementById("kpi-savings-rate")&&(d=0<r?s/r*100:0,document.getElementById("kpi-savings-rate").innerText=d.toFixed(1)),document.getElementById("kpi-survival-months")){let t=new Date(l.getTime());t.setMonth(t.getMonth()-6);i=a.filter(e=>"EXPENSE"===e.type&&"PAID"===e.status&&e.dateObj>=t&&e.dateObj<=l).reduce((e,t)=>e+(parseFloat(t.amount)||0),0)/6,e=0<i?c/i:0<c?999:0;document.getElementById("kpi-survival-months").innerText=99<=e?"+99":e.toFixed(1)}}function renderBillingCharts(e){var t=invoicesData.filter(e=>e.dateObj&&e.dateObj.getFullYear()===filterYear&&(e.currency||"ARS")===filterCurrency),a=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];let r=new Array(12).fill(0),n=new Array(12).fill(0),o=(t.forEach(e=>{var t=e.dateObj.getMonth(),a=parseFloat(e.amount)||0;"INCOME"===e.type?r[t]+=a:"EXPENSE"===e.type&&(n[t]+=a)}),createChart("chart-billing-trend","bar",{labels:a,datasets:[{label:"Ingresos",data:r,backgroundColor:"#2ab57d",borderRadius:5},{label:"Gastos",data:n,backgroundColor:"#fd625e",borderRadius:5}]}),{}),s=(e.filter(e=>"INCOME"===e.type).forEach(e=>{var t=e.category||"Varios";o[t]=(o[t]||0)+parseFloat(e.amount)}),createChart("chart-income-dist","doughnut",{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:["#2ab57d","#5156be","#fd625e","#ffbf53","#4ba6ef"]}]}),{}),l=(e.filter(e=>"EXPENSE"===e.type).forEach(e=>{var t=e.category||"Otros";s[t]=(s[t]||0)+parseFloat(e.amount)}),createChart("chart-expenses-dist","doughnut",{labels:Object.keys(s),datasets:[{data:Object.values(s),backgroundColor:["#fd625e","#ffbf53","#4ba6ef","#5156be","#2ab57d"]}]}),0),i=(createChart("chart-ytd","line",{labels:a,datasets:[{label:"Ingresos Acumulados (YTD)",data:r.map(e=>l+=e),borderColor:"#2ab57d",fill:!0,backgroundColor:"rgba(42, 181, 125, 0.1)",tension:.4}]}),0),d=0;e.filter(e=>"INCOME"===e.type).forEach(e=>{"PAID"===e.status?i+=parseFloat(e.amount):d+=parseFloat(e.amount)}),createChart("chart-collection-rate","pie",{labels:["Cobrado","Pendiente"],datasets:[{data:[i,d],backgroundColor:["#2ab57d","#ffbf53"]}]})}function renderSavingsDashboard(e,t){var a=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],r=t.filter(e=>e.dateObj.getFullYear()===filterYear),n=new Array(12).fill(0),o=new Array(12).fill(0);let s=t.filter(e=>e.dateObj.getFullYear()<filterYear).reduce((e,t)=>"INCOME"===t.type&&"PAID"===t.status?e+t.amount:("EXPENSE"!==t.type||"PAID"!==t.status)&&("SAVING"!==t.type||"ACTIVE"!==t.status||t.isInitial)?e:e-t.amount,0),l=t.filter(e=>e.dateObj.getFullYear()<filterYear&&"SAVING"===e.type&&"ACTIVE"===e.status).reduce((e,t)=>e+t.amount,0);for(let t=0;t<12;t++)r.filter(e=>e.dateObj.getMonth()===t).forEach(e=>{var t=parseFloat(e.amount)||0;"INCOME"===e.type&&"PAID"===e.status?s+=t:"EXPENSE"===e.type&&"PAID"===e.status?s-=t:"SAVING"===e.type&&"ACTIVE"===e.status&&(l+=t,e.isInitial||(s-=t))}),n[t]=s,o[t]=l;createChart("chart-wealth-evolution","line",{labels:a,datasets:[{label:"Caja Disponible",data:n,borderColor:"#5156be",backgroundColor:"rgba(81, 86, 190, 0.1)",fill:!0,tension:.3},{label:"Reservas Totales",data:o,borderColor:"#2ab57d",backgroundColor:"rgba(42, 181, 125, 0.1)",fill:!0,tension:.3}]});t=t.filter(e=>"SAVING"===e.type&&"ACTIVE"===e.status);let i={},d=(t.forEach(e=>{var t=e.category||"Otros";i[t]=(i[t]||0)+e.amount}),createChart("chart-savings-distribution","doughnut",{labels:Object.keys(i),datasets:[{data:Object.values(i),backgroundColor:["#2ab57d","#4ba6ef","#ffbf53","#fd625e","#5156be"]}]}),new Array(12).fill(0)),c=(r.filter(e=>"SAVING"===e.type&&"ACTIVE"===e.status).forEach(e=>{d[e.dateObj.getMonth()]+=e.amount}),createChart("chart-monthly-savings","bar",{labels:a,datasets:[{label:"Ahorro Mensual",data:d,backgroundColor:"#4ba6ef",borderRadius:5}]}),document.getElementById("goals-progress-container"));c&&(c.innerHTML="",0===(a=t.filter(e=>0<e.targetAmount)).length?c.innerHTML='<p class="text-muted text-center py-3">No hay metas con "Monto Objetivo" definido para este periodo.</p>':a.forEach(e=>{var t=Math.min(100,e.amount/e.targetAmount*100),a=t<30?"bg-danger":t<70?"bg-warning":"bg-success",a=`
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <div class="flex-grow-1">
                                <h5 class="font-size-14 mb-0">${e.entityName||e.category}</h5>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge badge-soft-primary">${t.toFixed(0)}%</span>
                            </div>
                        </div>
                        <div class="progress animated-progess custom-progress">
                            <div class="progress-bar ${a}" role="progressbar" style="width: ${t}%" 
                                aria-valuenow="${t}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">${formatCurrency(e.amount)} ahorrados</small>
                            <small class="text-muted">Meta: ${formatCurrency(e.targetAmount)}</small>
                        </div>
                    </div>
                `;c.insertAdjacentHTML("beforeend",a)}))}function updateCRMDashboard(){tasksData.filter(e=>!!e.dateObj&&e.dateObj.getFullYear()===filterYear);calculateCRMKPIs(tasksData,clientsData),renderCRMCharts(tasksData,clientsData)}function calculateCRMKPIs(e,t){var t=t.length,a=e.filter(e=>"Completada"!==e.status&&"Cancelada"!==e.status).length;let r=new Date;e=e.filter(e=>"Completada"===e.status&&e.dateObj&&e.dateObj.getMonth()===r.getMonth()&&e.dateObj.getFullYear()===r.getFullYear()).length;document.getElementById("kpi-crm-clients").innerText=t,document.getElementById("kpi-crm-active-tasks").innerText=a,document.getElementById("kpi-crm-completed-tasks").innerText=e}function renderCRMCharts(a,e){let t={},r=(a.forEach(e=>{e=e.status||"Sin Estado";t[e]=(t[e]||0)+1}),createChart("chart-crm-status","doughnut",{labels:Object.keys(t),datasets:[{data:Object.values(t),backgroundColor:["#5156be","#2ab57d","#fd625e","#ffbf53","#4ba6ef"]}]}),{}),n={};e.forEach(e=>n[e.id]=e.firstName+" "+e.lastName),a.filter(e=>"Completada"!==e.status).forEach(e=>{e.clientId&&(e=n[e.clientId]||"Desconocido",r[e]=(r[e]||0)+1)});var e=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,5),o=(createChart("chart-crm-clients","bar",{labels:e.map(e=>e[0]),datasets:[{label:"Tareas Activas",data:e.map(e=>e[1]),backgroundColor:"#5156be",borderRadius:5}]}),[]),s=[];for(let e=5;0<=e;e--){let t=new Date;t.setMonth(t.getMonth()-e);var l=t.toLocaleString("es-ES",{month:"short"}),l=(o.push(l),a.filter(e=>"Completada"===e.status&&e.dateObj&&e.dateObj.getMonth()===t.getMonth()&&e.dateObj.getFullYear()===t.getFullYear()).length);s.push(l)}createChart("chart-crm-trend","line",{labels:o,datasets:[{label:"Tareas Completadas",data:s,borderColor:"#2ab57d",fill:!0,backgroundColor:"rgba(42, 181, 125, 0.1)",tension:.4}]})}function createChart(e,n,t){var a,r=document.getElementById(e);r&&(chartInstances[e]&&chartInstances[e].destroy(),a={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(e){let t=e.label||"";t&&(t+=": ");var a=e.parsed,r="pie"===n||"doughnut"===n?formatCurrency(a):a;return"pie"===n||"doughnut"===n?(a=0<(e=e.dataset.data.reduce((e,t)=>e+t,0))?(a/e*100).toFixed(1)+"%":"0%",""+t+r+` (${a})`):""+t+r}}}},scales:"bar"===n||"line"===n?{y:{beginAtZero:!0}}:{}},chartInstances[e]=new Chart(r,{type:n,data:t,options:a}))}function formatCurrency(e){return("USD"===filterCurrency?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}):new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0})).format(e)}