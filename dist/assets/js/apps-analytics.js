let chartInstances={},invoicesData=[],tasksData=[],clientsData=[],accountsData=[],assetsData=[],EXCHANGE_RATE=1200,now=new Date,filterYear=now.getFullYear(),filterPeriod="YEAR",filterMonth=now.getMonth(),filterCurrency="ARS",filterAccount="ALL";function populateYearSelect(){var t=document.getElementById("analytics-year");if(t){t.innerHTML="";for(let e=filterYear+1;2024<=e;e--){var a=document.createElement("option");a.value=e,(a.textContent=e)===filterYear&&(a.selected=!0),t.appendChild(a)}}}function loadData(){db.collection("transactions").onSnapshot(e=>{invoicesData=[],e.forEach(e=>{var t=e.data();let a=null;t.date&&t.date.seconds?a=new Date(1e3*t.date.seconds):t.date&&(a=new Date(t.date)),a&&!isNaN(a.getTime())&&invoicesData.push({id:e.id,...t,dateObj:a})}),updateDashboard()}),db.collection("tasks").onSnapshot(e=>{tasksData=[],e.forEach(e=>{var t=e.data();let a=null;t.dueDate?a=new Date(t.dueDate+"T12:00:00"):t.date&&t.date.seconds?a=new Date(1e3*t.date.seconds):t.createdAt&&t.createdAt.seconds?a=new Date(1e3*t.createdAt.seconds):t.createdAt?a=new Date(t.createdAt):t.date&&(a=new Date(t.date)),tasksData.push({id:e.id,...t,dateObj:a})}),updateDashboard()}),db.collection("clients").onSnapshot(e=>{clientsData=[],e.forEach(e=>{clientsData.push({id:e.id,...e.data()})}),updateDashboard()}),db.collection("cashflow_accounts").onSnapshot(e=>{accountsData=[],e.forEach(e=>accountsData.push({id:e.id,...e.data()})),populateAccountSelect(),updateDashboard()}),db.collection("cashflow_assets").onSnapshot(e=>{assetsData=[],e.forEach(e=>{var t=e.data();t.isDeleted||assetsData.push({id:e.id,...t})}),updateDashboard()})}function populateAccountSelect(){let a=document.getElementById("analytics-account");a&&(a.innerHTML='<option value="ALL">Todas las Cuentas</option>',accountsData.filter(e=>!1!==e.isActive).forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name+` (${e.currency})`,e.id===filterAccount&&(t.selected=!0),a.appendChild(t)}))}document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof Chart&&(Chart.defaults.font.family="'Inter', 'Roboto', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",Chart.defaults.font.size=12,Chart.defaults.color="#495057",Chart.defaults.plugins.tooltip.padding=10,Chart.defaults.plugins.tooltip.backgroundColor="rgba(0, 0, 0, 0.8)"),populateYearSelect(),document.getElementById("analytics-month").value=filterMonth,updatePeriodButtons(),updateSelectorsVisibility(),window.Imala.auth.checkAuth(e=>{console.log("Analytics Auth:",e),loadData()})});let appAnalytics={setPeriod:e=>{filterPeriod=e,updatePeriodButtons(),updateSelectorsVisibility(),updateDashboard()},setCurrency:t=>{filterCurrency=t,document.querySelectorAll(".currency-label").forEach(e=>e.innerText=t);var e=document.getElementById("currency-ars"),a=document.getElementById("currency-usd");e&&(e.checked="ARS"===t),a&&(a.checked="USD"===t),updateDashboard()},showChartHelp:e=>{var t,a,r,e={RUN_RATE:{title:"Ayuda: Run Rate (Ingresos vs Gastos)",content:`
                    <p>Este gráfico muestra el pulso operativo de tu negocio mes a mes:</p>
                    <ul class="text-muted">
                        <li><strong>Ingresos (Verde):</strong> Dinero que entra por ventas o servicios.</li>
                        <li><strong>Gastos (Rojo):</strong> Costos operativos y salidas de dinero.</li>
                    </ul>
                    <p class="mb-0"><strong>Interpretación:</strong> Lo ideal es ver las barras verdes consistentemente por encima de las rojas. Si la diferencia se achica, tu margen operativo está bajo presión.</p>
                `},COST_STRUCTURE:{title:"Ayuda: Estructura de Costos",content:`
                    <p>Visualiza en qué se está yendo tu dinero:</p>
                    <p class="text-muted">Divide tus gastos por categorías para identificar los centros de mayor costo.</p>
                    <p class="mb-0"><strong>Interpretación:</strong> Te permite detectar gastos "hormiga" o áreas donde podrías optimizar recursos si un sector se vuelve demasiado dominante.</p>
                `},INCOME_TREND:{title:"Ayuda: Tendencia de Ingresos",content:`
                    <p>Compara tus ingresos actuales con el mismo periodo del año anterior:</p>
                    <ul class="text-muted">
                        <li><strong>Año Actual:</strong> Tu desempeño presente.</li>
                        <li><strong>Año Anterior (Línea tenue):</strong> Tu referencia histórica.</li>
                    </ul>
                    <p class="mb-0"><strong>Interpretación:</strong> Te ayuda a entender la estacionalidad de tu negocio y a validar si estás creciendo interanualmente.</p>
                `},ASSET_ALLOCATION:{title:"Ayuda: Asignación de Activos",content:`
                    <p>Muestra cómo está distribuido tu patrimonio invertido:</p>
                    <p class="text-muted">Indica el porcentaje de capital en cada tipo de activo (ej: Cripto, Acciones, Inmuebles, Fondo de Emergencia).</p>
                    <p class="mb-0"><strong>Interpretación:</strong> Es clave para la gestión de riesgo. Una cartera diversificada te protege contra la volatilidad de un sector específico.</p>
                `},CURRENCY_COMPOSITION:{title:"Ayuda: Composición por Moneda",content:`
                    <p>Indica tu exposición cambiaria:</p>
                    <p class="text-muted">Muestra qué porcentaje de tu patrimonio total (Cajas + Inversiones) está en cada moneda (ARS, USD, etc.).</p>
                    <p class="mb-0"><strong>Interpretación:</strong> En contextos inflacionarios, te permite controlar si estás manteniendo una cobertura adecuada en moneda dura.</p>
                `},WEALTH_EVOLUTION:{title:"Ayuda: Evolución Patrimonial",content:`
                    <p>La métrica definitiva de salud financiera a largo plazo:</p>
                    <p class="text-muted">Suma el valor de todas tus cajas y activos mes a mes.</p>
                    <p class="mb-0"><strong>Interpretación:</strong> No importa cuánto ganes, sino cuánto conserves. Una pendiente ascendente indica que tu riqueza neta real está aumentando.</p>
                `}}[e];e&&(t=document.getElementById("help-title"),a=document.getElementById("help-content"),r=document.getElementById("modal-chart-help"),t&&(t.innerText=e.title),a&&(a.innerHTML=e.content),r?new bootstrap.Modal(r).show():(console.warn("Help modal element not found"),alert(e.title+"\n\n"+e.content.replace(/<[^>]*>?/gm,""))))},showChartHelp:e=>{e={WEALTH_EVOLUTION:{title:"Ayuda: Evolución del Patrimonio",content:`
                    <p>Este gráfico muestra la trayectoria de tu capital durante todo el año:</p>
                    <ul class="text-muted">
                        <li><strong>Caja Disponible (Línea Azul):</strong> Es tu liquidez real. Dinero libre para gastar después de operar y ahorrar.</li>
                        <li><strong>Reservas Totales (Línea Verde):</strong> Es el acumulado de todos tus ahorros y fondos de reserva activos.</li>
                    </ul>
                    <p class="mb-0"><strong>Tip:</strong> Busca que la línea verde siempre suba, indicando que tu patrimonio crece mes a mes.</p>
                `},SAVINGS_DISTRIBUTION:{title:"Ayuda: Distribución por Metas",content:`
                    <p>Muestra cómo tienes repartido tu capital de reserva actual:</p>
                    <p class="text-muted">Toma el total de tus ahorros y los divide por las categorías que has definido (ej. Inversiones, Fondo de Emergencia, Viajes).</p>
                    <p class="mb-0"><strong>Tip:</strong> Te ayuda a detectar si estás demasiado concentrado en una sola meta.</p>
                `},MONTHLY_SAVINGS:{title:"Ayuda: Ahorro Mensual",content:`
                    <p>Mide tu ritmo de ahorro o "capitalización" mensual:</p>
                    <p class="text-muted">Cada barra representa el monto neto que lograste mover del saldo disponible hacia tus ahorros en ese mes específico.</p>
                    <p class="mb-0"><strong>Tip:</strong> Compara los picos y valles para entender qué meses son más propicios para tu ahorro.</p>
                `},SURVIVAL_RATE:{title:"Ayuda: Supervivencia Estimada",content:`
                    <p>Indica cuántos meses podrías mantener tu estilo de vida actual sin percibir ingresos:</p>
                    <ul class="text-muted">
                        <li><strong>Cálculo:</strong> Divide tus Reservas Totales por tu promedio de gastos de la <strong>moneda seleccionada</strong> de los últimos 6 meses.</li>
                        <li><strong>Significado:</strong> Si el valor es 6.0, significa que tienes ahorros para cubrir 6 meses de gastos en esa moneda.</li>
                        <li><strong>Nota:</strong> Si no tienes gastos registrados en esta moneda, el sistema asumirá una supervivencia prolongada (+99).</li>
                    </ul>
                    <p class="mb-0"><strong>Tip:</strong> Los expertos recomiendan tener entre 3 y 6 meses de "pista financiera" como fondo de emergencia.</p>
                `},SAVINGS_PROGRESS:{title:"Ayuda: Progreso de Metas",content:`
                    <p>Muestra qué tan cerca estás de alcanzar tus objetivos financieros definidos:</p>
                    <ul class="text-muted">
                        <li><strong>Rojo:</strong> Menos del 30% completado.</li>
                        <li><strong>Amarillo:</strong> Entre el 30% y 70%.</li>
                        <li><strong>Verde:</strong> Más del 70% del camino recorrido.</li>
                    </ul>
                    <p class="mb-0"><strong>Tip:</strong> Define un "Monto Objetivo" al crear un ahorro para que aparezca en este panel.</p>
                `},CRM_STATUS:{title:"Ayuda: Estado de Tareas",content:`
                    <p>Muestra la distribución de tus tareas actuales por su estado de gestión:</p>
                    <p class="text-muted">Te permite ver rápidamente cuántas tareas tienes pendientes, en curso o completadas.</p>
                    <p class="mb-0"><strong>Tip:</strong> Ideal para identificar cuellos de botella en la gestión diaria.</p>
                `},CRM_CLIENTS:{title:"Ayuda: Top Clientes Activos",content:`
                    <p>Identifica a los clientes que requieren mayor atención:</p>
                    <p class="text-muted">Muestra los 5 clientes que tienen más tareas abiertas (no completadas).</p>
                    <p class="mb-0"><strong>Tip:</strong> Te ayuda a priorizar tu tiempo hacia los casos con mayor actividad o complejidad.</p>
                `},CRM_TREND:{title:"Ayuda: Tendencia de Tareas",content:`
                    <p>Mide tu productividad operativa en los últimos 6 meses:</p>
                    <p class="text-muted">Muestra la cantidad de tareas que lograste cerrar (estado "Completada") cada mes.</p>
                    <p class="mb-0"><strong>Tip:</strong> Una línea ascendente o estable indica un buen ritmo de resolución de requerimientos.</p>
                `}}[e];e&&(document.getElementById("help-title").innerText=e.title,document.getElementById("help-content").innerHTML=e.content,new bootstrap.Modal(document.getElementById("modal-chart-help")).show())},switchTab:e=>{currentTab=e,setTimeout(()=>{Object.values(chartInstances).forEach(e=>{e&&"function"==typeof e.resize&&e.resize()}),updateDashboard()},200)},applyFilters:()=>{filterYear=parseInt(document.getElementById("analytics-year").value),filterMonth=parseInt(document.getElementById("analytics-month").value),filterQuarter=parseInt(document.getElementById("analytics-quarter").value),filterSemester=parseInt(document.getElementById("analytics-semester").value),filterAccount=document.getElementById("analytics-account").value,updateDashboard()}},currentTab="BILLING";function updatePeriodButtons(){document.querySelectorAll(".btn-group button").forEach(e=>e.classList.remove("active"));var e="btn-period-"+filterPeriod.toLowerCase(),e=document.getElementById(e);e&&e.classList.add("active")}function updateSelectorsVisibility(){var e=document.getElementById("analytics-month"),t=document.getElementById("analytics-quarter"),a=document.getElementById("analytics-semester");e&&e.classList.add("d-none"),t&&t.classList.add("d-none"),a&&a.classList.add("d-none"),"MONTH"===filterPeriod&&e&&e.classList.remove("d-none"),"QUARTER"===filterPeriod&&t&&t.classList.remove("d-none"),"SEMESTER"===filterPeriod&&a&&a.classList.remove("d-none")}function updateDashboard(){let e=invoicesData;var t=(e="ALL"!==filterAccount?invoicesData.filter(e=>e.accountId===filterAccount):e).filter(e=>e.dateObj.getFullYear()===filterYear);calculateOperativeKPIs(t.filter(e=>"MONTH"!==filterPeriod||e.dateObj.getMonth()===filterMonth)),calculateWealthKPIs(),"BILLING"===currentTab?renderOperativeDashboard(t):"SAVINGS"===currentTab?renderWealthDashboard():"CRM"===currentTab&&updateCRMDashboard()}function calculateOperativeKPIs(e){let a=0,r=0,n=0;e.forEach(e=>{let t=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(t*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(t/=EXCHANGE_RATE),"INCOME"===e.type?a+=t:"EXPENSE"===e.type?"INVESTMENT"!==e.category&&(r+=t):"SAVING"===e.type&&(n+=t)});var e=a-r,t=0<a?n/a*100:0;document.getElementById("kpi-billed")&&(document.getElementById("kpi-billed").innerText=formatCurrency(a)),document.getElementById("kpi-expenses")&&(document.getElementById("kpi-expenses").innerText=formatCurrency(r)),document.getElementById("kpi-profit")&&(document.getElementById("kpi-profit").innerText=formatCurrency(e)),document.getElementById("kpi-savings-rate")&&(document.getElementById("kpi-savings-rate").innerText=t.toFixed(1))}function calculateWealthKPIs(){let a=0,r=0;accountsData.forEach(e=>{let t=parseFloat(e.balance)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(t*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(t/=EXCHANGE_RATE),a+=t}),assetsData.forEach(e=>{let t=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(t*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(t/=EXCHANGE_RATE),r+=t});var e=a+r,t=new Date;let n=new Date(t.getFullYear(),t.getMonth()-3,1);t=invoicesData.filter(e=>"EXPENSE"===e.type&&"INVESTMENT"!==e.category&&e.dateObj>=n);let o=0;t.forEach(e=>{let t=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(t*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(t/=EXCHANGE_RATE),o+=t});t=o/3,t=0<t?a/t:0<a?99:0;document.getElementById("kpi-total-wealth")&&(document.getElementById("kpi-total-wealth").innerText=formatCurrency(e)),document.getElementById("kpi-liquidity")&&(document.getElementById("kpi-liquidity").innerText=formatCurrency(a)),document.getElementById("kpi-invested")&&(document.getElementById("kpi-invested").innerText=formatCurrency(r)),document.getElementById("kpi-survival-months")&&(document.getElementById("kpi-survival-months").innerText=t.toFixed(1))}function renderOperativeDashboard(e){var t=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];let r=new Array(12).fill(0),n=new Array(12).fill(0),o=new Array(12).fill(0),s=(e.forEach(e=>{var t=e.dateObj.getMonth();let a=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(a*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(a/=EXCHANGE_RATE),"INCOME"===e.type?r[t]+=a:"EXPENSE"===e.type&&"INVESTMENT"!==e.category&&(n[t]+=a)}),invoicesData.filter(e=>e.dateObj.getFullYear()===filterYear-1&&"INCOME"===e.type&&("ALL"===filterAccount||e.accountId===filterAccount)).forEach(e=>{var t=e.dateObj.getMonth();let a=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(a*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(a/=EXCHANGE_RATE),o[t]+=a}),createChart("chart-billing-trend","bar",{labels:t,datasets:[{label:"Ingresos "+filterYear,data:r,backgroundColor:"#2ab57d",borderRadius:5},{label:"Gastos "+filterYear,data:n,backgroundColor:"#fd625e",borderRadius:5}]}),{});e.filter(e=>"EXPENSE"===e.type&&"INVESTMENT"!==e.category).forEach(e=>{var t=e.category||"Varios";let a=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(a*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(a/=EXCHANGE_RATE),s[t]=(s[t]||0)+a});var e=Object.entries(s).sort((e,t)=>t[1]-e[1]),a=e.slice(0,5),e=e.slice(5).reduce((e,t)=>e+t[1],0),l=a.map(e=>e[0]),a=a.map(e=>e[1]);0<e&&(l.push("Otros"),a.push(e)),createChart("chart-expenses-dist","doughnut",{labels:l,datasets:[{data:a,backgroundColor:["#fd625e","#ffbf53","#4ba6ef","#5156be","#2ab57d","#ced4da"]}]}),createChart("chart-income-trend","line",{labels:t,datasets:[{label:"Ingresos "+filterYear,data:r,borderColor:"#5156be",backgroundColor:"rgba(81, 86, 190, 0.1)",fill:!0,tension:.4},{label:"Ingresos "+(filterYear-1),data:o,borderColor:"#ced4da",borderDash:[5,5],fill:!1,tension:.4}]})}function renderWealthDashboard(){let r={},a=(assetsData.forEach(e=>{var t=e.category||"Inversión";let a=parseFloat(e.amount)||0;"USD"===e.currency&&"ARS"===filterCurrency&&(a*=EXCHANGE_RATE),"ARS"===e.currency&&"USD"===filterCurrency&&(a/=EXCHANGE_RATE),r[t]=(r[t]||0)+a}),createChart("chart-asset-allocation","doughnut",{labels:Object.keys(r),datasets:[{data:Object.values(r),backgroundColor:["#5156be","#2ab57d","#ffbf53","#fd625e","#4ba6ef"]}]}),0),n=0,o=(accountsData.forEach(e=>{var t=parseFloat(e.balance)||0;"ARS"===e.currency?a+=t:"USD"===e.currency&&(n+=t*EXCHANGE_RATE)}),"USD"===filterCurrency&&(a/=EXCHANGE_RATE,n/=EXCHANGE_RATE),createChart("chart-currency-composition","bar",{labels:["Liquidez (Caja)"],datasets:[{label:"ARS",data:[a],backgroundColor:"#2ab57d"},{label:"USD",data:[n],backgroundColor:"#5156be"}]},{indexAxis:"y",plugins:{legend:{display:!0}},scales:{x:{stacked:!0},y:{stacked:!0}}}),document.getElementById("goals-progress-container"));o&&(o.innerHTML="",0===(e=assetsData.filter(e=>0<e.targetAmount)).length?o.innerHTML='<p class="text-muted text-center pt-5">No hay activos con "Objetivo" definido.</p>':e.forEach(e=>{var t=parseFloat(e.amount)||0,a=parseFloat(e.targetAmount)||0,r=Math.min(100,t/a*100),n=r<30?"bg-danger":r<70?"bg-warning":"bg-success",e=`
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <div class="flex-grow-1"><h5 class="font-size-14 mb-0">${e.name}</h5></div>
                            <div class="flex-shrink-0"><span class="badge badge-soft-primary">${r.toFixed(0)}%</span></div>
                        </div>
                        <div class="progress animated-progess custom-progress">
                            <div class="progress-bar ${n}" role="progressbar" style="width: ${r}%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">${formatCurrency(t)}</small>
                            <small class="text-muted">Meta: ${formatCurrency(a)}</small>
                        </div>
                    </div>
                `;o.insertAdjacentHTML("beforeend",e)}));var e,t=new Array(12).fill(0),s=(new Date).getMonth(),l=parseFloat(document.getElementById("kpi-total-wealth").innerText.replace(/[^0-9.-]+/g,""))||0;for(let e=0;e<=s;e++)t[e]=l;createChart("chart-wealth-evolution","line",{labels:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],datasets:[{label:"Patrimonio Neto",data:t,borderColor:"#2ab57d",backgroundColor:"rgba(42, 181, 125, 0.1)",fill:!0,tension:.4}]})}function updateCRMDashboard(){tasksData.filter(e=>!!e.dateObj&&e.dateObj.getFullYear()===filterYear);calculateCRMKPIs(tasksData,clientsData),renderCRMCharts(tasksData,clientsData)}function calculateCRMKPIs(e,t){var t=t.length,a=e.filter(e=>"Completada"!==e.status&&"Cancelada"!==e.status).length;let r=new Date;e=e.filter(e=>("Completada"===e.status||"COMPLETED"===e.status)&&e.dateObj&&e.dateObj.getMonth()===r.getMonth()&&e.dateObj.getFullYear()===r.getFullYear()).length;document.getElementById("kpi-crm-clients").innerText=t,document.getElementById("kpi-crm-active-tasks").innerText=a,document.getElementById("kpi-crm-completed-tasks").innerText=e}function renderCRMCharts(a,e){let t={},r=(a.forEach(e=>{e=e.status||"Sin Estado";t[e]=(t[e]||0)+1}),createChart("chart-crm-status","doughnut",{labels:Object.keys(t).map(e=>"TODO"===e?"Pendiente":"COMPLETED"===e||"Completada"===e?"Completado":"LATE"===e?"Atrasado":e),datasets:[{data:Object.values(t),backgroundColor:["#5156be","#2ab57d","#fd625e","#ffbf53","#4ba6ef"]}]},{noCurrency:!0}),{}),n={};e.forEach(e=>{var t=e.firstName||e.lastName?((e.firstName||"")+" "+(e.lastName||"")).trim():e.name||"Cliente sin nombre";n[e.id]=t}),a.filter(e=>"Completada"!==e.status&&"COMPLETED"!==e.status).forEach(e=>{e.clientId&&(e=n[e.clientId]||"Desconocido",r[e]=(r[e]||0)+1)});var e=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,5),o=(createChart("chart-crm-clients","bar",{labels:e.map(e=>e[0]),datasets:[{label:"Tareas Activas",data:e.map(e=>e[1]),backgroundColor:"#5156be",borderRadius:5}]},{noCurrency:!0}),[]),s=[];for(let e=5;0<=e;e--){let t=new Date;t.setMonth(t.getMonth()-e);var l=t.toLocaleString("es-ES",{month:"short"}),l=(o.push(l),a.filter(e=>("Completada"===e.status||"COMPLETED"===e.status)&&e.dateObj&&e.dateObj.getMonth()===t.getMonth()&&e.dateObj.getFullYear()===t.getFullYear()).length);s.push(l)}createChart("chart-crm-trend","line",{labels:o,datasets:[{label:"Tareas Completadas",data:s,borderColor:"#2ab57d",fill:!0,backgroundColor:"rgba(42, 181, 125, 0.1)",tension:.4}]},{noCurrency:!0})}function createChart(e,o,t,s={}){var a,r=document.getElementById(e);r&&(chartInstances[e]&&chartInstances[e].destroy(),a={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(e){let t=e.dataset.label||"";t&&(t+=": ");var a,r="object"==typeof e.parsed&&null!==e.parsed?e.parsed.y:e.parsed,n=s.noCurrency?r:formatCurrency(r);return"pie"===o||"doughnut"===o?(r=0<(a=e.dataset.data.reduce((e,t)=>e+t,0))?(r/a*100).toFixed(1)+"%":"0%",`${s.noCurrency?e.label:t}${n} (${r})`):""+t+n}}}},scales:"bar"===o||"line"===o?{y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.05)"},ticks:{callback:function(e){return!s.noCurrency&&1e3<=e?formatCurrency(e):e}}},x:{grid:{display:!1}}}:{}},chartInstances[e]=new Chart(r,{type:o,data:t,options:a}))}function formatCurrency(e){return("USD"===filterCurrency?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}):new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0})).format(e)}