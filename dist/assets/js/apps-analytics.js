let chartInstances={},invoicesData=[],tasksData=[],clientsData=[],now=new Date,filterYear=now.getFullYear(),filterPeriod="MONTH",filterMonth=now.getMonth(),filterQuarter=Math.floor(now.getMonth()/3)+1,filterSemester=now.getMonth()<6?1:2,filterCurrency="ARS";function populateYearSelect(){var t=document.getElementById("analytics-year");if(t){t.innerHTML="";for(let e=filterYear+1;2024<=e;e--){var a=document.createElement("option");a.value=e,(a.textContent=e)===filterYear&&(a.selected=!0),t.appendChild(a)}}}function loadData(){db.collection("transactions").onSnapshot(e=>{invoicesData=[],e.forEach(e=>{var t=e.data();let a=null;t.date&&t.date.seconds?a=new Date(1e3*t.date.seconds):t.date&&(a=new Date(t.date)),a&&!isNaN(a.getTime())&&invoicesData.push({id:e.id,...t,dateObj:a})}),updateDashboard()}),db.collection("tasks").onSnapshot(e=>{tasksData=[],e.forEach(e=>{var t=e.data();let a=null;t.createdAt&&t.createdAt.seconds?a=new Date(1e3*t.createdAt.seconds):t.createdAt&&(a=new Date(t.createdAt)),tasksData.push({id:e.id,...t,dateObj:a})}),updateDashboard()}),db.collection("clients").onSnapshot(e=>{clientsData=[],e.forEach(e=>{clientsData.push({id:e.id,...e.data()})}),updateDashboard()})}document.addEventListener("DOMContentLoaded",function(){populateYearSelect(),document.getElementById("analytics-month").value=filterMonth,document.getElementById("analytics-quarter").value=filterQuarter,document.getElementById("analytics-semester").value=filterSemester,updatePeriodButtons(),updateSelectorsVisibility(),window.Imala.auth.checkAuth(e=>{console.log("Analytics Auth:",e),loadData()})});let appAnalytics={setPeriod:e=>{filterPeriod=e,updatePeriodButtons(),updateSelectorsVisibility(),updateDashboard()},setCurrency:t=>{filterCurrency=t,document.querySelectorAll(".currency-label").forEach(e=>e.innerText=t),updateDashboard()},switchTab:e=>{setTimeout(()=>{Object.values(chartInstances).forEach(e=>e.resize())},200)}};function updatePeriodButtons(){document.querySelectorAll(".btn-group button").forEach(e=>e.classList.remove("active"));var e="btn-period-"+filterPeriod.toLowerCase(),e=document.getElementById(e);e&&e.classList.add("active")}function updateSelectorsVisibility(){document.getElementById("analytics-month").classList.add("d-none"),document.getElementById("analytics-quarter").classList.add("d-none"),document.getElementById("analytics-semester").classList.add("d-none"),"MONTH"===filterPeriod&&document.getElementById("analytics-month").classList.remove("d-none"),"QUARTER"===filterPeriod&&document.getElementById("analytics-quarter").classList.remove("d-none"),"SEMESTER"===filterPeriod&&document.getElementById("analytics-semester").classList.remove("d-none")}function updateDashboard(){var e=invoicesData.filter(e=>{var t,a;return!!e.dateObj&&e.dateObj.getFullYear()===filterYear&&(e=e.dateObj.getMonth(),t=Math.floor(e/3)+1,a=e<6?1:2,"MONTH"===filterPeriod?e===filterMonth:"QUARTER"===filterPeriod?t===filterQuarter:"SEMESTER"!==filterPeriod||a===filterSemester)}).filter(e=>(e.currency||"ARS")===filterCurrency);calculateKPIs(e),renderBillingCharts(e),updateCRMDashboard()}function calculateKPIs(e){let a=0,r=0,n=0;e.forEach(e=>{var t=parseFloat(e.amount)||0;"INCOME"===e.type?(a+=t,"PAID"!==e.status&&(n+=t)):"EXPENSE"===e.type&&(r+=t,"PAID"!==e.status)&&(n+=t)});invoicesData.filter(e=>e.dateObj&&e.dateObj.getFullYear()===filterYear&&"INCOME"===e.type).reduce((e,t)=>e+(parseFloat(t.amount)||0),0);e=a-r;document.getElementById("kpi-billed").innerText=formatCurrency(a),document.getElementById("kpi-expenses").innerText=formatCurrency(r),document.getElementById("kpi-profit").innerText=formatCurrency(e),document.getElementById("kpi-pending").innerText=formatCurrency(n)}function renderBillingCharts(e){var t=invoicesData.filter(e=>e.dateObj&&e.dateObj.getFullYear()===filterYear&&(e.currency||"ARS")===filterCurrency),a=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];let r=new Array(12).fill(0),n=new Array(12).fill(0),o=(t.forEach(e=>{var t=e.dateObj.getMonth(),a=parseFloat(e.amount)||0;"INCOME"===e.type?r[t]+=a:"EXPENSE"===e.type&&(n[t]+=a)}),createChart("chart-billing-trend","bar",{labels:a,datasets:[{label:"Ingresos",data:r,backgroundColor:"#2ab57d",borderRadius:5},{label:"Gastos",data:n,backgroundColor:"#fd625e",borderRadius:5}]}),{}),l=(e.filter(e=>"INCOME"===e.type).forEach(e=>{var t=e.category||"Varios";o[t]=(o[t]||0)+parseFloat(e.amount)}),createChart("chart-income-dist","doughnut",{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:["#2ab57d","#5156be","#fd625e","#ffbf53","#4ba6ef"]}]}),{}),s=(e.filter(e=>"EXPENSE"===e.type).forEach(e=>{var t=e.category||"Otros";l[t]=(l[t]||0)+parseFloat(e.amount)}),createChart("chart-expenses-dist","doughnut",{labels:Object.keys(l),datasets:[{data:Object.values(l),backgroundColor:["#fd625e","#ffbf53","#4ba6ef","#5156be","#2ab57d"]}]}),0),d=(createChart("chart-ytd","line",{labels:a,datasets:[{label:"Ingresos Acumulados (YTD)",data:r.map(e=>s+=e),borderColor:"#2ab57d",fill:!0,backgroundColor:"rgba(42, 181, 125, 0.1)",tension:.4}]}),0),c=0;e.filter(e=>"INCOME"===e.type).forEach(e=>{"PAID"===e.status?d+=parseFloat(e.amount):c+=parseFloat(e.amount)}),createChart("chart-collection-rate","pie",{labels:["Cobrado","Pendiente"],datasets:[{data:[d,c],backgroundColor:["#2ab57d","#ffbf53"]}]})}function updateCRMDashboard(){tasksData.filter(e=>!!e.dateObj&&e.dateObj.getFullYear()===filterYear);calculateCRMKPIs(tasksData,clientsData),renderCRMCharts(tasksData,clientsData)}function calculateCRMKPIs(e,t){var t=t.length,a=e.filter(e=>"Completada"!==e.status&&"Cancelada"!==e.status).length;let r=new Date;e=e.filter(e=>"Completada"===e.status&&e.dateObj&&e.dateObj.getMonth()===r.getMonth()&&e.dateObj.getFullYear()===r.getFullYear()).length;document.getElementById("kpi-crm-clients").innerText=t,document.getElementById("kpi-crm-active-tasks").innerText=a,document.getElementById("kpi-crm-completed-tasks").innerText=e}function renderCRMCharts(a,e){let t={},r=(a.forEach(e=>{e=e.status||"Sin Estado";t[e]=(t[e]||0)+1}),createChart("chart-crm-status","doughnut",{labels:Object.keys(t),datasets:[{data:Object.values(t),backgroundColor:["#5156be","#2ab57d","#fd625e","#ffbf53","#4ba6ef"]}]}),{}),n={};e.forEach(e=>n[e.id]=e.firstName+" "+e.lastName),a.filter(e=>"Completada"!==e.status).forEach(e=>{e.clientId&&(e=n[e.clientId]||"Desconocido",r[e]=(r[e]||0)+1)});var e=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,5),o=(createChart("chart-crm-clients","bar",{labels:e.map(e=>e[0]),datasets:[{label:"Tareas Activas",data:e.map(e=>e[1]),backgroundColor:"#5156be",borderRadius:5}]}),[]),l=[];for(let e=5;0<=e;e--){let t=new Date;t.setMonth(t.getMonth()-e);var s=t.toLocaleString("es-ES",{month:"short"}),s=(o.push(s),a.filter(e=>"Completada"===e.status&&e.dateObj&&e.dateObj.getMonth()===t.getMonth()&&e.dateObj.getFullYear()===t.getFullYear()).length);l.push(s)}createChart("chart-crm-trend","line",{labels:o,datasets:[{label:"Tareas Completadas",data:l,borderColor:"#2ab57d",fill:!0,backgroundColor:"rgba(42, 181, 125, 0.1)",tension:.4}]})}function createChart(e,t,a){var r=document.getElementById(e);r&&(chartInstances[e]&&chartInstances[e].destroy(),chartInstances[e]=new Chart(r,{type:t,data:a,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:"bar"===t||"line"===t?{y:{beginAtZero:!0}}:{}}}))}function formatCurrency(e){return("USD"===filterCurrency?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}):new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0})).format(e)}