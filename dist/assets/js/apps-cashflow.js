document.addEventListener("DOMContentLoaded",function(){let y=window.Imala.db,E=window.Imala.auth,v=(E.onAuthStateChanged(e=>{e?((async()=>{let t=["Ventas","Honorarios","Otros"],c=["Alquiler","Expensas","Servicios","Sueldos","Impuestos","Otros"],n=["Fondo de Reserva","Inversión","Viajes","Bienes","Otros"];d={INCOME:[],EXPENSE:[],SAVING:[]};try{let a=y.collection("cashflow_categories");var e=await a.orderBy("createdAt","asc").get();let r={INCOME:new Set,EXPENSE:new Set,SAVING:new Set},o=y.batch(),i=!1;e.forEach(e=>{var t=e.data();let n=t.type;n||(n=c.includes(t.name)?"EXPENSE":"INCOME",o.update(e.ref,{type:n}),i=!0),r[n]||(r[n]=new Set),r[n].add(t.name),!1===t.active||d[n].includes(t.name)||d[n].push(t.name)});var s=(e,n)=>{e.forEach(e=>{var t;r[n].has(e)||(t=a.doc(),o.set(t,{name:e,type:n,active:!0,createdAt:new Date,createdBy:"SYSTEM"}),d[n].push(e),r[n].add(e),i=!0)})};s(t,"INCOME"),s(c,"EXPENSE"),s(n,"SAVING"),i&&(await o.commit(),console.log("Categorías sincronizadas y tipos actualizados permanentemente.")),d.INCOME.sort(),d.EXPENSE.sort(),d.SAVING.sort()}catch(e){console.error("Error loading categories:",e),0===d.INCOME.length&&(d.INCOME=[...t]),0===d.EXPENSE.length&&(d.EXPENSE=[...c]),0===d.SAVING.length&&(d.SAVING=[...n])}I("INCOME"),I("EXPENSE"),I("SAVING"),b()})(),(async()=>{let n=document.getElementById("list-entities-income"),r=document.getElementById("list-entities-expense");n&&(n.innerHTML=""),r&&(r.innerHTML=""),f={INCOME:[],EXPENSE:[]};try{(await y.collection("cashflow_entities").orderBy("name").get()).forEach(e=>{let a=e.data();var e=a.type||"BOTH",t=(e,t)=>{var n;e&&((n=document.createElement("option")).value=a.name,e.appendChild(n),f[t].includes(a.name)||f[t].push(a.name))};"CLIENT"!==e&&"BOTH"!==e||t(n,"INCOME"),"PROVIDER"!==e&&"BOTH"!==e||t(r,"EXPENSE")})}catch(e){console.error("Error loading entities",e)}})(),B(),O()):window.location.href="auth-login.html"}),new bootstrap.Modal(document.getElementById("modal-income"))),p=new bootstrap.Modal(document.getElementById("modal-expense")),r=new bootstrap.Modal(document.getElementById("modal-saving")),l=new bootstrap.Modal(document.getElementById("modal-saving-transfer")),u=[],d={INCOME:[],EXPENSE:[],SAVING:[]},f={INCOME:[],EXPENSE:[]},m=(e,t)=>new Intl.NumberFormat("es-AR",{style:"currency",currency:t}).format(e),g=e=>e?e.seconds?new Date(1e3*e.seconds):new Date(e):null;function I(e){let t="",n=("INCOME"===e?t="in-category":"EXPENSE"===e?t="ex-category":"SAVING"===e&&(t="sav-category"),document.getElementById(t));n&&(n.innerHTML='<option value="">Seleccione...</option>',d[e].forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`}))}function b(){let t=document.getElementById("filter-category");var e;t&&(e=t.value,t.innerHTML='<option value="ALL">Todas</option>',[...new Set([...d.INCOME,...d.EXPENSE])].sort().forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}),e)&&(t.value=e)}document.addEventListener("click",async t=>{t=t.target.closest("button");if(t){if(t.classList.contains("btn-add-category")){var n=t.dataset.type;let e="";"INCOME"===n?e="container-new-category-in":"EXPENSE"===n?e="container-new-category-ex":"SAVING"===n&&(e="container-new-category-sav");var n=document.getElementById(e);n&&(a=n.querySelector(".input-new-cat"),n.style.display="block",a)&&a.focus()}if(t.classList.contains("btn-cancel-new-cat")&&(n=t.closest(".container-new-cat"))&&(n.style.display="none"),t.classList.contains("btn-save-new-cat")){var a=t.dataset.type,n=t.closest(".container-new-cat"),e=n.querySelector(".input-new-cat"),r=e.value.trim();if(!r)return;var o=t,i=o.innerHTML;try{o.innerHTML='<i class="bx bx-loader bx-spin"></i>',o.disabled=!0,await y.collection("cashflow_categories").add({name:r,type:a,active:!0,createdAt:new Date,createdBy:E.currentUser.uid}),d[a].push(r),d[a].sort(),I(a),b();var c="INCOME"===a?"in-category":"EXPENSE"===a?"ex-category":"sav-category",s=document.getElementById(c);s&&(s.value=r),n.style.display="none",e.value=""}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar la categoría.","error")}finally{o.innerHTML=i,o.disabled=!1}}t.classList.contains("btn-manage-categories")&&(await S(h=t.dataset.type),w.show())}});let w=new bootstrap.Modal(document.getElementById("modal-manage-categories")),h="INCOME";async function S(n){let a=document.querySelector("#table-manage-categories tbody");a.innerHTML="<tr><td>Cargando...</td></tr>";var e=document.querySelector("#modal-manage-categories .modal-title");let t="Ingresos";"EXPENSE"===n?t="Gastos":"SAVING"===n&&(t="Ahorros"),e&&(e.textContent=`Gestionar Categorías (${t})`);try{var r=await y.collection("cashflow_categories").where("type","==",n).get();a.innerHTML="";let t=[];r.forEach(e=>{t.push({id:e.id,...e.data()})}),t.sort((e,t)=>{e=e.createdAt?e.createdAt.toDate?e.createdAt.toDate():new Date(e.createdAt):new Date(0);return(t.createdAt?t.createdAt.toDate?t.createdAt.toDate():new Date(t.createdAt):new Date(0))-e}),t.forEach(e=>{!1!==e.active&&(a.innerHTML+=`
                    <tr>
                        <td class="align-middle">${e.name}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-soft-danger" onclick="softDeleteCategory('${e.id}', '${e.name}', '${n}')">
                                <i class="mdi mdi-trash-can-outline"></i>
                            </button>
                        </td>
                    </tr>
                 `)}),""===a.innerHTML&&(a.innerHTML='<tr><td colspan="2" class="text-center text-muted">No hay categorías personalizadas para este tipo.</td></tr>')}catch(e){console.error(e),a.innerHTML="<tr><td>Error al cargar.</td></tr>"}}window.softDeleteCategory=async function(e,t,n){confirm(`¿Eliminar "${t}" del selector?`)&&(await y.collection("cashflow_categories").doc(e).update({active:!1}),d[n]=d[n].filter(e=>e!==t),I(n),S(n))};document.getElementById("form-transaction");var e=document.getElementById("btn-new-income"),n=document.getElementById("btn-new-expense"),a=document.getElementById("btn-new-saving"),o=document.getElementById("btn-transfer-saving"),e=(e&&e.addEventListener("click",()=>i("INCOME")),n&&n.addEventListener("click",()=>i("EXPENSE")),a&&a.addEventListener("click",()=>i("SAVING")),o&&o.addEventListener("click",async function(){let n=document.getElementById("trans-source"),t=document.getElementById("trans-dest"),e=document.getElementById("trans-amount"),a=(n.innerHTML='<option value="">Seleccione origen...</option>',t.innerHTML='<option value="">Seleccione destino...</option>',e.value="",u.filter(e=>"SAVING"===e.type&&"USED"!==e.status));0===a.length?Swal.fire("Atención","No tienes ahorros activos para transferir.","info"):(a.forEach(e=>{var t=m(e.amount,e.currency);n.innerHTML+=`<option value="${e.id}" data-currency="${e.currency}" data-amount="${e.amount}">${e.entityName} (${t})</option>`}),a.forEach(e=>{t.innerHTML+=`<option value="TRANS_TO_SAV_${e.id}">${e.entityName} (Existente)</option>`}),d.SAVING.forEach(e=>{t.innerHTML+=`<option value="TRANS_TO_CAT_${e}">Nueva meta: ${e}</option>`}),l.show())}),document.getElementById("form-transfer-saving")),n=(e&&e.addEventListener("submit",async function(t){t.preventDefault();let n=document.getElementById("trans-source").value,a=document.getElementById("trans-dest").value,r=parseFloat(document.getElementById("trans-amount").value),e=document.getElementById("btn-do-transfer");if(n&&a&&r){t=u.find(e=>e.id===n);if(r>t.amount)Swal.fire("Monto excedido","No puedes transferir más del saldo disponible en el origen.","error");else{e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i>';try{var o=y.batch(),i=firebase.firestore.Timestamp.fromDate(new Date),c=y.collection("transactions").doc(),s=(o.set(c,{type:"SAVING",entityName:"Reducción por Transferencia: "+t.entityName,category:t.category,amount:-r,currency:t.currency,date:i,isInitial:!0,status:"ACTIVE",address:"Transferencia interna hacia: "+(a.includes("SAV_")?"otra meta":a.split("CAT_")[1]),createdAt:new Date,createdBy:E.currentUser.uid}),y.collection("transactions").doc());let e="",n="";if(a.startsWith("TRANS_TO_SAV_")){let t=a.replace("TRANS_TO_SAV_","");var d=u.find(e=>e.id===t);e=d.entityName,n=d.category}else e=a.replace("TRANS_TO_CAT_",""),n=e;o.set(s,{type:"SAVING",entityName:"Recibo por Transferencia: "+e,category:n,amount:r,currency:t.currency,date:i,isInitial:!0,status:"ACTIVE",address:"Transferencia interna desde: "+t.entityName,createdAt:new Date,createdBy:E.currentUser.uid}),await o.commit(),l.hide(),Swal.fire("Transferencia Exitosa","Monto reasignado correctamente.","success"),B()}catch(e){console.error(e),Swal.fire("Error","Error al procesar: "+e.message,"error")}finally{e.disabled=!1,e.textContent="Confirmar Transferencia"}}}}),document.getElementById("trans-source"));function i(e,t=null){"INCOME"===e?(document.getElementById("form-income").reset(),document.getElementById("in-id").value="",document.getElementById("in-date").valueAsDate=new Date,v.show()):"EXPENSE"===e?(document.getElementById("form-expense").reset(),document.getElementById("ex-id").value="",document.getElementById("ex-date").valueAsDate=new Date,p.show()):"SAVING"===e&&(document.getElementById("form-saving").reset(),document.getElementById("sav-id").value="",document.getElementById("sav-date").valueAsDate=new Date,t&&(document.getElementById("sav-id").value=t.id||"",document.getElementById("sav-name").value=t.entityName||"",document.getElementById("sav-amount").value=t.amount||0,document.getElementById("sav-target-amount").value=t.targetAmount||"",document.getElementById("sav-currency").value=t.currency||"ARS",document.getElementById("sav-category").value=t.category||"Fondo de Reserva",document.getElementById("sav-status").value=t.status||"ACTIVE",document.getElementById("sav-is-initial").checked=t.isInitial||!1,document.getElementById("sav-recurring").checked=t.isRecurring||!1,t.date&&(document.getElementById("sav-date").valueAsDate=g(t.date)),document.getElementById("sav-address").value=t.address||""),r.show())}async function t(e,t){e.preventDefault();var n="INCOME"===t?"in":"ex",e=e.target.querySelector('button[type="submit"]'),a=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i> Guardando...';try{var r=document.getElementById(n+"-id").value,o=document.getElementById(n+"-entity-name").value,i=o,c=t;if(i){var s="INCOME"===c?"CLIENT":"PROVIDER",d=c;if(!f[d].some(e=>e.toLowerCase()===i.toLowerCase()))try{await y.collection("cashflow_entities").add({name:i,type:s,createdAt:new Date,createdBy:E.currentUser.uid}),f[d].push(i);var l,u="INCOME"===c?"list-entities-income":"list-entities-expense",m=document.getElementById(u);m&&((l=document.createElement("option")).value=i,m.appendChild(l)),console.log(`New entity ${i} saved as ${s}.`)}catch(e){console.error("Error auto-saving entity",e)}}await 0;var g={type:t,entityName:o,cuit:document.getElementById(n+"-cuit").value,address:document.getElementById(n+"-address").value,category:document.getElementById(n+"-category").value,status:document.getElementById(n+"-status").value,currency:document.getElementById(n+"-currency").value,amount:parseFloat(document.getElementById(n+"-amount").value)||0,date:firebase.firestore.Timestamp.fromDate(document.getElementById(n+"-date").valueAsDate||new Date),isRecurring:document.getElementById(n+"-recurring").checked,updatedAt:new Date};r?await y.collection("transactions").doc(r).update(g):(g.createdAt=new Date,g.createdBy=E.currentUser.uid,await y.collection("transactions").add(g)),("INCOME"===t?v:p).hide(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Guardado correctamente.",showConfirmButton:!1,timer:3e3})}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar el movimiento: "+e.message,"error")}finally{e.disabled=!1,e.innerHTML=a}}function B(){y.collection("transactions").onSnapshot(e=>{u=[],e.forEach(e=>u.push({id:e.id,...e.data()})),(async e=>{let n=e.filter(e=>e.isRecurring&&!e.parentRecurringId),a=new Date,r=(a.getFullYear(),a.getMonth(),0);for(let t of n){var o,i;e.find(e=>e.parentRecurringId===t.id&&g(e.date).getMonth()===a.getMonth()&&g(e.date).getFullYear()===a.getFullYear())||(o=new Date(a.getFullYear(),a.getMonth(),1),delete(i={...t}).id,delete i.createdAt,i.isRecurring=!1,i.parentRecurringId=t.id,i.status="SAVING"===t.type?"ACTIVE":"PENDING",i.date=o,i.createdAt=new Date,i.description=`${t.address||""} (Recurrente Mes ${a.getMonth()+1})`,"SAVING"===t.type&&(i.isInitial=!1),console.log("Generating recurring tx for",t.entityName),await y.collection("transactions").add(i),r++)}0<r&&console.log(`Generated ${r} recurring transactions.`)})(u),x()})}n&&n.addEventListener("change",function(){var e=document.getElementById("trans-source"),e=e.options[e.selectedIndex],t=document.getElementById("trans-currency");e&&e.dataset.currency?t.value=e.dataset.currency:t.value=""}),document.getElementById("form-income").addEventListener("submit",e=>t(e,"INCOME")),document.getElementById("form-expense").addEventListener("submit",e=>t(e,"EXPENSE")),document.getElementById("form-saving").addEventListener("submit",async function(e){e.preventDefault(),e.target;var t=(e=document.getElementById("btn-save-saving")).innerHTML;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i> Guardando...';try{var n=document.getElementById("sav-id").value,a={type:"SAVING",entityName:document.getElementById("sav-name").value,category:document.getElementById("sav-category").value,status:document.getElementById("sav-status").value,currency:document.getElementById("sav-currency").value,amount:parseFloat(document.getElementById("sav-amount").value)||0,targetAmount:parseFloat(document.getElementById("sav-target-amount").value)||0,isInitial:document.getElementById("sav-is-initial").checked,isRecurring:document.getElementById("sav-recurring").checked,date:firebase.firestore.Timestamp.fromDate(document.getElementById("sav-date").valueAsDate||new Date),address:document.getElementById("sav-address").value,updatedAt:new Date};n?await y.collection("transactions").doc(n).update(a):(a.createdAt=new Date,a.createdBy=E.currentUser.uid,await y.collection("transactions").add(a)),r.hide(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Ahorro guardado.",showConfirmButton:!1,timer:3e3})}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar el ahorro.","error")}finally{e.disabled=!1,e.innerHTML=t}});let c=document.getElementById("filter-year"),s=document.getElementById("filter-period"),N=document.getElementById("filter-search"),A=document.getElementById("filter-category");a=document.getElementById("btn-apply-filters"),o=new Date;let D=o.getFullYear();e=(o.getMonth()+1).toString().padStart(2,"0");function x(){let e=[...u],t=parseInt(c.value),n=s.value,a=N.value.toLowerCase(),r=A.value;if(e=e.filter(e=>g(e.date).getFullYear()===t),"YTD"===n){let t=new Date;e=e.filter(e=>g(e.date)<=t)}else"ALL"!==n&&(e=e.filter(e=>{e=g(e.date).getMonth()+1;return"Q1"===n?1<=e&&e<=3:"Q2"===n?4<=e&&e<=6:"Q3"===n?7<=e&&e<=9:"Q4"===n?10<=e&&e<=12:"S1"===n?1<=e&&e<=6:"S2"===n?7<=e&&e<=12:e===parseInt(n)}));"ALL"!==r&&(e=e.filter(e=>e.category===r)),((e,t,n)=>{var a=(e,n)=>e.reduce((e,t)=>t.currency===n?e+(Number(t.amount)||0):e,0),r=e.filter(e=>"INCOME"===e.type),e=e.filter(e=>"EXPENSE"===e.type);$("kpi-income-expected-ars",a(r,"ARS")),$("kpi-income-expected-usd",a(r,"USD")),$("kpi-income-pending-ars",a(r.filter(e=>"PAID"!==e.status),"ARS")),$("kpi-income-pending-usd",a(r.filter(e=>"PAID"!==e.status),"USD")),$("kpi-expense-expected-ars",a(e,"ARS")),$("kpi-expense-expected-usd",a(e,"USD")),$("kpi-expense-pending-ars",a(e.filter(e=>"PAID"!==e.status),"ARS")),$("kpi-expense-pending-usd",a(e.filter(e=>"PAID"!==e.status),"USD"));let o=[...u],i=new Date;"ALL"!==n&&("YTD"===n?i=new Date:(s=parseInt(n),isNaN(s)?(c={Q1:3,Q2:6,Q3:9,Q4:12,S1:6,S2:12})[n]&&(i=new Date(t,c[n],0,23,59,59)):i=new Date(t,s,0,23,59,59)));var c=(o="ALL"!==n?o.filter(e=>g(e.date)<=i):o).filter(e=>"INCOME"===e.type&&"PAID"===e.status),t=o.filter(e=>"EXPENSE"===e.type&&"PAID"===e.status),s=o.filter(e=>"SAVING"===e.type),n=s.filter(e=>"USED"!==e.status),d=s.filter(e=>!0!==e.isInitial),l=a(c,"ARS")-a(t,"ARS")-a(d,"ARS"),t=a(c,"USD")-a(t,"USD")-a(d,"USD"),d=a(n,"ARS"),n=a(n,"USD"),d=($("kpi-balance-ars",l),$("kpi-balance-usd",t),$("kpi-savings-ars",d),$("kpi-savings-usd",n),$("kpi-total-ars",l+d),$("kpi-total-usd",t+n),a(r.filter(e=>"PAID"===e.status),"ARS")-a(e.filter(e=>"PAID"===e.status),"ARS")),n=a(r.filter(e=>"PAID"===e.status),"USD")-a(e.filter(e=>"PAID"===e.status),"USD"),r=d,a=n,e=l,d=t,n=document.getElementById("surplus-assistant-container"),l=document.getElementById("surplus-msg"),t=document.getElementById("filter-period").value;if(100<r||0<a){e=Math.min(r,e),d=Math.min(a,d);if(e<=0&&d<=0)return n.style.display="none";e={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[t];if(e)return n.style.display="block",l.innerHTML=`Ganaste <strong>${m(r,"ARS")}</strong> / <strong>${m(a,"USD")}</strong> netos en <strong>${e}</strong>. ¿Deseas ahorrar una parte?`}n.style.display="none"})(e=a?e.filter(e=>e.entityName.toLowerCase().includes(a)||e.address&&e.address.toLowerCase().includes(a)):e,t,n);{var o=e;let t=document.querySelector("#table-income tbody"),n=document.querySelector("#table-expense tbody"),a=document.querySelector("#table-saving tbody"),r=(t.innerHTML="",n.innerHTML="",a.innerHTML="",(e,t=!1)=>{var n=g(e.date).toLocaleDateString(),a=m(e.amount,e.currency);let r="badge bg-warning text-dark",o="Pendiente";return"PAID"===e.status&&(r="badge bg-success",o="Cobrado/Pagado"),"USED"===e.status&&(r="badge bg-secondary",o="Usado"),t?`
                    <tr>
                        <td>${n}</td>
                        <td>
                            <h6 class="mb-0 font-size-14 text-truncate">${e.entityName}</h6>
                        </td>
                        <td><span class="badge badge-soft-primary">${e.category}</span></td>
                        <td><span class="text-truncate d-block" style="max-width: 150px;">${e.address||"-"}</span></td>
                        <td>${"ARS"===e.currency?a:"-"}</td>
                        <td>${"USD"===e.currency?a:"-"}</td>
                        <td>${e.isRecurring?'<i class="bx bx-revision text-primary" title="Recurrente"></i>':""}</td>
                        <td><div class="${r}">${o}</div></td>
                        <td>
                            <div class="d-flex gap-2 text-end justify-content-end">
                                <button class="btn btn-sm btn-soft-primary" onclick="editSaving('${e.id}')" title="Editar"><i class="mdi mdi-pencil"></i></button>
                                ${"USED"!==e.status?`<button class="btn btn-sm btn-info" onclick="useSavingForExpense('${e.id}')" title="Usar para Gasto"><i class="mdi mdi-arrow-right-bold-circle-outline"></i></button>`:""}
                                <button class="btn btn-sm btn-soft-danger" onclick="deleteTransaction('${e.id}')"><i class="mdi mdi-trash-can"></i></button>
                            </div>
                        </td>
                    </tr>
                 `:(t="PENDING"===e.status?`<button class="btn btn-sm btn-soft-success" onclick="toggleStatus('${e.id}', 'PAID')" title="Marcar como Completado"><i class="bx bx-check"></i></button>`:`<button class="btn btn-sm btn-soft-warning" onclick="toggleStatus('${e.id}', 'PENDING')" title="Marcar Pendiente"><i class="bx bx-undo"></i></button>`,`
                <tr>
                    <td>${n}</td>
                    <td>
                        <h6 class="mb-0 font-size-14 text-truncate">${e.entityName}</h6>
                        <small class="text-muted text-truncate">${e.cuit||"-"}</small>
                    </td>
                    <td><span class="badge badge-soft-primary">${e.category}</span></td>
                    <td>${e.address||"-"}</td>
                    <td>${"ARS"===e.currency?a:"-"}</td>
                    <td>${"USD"===e.currency?a:"-"}</td>
                    <td>${e.isRecurring?'<i class="bx bx-revision text-primary"></i>':"-"}</td>
                    <td><div class="${r}">${o}</div></td>
                    <td>
                        <div class="d-flex gap-2">
                            ${t}
                            <button class="btn btn-sm btn-soft-danger" onclick="deleteTransaction('${e.id}')"><i class="mdi mdi-trash-can"></i></button>
                        </div>
                    </td>
                </tr>
            `)});o.filter(e=>"INCOME"===e.type).forEach(e=>{t.innerHTML+=r(e,!1)}),o.filter(e=>"EXPENSE"===e.type).forEach(e=>{n.innerHTML+=r(e,!1)}),o.filter(e=>"SAVING"===e.type).forEach(e=>{a.innerHTML+=r(e,!0)})}T(),M()}[...c.options].some(e=>e.value==D)||((n=document.createElement("option")).value=D,n.textContent=D,c.appendChild(n)),c.value=D,s.value=e,a.addEventListener("click",x),[c,s,A].forEach(e=>e.addEventListener("change",x));{let t=(o=new Date).getFullYear();o=(o.getMonth()+1).toString().padStart(2,"0"),n=document.getElementById("filter-year"),e=document.getElementById("filter-period"),n&&e&&([...n.options].some(e=>e.value==t)||((a=document.createElement("option")).value=t,a.textContent=t,n.appendChild(a)),n.value=t,e.value=o)}function M(){let r=document.querySelector("#table-agreements tbody"),s=(r.innerHTML="",document.getElementById("filter-period").value),d=document.getElementById("filter-year").value;let o=!!{"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[s];0===L.length?r.innerHTML='<tr><td colspan="7" class="text-center text-muted">No hay acuerdos registrados.</td></tr>':L.forEach(c=>{var e=m(c.amount,c.currency);let t="";if(o){var n=d+"-"+s,a=c.invoices&&c.invoices[n]&&c.invoices[n].sent;t=`
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="list-invoice-${c.id}" ${a?"checked":""} onchange="toggleInvoiceSent('${c.id}', '${n}', this)">
                        <label class="form-check-label text-muted small" for="list-invoice-${c.id}">${a?c.hasInvoice?"ENVIADA":"GENERADO":c.hasInvoice?"NO ENVIADA":"PENDIENTE"}</label>
                    </div>
                `}else{let o=0,i=0;c.invoices&&Object.keys(c.invoices).forEach(t=>{var[n,a]=t.split("-");if(n===d){var r,a=parseInt(a);let e=!1;"ALL"===s?e=!0:"YTD"===s?(r=new Date,new Date(parseInt(n),a-1,1)<=r&&(e=!0)):"Q1"===s?e=1<=a&&a<=3:"Q2"===s?e=4<=a&&a<=6:"Q3"===s?e=7<=a&&a<=9:"Q4"===s?e=10<=a&&a<=12:"S1"===s?e=1<=a&&a<=6:"S2"===s&&(e=7<=a&&a<=12),e&&c.invoices[t].sent&&(i++,o+=c.amount)}}),t=0<i?`<span class="badge bg-success-subtle text-success font-size-12 p-2">${i} Gen. (${m(o,c.currency)})</span>`:'<span class="text-muted small">-</span>'}r.innerHTML+=`
                <tr>
                    <td>
                        <h6 class="mb-0 text-truncate font-size-14">${c.name}</h6>
                        <small class="text-muted d-block d-lg-none">${c.description||"-"}</small>
                    </td>
                    <td class="d-none d-lg-table-cell">
                        <small class="d-block text-muted">${c.description||"-"}</small>
                        <small class="d-block code">${c.cuit||""}</small>
                    </td>
                    <td class="fw-bold">${e}</td>
                    <td>${c.hasInvoice?c.biller||"-":'<span class="text-muted font-size-11 fst-italic">No Factura</span>'}</td>
                    <td>${t}</td>
                    <td>
                        <button class="btn btn-sm btn-soft-primary" onclick="editAgreement('${c.id}')"><i class="mdi mdi-pencil"></i></button>
                    </td>
                </tr>
            `})}function T(){let r=document.getElementById("monthly-control-list");r.innerHTML="";var e=document.getElementById("filter-period").value,t=document.getElementById("filter-year").value,n={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"};let o="",a="";a=n[e]?(o=t+"-"+e,n[e]+" "+t):(t=((e=new Date).getMonth()+1).toString().padStart(2,"0"),o=e.getFullYear()+"-"+t,`${n[t]} ${e.getFullYear()} (Actual)`);n=L.filter(e=>"MONTHLY"===e.frequency&&!0===e.hasInvoice);0===n.length?r.innerHTML='<tr><td colspan="4" class="text-center text-muted">No hay clientes con factura mensual activos.</td></tr>':(document.querySelector("#card-monthly-control .card-title").innerHTML='<i class="mdi mdi-playlist-check me-1"></i> Control de Facturación: '+a,n.forEach(e=>{var t=m(e.amount,e.currency);let n=!1;e.invoices&&e.invoices[o]&&e.invoices[o].sent&&(n=!0);var a=`
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="ctrl-invoice-${e.id}" ${n?"checked":""} onchange="toggleInvoiceSent('${e.id}', '${o}', this)">
                    <label class="form-check-label text-muted small" for="ctrl-invoice-${e.id}">${n?"ENVIADA":"NO ENVIADA"}</label>
                </div>
             `;r.innerHTML+=`
                <tr class="${n?"bg-success-subtle":""}">
                    <td><strong>${e.name}</strong></td>
                    <td>${t}</td>
                    <td>${e.biller||"-"}</td>
                    <td>${a}</td>
                </tr>
             `}))}function $(e,t){document.getElementById(e).textContent=new Intl.NumberFormat("es-AR").format(t)}window.openCapitalizeModal=async function(){var e=parseFloat(document.getElementById("kpi-balance-ars").textContent.replace(/[$.]/g,"").replace(",","."))||0,t=parseFloat(document.getElementById("kpi-balance-usd").textContent.replace(/[$.]/g,"").replace(",","."))||0,n=document.getElementById("filter-period").value,a=document.getElementById("filter-year").value,r={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[n],e=(await Swal.fire({title:"Capitalizar Excedente - "+r,html:`
                <div class="text-start">
                    <p class="text-muted small">Decide cuánto mover del saldo disponible actual a tus ahorros.</p>
                    <div class="mb-3">
                        <label class="form-label">Monto en Pesos (ARS) - Disponible: ${m(e,"ARS")}</label>
                        <input id="swal-ars" class="form-control" type="number" step="0.01" value="${0<e?e:0}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto en Dólares (USD) - Disponible: ${m(t,"USD")}</label>
                        <input id="swal-usd" class="form-control" type="number" step="0.01" value="${0<t?t:0}">
                    </div>
                </div>
            `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Confirmar Ahorro",cancelButtonText:"Cancelar",preConfirm:()=>({ars:parseFloat(document.getElementById("swal-ars").value)||0,usd:parseFloat(document.getElementById("swal-usd").value)||0})})).value;e&&(async(e,t,a,r)=>{let o=new Date(a,parseInt(t),0),i=y.batch(),c=y.collection("transactions"),s=0,n=(e,t)=>{var n;e<=0||(n=c.doc(),i.set(n,{type:"SAVING",entityName:`Capitalización Excedente ${r} `+a,category:"Fondo de Reserva",status:"ACTIVE",currency:t,amount:e,date:firebase.firestore.Timestamp.fromDate(o),address:`Traspaso de saldo sobrante del periodo filtrado (${r} ${a}).`,createdAt:new Date,createdBy:E.currentUser.uid}),s++)};if(n(e.ars,"ARS"),n(e.usd,"USD"),0<s)try{await i.commit(),Swal.fire("¡Éxito!","Excedente capitalizado correctamente.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo realizar el traspaso.","error")}})(e,n,a,r)},window.toggleStatus=function(e,t){y.collection("transactions").doc(e).update({status:t})},window.deleteTransaction=async function(e){if((await Swal.fire({title:"¿Eliminar?",text:"No podrás revertir esto.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#f46a6a",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{await y.collection("transactions").doc(e).delete(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Eliminado correctamente.",showConfirmButton:!1,timer:2e3})}catch(e){console.error("Error al eliminar:",e),Swal.fire("Error","No se pudo eliminar: "+e.message,"error")}},window.editSaving=function(t){var e=u.find(e=>e.id===t);e&&i("SAVING",e)},window.convertSaving=async function(t){var e=u.find(e=>e.id===t);if(e){e=(await Swal.fire({title:"Mover a Gasto",text:"Ingresa el nombre del Proveedor/Entidad para este gasto:",input:"text",inputValue:e.entityName,showCancelButton:!0,confirmButtonText:"Convertir"})).value;if(e)try{await y.collection("transactions").doc(t).update({type:"EXPENSE",entityName:e,status:"PAID"}),Swal.fire("Éxito","Ahorro convertido en gasto correctamente.","success")}catch(e){console.error(e),Swal.fire("Error",e.message,"error")}}},window.useSavingForExpense=window.convertSaving;let L=[],C=new bootstrap.Modal(document.getElementById("agreement-modal")),k=document.getElementById("form-agreement");async function O(){y.collection("cashflow_agreements").where("isActive","!=",!1).onSnapshot(e=>{L=[],e.forEach(e=>L.push({id:e.id,...e.data()})),M(),T(),(async()=>{var e,t=new Date,n=t.getFullYear()+"-"+(t.getMonth()+1).toString().padStart(2,"0");let a=0;for(e of L.filter(e=>"MONTHLY"===e.frequency&&!1===e.hasInvoice))if(!(e.invoices&&e.invoices[n]&&e.invoices[n].sent))try{var r={type:"INCOME",entityName:e.name,cuit:e.cuit,address:"Cobro Recurrente Automático",category:"Honorarios",status:"PENDING",currency:e.currency,amount:e.amount,date:firebase.firestore.Timestamp.fromDate(new Date),isRecurring:!1,agreementId:e.id,periodKey:n,createdAt:new Date,createdBy:"SYSTEM"},o=await y.collection("transactions").add(r),i={};i["invoices."+n]={sent:!0,date:(new Date).toISOString().split("T")[0],incomeId:o.id},await y.collection("cashflow_agreements").doc(e.id).update(i),console.log("Auto-generated income for agreement: "+e.name),a++}catch(e){console.error("Error auto-generating agreement income:",e)}0<a&&Swal.fire({toast:!0,position:"top-end",icon:"info",title:a+" Ingresos recurrentes generados automáticamente.",showConfirmButton:!1,timer:4e3})})()})}function M(){let n=document.querySelector("#table-agreements tbody");n.innerHTML="",0===L.length?n.innerHTML='<tr><td colspan="7" class="text-center text-muted">No hay acuerdos registrados.</td></tr>':L.forEach(e=>{var t=m(e.amount,e.currency);n.innerHTML+=`
                <tr>
                    <td>
                        <h6 class="mb-0 text-truncate font-size-14">${e.name}</h6>
                        <small class="text-muted">${e.biller||"-"}</small>
                    </td>
                    <td>${e.cuit||"-"}</td>
                    <td>${e.description||"-"}</td>
                    <td><span class="badge ${"MONTHLY"===e.frequency?"bg-info":"bg-secondary"}">${"MONTHLY"===e.frequency?"Mensual":"Único"}</span></td>
                    <td class="fw-bold">${t}</td>
                    <td>${e.lastUpdate||"-"}</td>
                    <td>
                        <button class="btn btn-sm btn-soft-primary" onclick="editAgreement('${e.id}')"><i class="mdi mdi-pencil"></i></button>
                    </td>
                </tr>
            `})}function T(){let o=document.getElementById("monthly-control-list");o.innerHTML="";var e=L.filter(e=>"MONTHLY"===e.frequency);if(0===e.length)o.innerHTML='<tr><td colspan="4" class="text-center text-muted">No hay acuerdos mensuales activos.</td></tr>';else{var t=new Date;let r=t.getFullYear()+"-"+(t.getMonth()+1).toString().padStart(2,"0");e.forEach(e=>{var t=m(e.amount,e.currency);let n=!1;e.invoices&&e.invoices[r]&&e.invoices[r].sent&&(n=!0,e.invoices[r].date);var a=`
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="check-invoice-${e.id}" ${n?"checked":""} onchange="toggleInvoiceSent('${e.id}', '${r}', this)">
                    <label class="form-check-label text-muted small" for="check-invoice-${e.id}">${n?"Enviada":"Pendiente"}</label>
                </div>
            `;o.innerHTML+=`
                <tr class="${n?"bg-success-subtle":""}">
                    <td><strong>${e.name}</strong></td>
                    <td>${t}</td>
                    <td>${e.biller||"S/D"}</td>
                    <td>${a}</td>
                </tr>
            `})}}E.currentUser&&O(),document.getElementById("btn-new-agreement").addEventListener("click",()=>{k.reset(),document.getElementById("agreement-id").value="",document.getElementById("agreement-modal-title").textContent="Nuevo Acuerdo",document.getElementById("btn-delete-agreement").classList.add("d-none"),document.getElementById("agr-last-update").textContent=(new Date).toISOString().split("T")[0],document.getElementById("agr-biller").value="Lucre",document.getElementById("div-biller").style.display="block",document.getElementById("agr-currency").value="ARS",document.getElementById("agr-frequency").value="MONTHLY",document.getElementById("agr-hasInvoice").value="true",C.show()}),document.getElementById("agr-hasInvoice").addEventListener("change",e=>{var t=document.getElementById("div-biller"),n=document.getElementById("agr-biller");"true"===e.target.value?(t.style.display="block",n.value="Lucre"):(t.style.display="none",n.value="")}),window.editAgreement=function(t){var e=L.find(e=>e.id===t);e&&(document.getElementById("agreement-id").value=t,document.getElementById("agreement-modal-title").textContent="Editar Acuerdo",document.getElementById("agr-name").value=e.name,document.getElementById("agr-cuit").value=e.cuit||"",document.getElementById("agr-hasInvoice").value=e.hasInvoice?"true":"false",e.hasInvoice?(document.getElementById("div-biller").style.display="block",document.getElementById("agr-biller").value=e.biller||"Lucre"):(document.getElementById("div-biller").style.display="none",document.getElementById("agr-biller").value=""),document.getElementById("agr-desc").value=e.description||"",document.getElementById("agr-frequency").value=e.frequency||"MONTHLY",document.getElementById("agr-currency").value=e.currency||"ARS",document.getElementById("agr-amount").value=e.amount,document.getElementById("agr-last-update").textContent=e.lastUpdate||"-",document.getElementById("btn-delete-agreement").classList.remove("d-none"),C.show())},k.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("agreement-id").value,t=document.getElementById("btn-save-agreement");t.disabled=!0,t.innerHTML='<i class="bx bx-loader bx-spin"></i>';try{var n={name:document.getElementById("agr-name").value,cuit:document.getElementById("agr-cuit").value,hasInvoice:"true"===document.getElementById("agr-hasInvoice").value,biller:document.getElementById("agr-biller").value,description:document.getElementById("agr-desc").value,frequency:document.getElementById("agr-frequency").value,currency:document.getElementById("agr-currency").value,amount:parseFloat(document.getElementById("agr-amount").value)||0,lastUpdate:document.getElementById("agr-last-update").textContent,isActive:!0,updatedAt:new Date};e?await y.collection("cashflow_agreements").doc(e).update(n):(n.createdAt=new Date,n.invoices={},await y.collection("cashflow_agreements").add(n)),C.hide(),Swal.fire("Guardado","El acuerdo se actualizó correctamente.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar: "+e.message,"error")}finally{t.disabled=!1,t.textContent="Guardar Acuerdo"}}),document.getElementById("btn-delete-agreement").addEventListener("click",async()=>{let t=document.getElementById("agreement-id").value;t&&Swal.fire({title:"¿Archivar Acuerdo?",text:"No aparecerá en los listados activos.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, archivar",cancelButtonText:"Cancelar"}).then(async e=>{e.isConfirmed&&(await y.collection("cashflow_agreements").doc(t).update({isActive:!1}),C.hide())})}),document.getElementById("btn-calc-update").addEventListener("click",()=>{let e=document.getElementById("agr-amount");var t=document.getElementById("agr-calc-percent"),n=document.getElementById("agr-last-update"),a=parseFloat(e.value)||0,r=parseFloat(t.value)||0;0!==r&&(e.value=(a+a*(r/100)).toFixed(2),n.textContent=(new Date).toISOString().split("T")[0],e.classList.add("is-valid"),setTimeout(()=>e.classList.remove("is-valid"),2e3),t.value="")}),window.toggleInvoiceSent=async function(t,e,n){var a=n.checked,r=L.find(e=>e.id===t);if(r)try{var o=y.collection("cashflow_agreements").doc(t);if(a){var i={type:"INCOME",entityName:r.name,cuit:r.cuit,address:"Facturación Mensual Automática",category:"Honorarios",status:"PENDING",currency:r.currency,amount:r.amount,date:firebase.firestore.Timestamp.fromDate(new Date),isRecurring:!1,agreementId:t,periodKey:e,createdAt:new Date,createdBy:E.currentUser.uid},c=await y.collection("transactions").add(i),s={};s["invoices."+e]={sent:!0,date:(new Date).toISOString().split("T")[0],incomeId:c.id},await o.update(s),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Ingreso generado y Factura marcada.",showConfirmButton:!1,timer:3e3})}else{var d=r.invoices?r.invoices[e]:null;if(d&&d.incomeId){if(!(await Swal.fire({title:"¿Deshacer?",text:"Esto borrará el ingreso generado automáticamente.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, borrar ingreso"})).isConfirmed)return void(n.checked=!0);await y.collection("transactions").doc(d.incomeId).delete()}var l={};l["invoices."+e]=firebase.firestore.FieldValue.delete(),await o.update(l)}}catch(e){console.error(e),n.checked=!a,Swal.fire("Error",e.message,"error")}else n.checked=!a}});