document.addEventListener("DOMContentLoaded",function(){let u=window.Imala.db,m=window.Imala.auth,l=(m.onAuthStateChanged(e=>{e?((async()=>{var t=["Alquiler","Expensas","Servicios","Honorarios","Ventas","Otros"];c=[];try{let n=u.collection("cashflow_categories");var e=await n.orderBy("createdAt","asc").get();let a=new Set,r=(e.forEach(e=>{e=e.data();a.add(e.name),!1!==e.active&&c.push(e.name)}),u.batch()),o=!1;t.forEach(e=>{var t;a.has(e)||(t=n.doc(),r.set(t,{name:e,active:!0,createdAt:new Date,createdBy:"SYSTEM"}),c.push(e),a.add(e),o=!0)}),o&&(await r.commit(),console.log("Default categories migrated to Firestore.")),c.sort()}catch(e){console.error("Error loading/migrating categories:",e),0===c.length&&(c=[...t])}n()})(),(async()=>{let n=document.getElementById("list-entities");n.innerHTML="",s=[];try{(await u.collection("cashflow_entities").orderBy("name").get()).forEach(e=>{var t,e=e.data().name;s.includes(e)||(s.push(e),(t=document.createElement("option")).value=e,n.appendChild(t))})}catch(e){console.error("Error loading entities",e)}})(),u.collection("transactions").onSnapshot(e=>{p=[],e.forEach(e=>p.push({id:e.id,...e.data()})),(async e=>{let n=e.filter(e=>e.isRecurring&&!e.parentRecurringId),a=new Date,r=(a.getFullYear(),a.getMonth(),0);for(let t of n){var o,c;e.find(e=>e.parentRecurringId===t.id&&I(e.date).getMonth()===a.getMonth()&&I(e.date).getFullYear()===a.getFullYear())||(o=new Date(a.getFullYear(),a.getMonth(),1),delete(c={...t}).id,delete c.createdAt,c.isRecurring=!1,c.parentRecurringId=t.id,c.status="PENDING",c.date=o,c.createdAt=new Date,c.description=`${t.address||""} (Recurrente Mes ${a.getMonth()+1})`,console.log("Generating recurring tx for",t.entityName),await u.collection("transactions").add(c),r++)}0<r&&console.log(`Generated ${r} recurring transactions.`)})(p),E()}),N()):window.location.href="auth-login.html"}),new bootstrap.Modal(document.getElementById("transaction-modal"))),p=[],c=[],s=[],b=(e,t)=>new Intl.NumberFormat("es-AR",{style:"currency",currency:t}).format(e),I=e=>e?e.seconds?new Date(1e3*e.seconds):new Date(e):null;function n(){let t=document.getElementById("tx-category"),n=(t.innerHTML='<option value="">Seleccione...</option>',c.forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}),document.getElementById("filter-category"));var e=n.value;n.innerHTML='<option value="ALL">Todas</option>',c.forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`}),e&&(n.value=e)}let a=document.getElementById("container-new-category"),r=document.getElementById("input-new-category"),e=(document.getElementById("btn-add-category").addEventListener("click",()=>{a.style.display="block",r.focus()}),document.getElementById("btn-cancel-new-cat").addEventListener("click",()=>{a.style.display="none",r.value=""}),document.getElementById("btn-save-new-cat").addEventListener("click",async()=>{var e=r.value.trim();if(e)try{var t=document.getElementById("btn-save-new-cat");t.innerHTML='<i class="bx bx-loader bx-spin"></i>',t.disabled=!0,await u.collection("cashflow_categories").add({name:e,active:!0,createdAt:new Date,createdBy:m.currentUser.uid}),c.push(e),n(),document.getElementById("tx-category").value=e,a.style.display="none",r.value=""}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar la categoría.","error")}finally{t=document.getElementById("btn-save-new-cat");t.innerHTML='<i class="mdi mdi-check"></i>',t.disabled=!1}}),new bootstrap.Modal(document.getElementById("modal-manage-categories")));async function o(){let n=document.querySelector("#table-manage-categories tbody");n.innerHTML="<tr><td>Cargando...</td></tr>";try{await u.collection("cashflow_categories").where("active","!=",!1).get();var e=await u.collection("cashflow_categories").orderBy("createdAt","desc").get();n.innerHTML="",e.forEach(e=>{var t=e.data();!1!==t.active&&(n.innerHTML+=`
                    <tr>
                        <td class="align-middle">${t.name}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-soft-danger" onclick="softDeleteCategory('${e.id}', '${t.name}')">
                                <i class="mdi mdi-trash-can-outline"></i>
                            </button>
                        </td>
                    </tr>
                 `)}),""===n.innerHTML&&(n.innerHTML='<tr><td colspan="2" class="text-center text-muted">No hay categorías personalizadas.</td></tr>')}catch(e){console.error(e),n.innerHTML="<tr><td>Error al cargar.</td></tr>"}}document.getElementById("btn-manage-categories").addEventListener("click",async()=>{o(),e.show()}),window.softDeleteCategory=async function(e,t){confirm(`¿Eliminar "${t}" del selector?`)&&(await u.collection("cashflow_categories").doc(e).update({active:!1}),c=c.filter(e=>e!==t),n(),o())};let i=document.getElementById("form-transaction");var d=document.getElementById("btn-new-income"),g=document.getElementById("btn-new-expense"),y=document.getElementById("btn-new-saving");function v(e){i.reset();let t="",n="";"INCOME"===(document.getElementById("tx-type").value=e)?(t="Registrar Ingreso",n="Cliente / Entidad"):"EXPENSE"===e?(t="Registrar Gasto",n="Proveedor / Entidad"):"SAVING"===e&&(t="Registrar Ahorro",n="Nombre del Ahorro / Meta"),document.getElementById("transactionModalLabel").textContent=t,document.getElementById("label-entity").textContent=n,document.getElementById("tx-date").valueAsDate=new Date,l.show()}d.addEventListener("click",()=>v("INCOME")),g.addEventListener("click",()=>v("EXPENSE")),y.addEventListener("click",()=>v("SAVING")),i.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("btn-save-tx"),t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i> Guardando...';try{var n=document.getElementById("tx-type").value,a=(document.getElementById("tx-id").value,document.getElementById("tx-entity-name").value);let e="OTHER";"INCOME"===n?e="CLIENT":"EXPENSE"===n&&(e="PROVIDER");var r=a,o=e;if(r&&!s.some(e=>e.toLowerCase()===r.toLowerCase()))try{await u.collection("cashflow_entities").add({name:r,type:o,createdAt:new Date,createdBy:m.currentUser.uid}),s.push(r);var c=document.getElementById("list-entities"),i=document.createElement("option");i.value=r,c.appendChild(i),console.log(`New entity ${r} saved.`)}catch(e){console.error("Error auto-saving entity",e)}await 0;var d={type:n,entityName:a,cuit:document.getElementById("tx-cuit").value,address:document.getElementById("tx-address").value,category:document.getElementById("tx-category").value,status:document.getElementById("tx-status").value,currency:document.getElementById("tx-currency").value,amount:parseFloat(document.getElementById("tx-amount").value),date:firebase.firestore.Timestamp.fromDate(document.getElementById("tx-date").valueAsDate),isRecurring:document.getElementById("tx-recurring").checked,createdAt:new Date,createdBy:m.currentUser.uid};await u.collection("transactions").add(d),l.hide(),Swal.fire("Guardado","Movimiento registrado correctamente.","success")}catch(e){console.error(e),Swal.fire("Error",e.message,"error")}finally{e.disabled=!1,e.innerHTML=t}});let h=document.getElementById("filter-year"),w=document.getElementById("filter-period"),B=document.getElementById("filter-search"),x=document.getElementById("filter-category");d=document.getElementById("btn-apply-filters"),g=new Date;let t=g.getFullYear();y=(g.getMonth()+1).toString().padStart(2,"0");function E(){let e=[...p],t=parseInt(h.value),n=w.value,a=B.value.toLowerCase(),r=x.value;if(e=e.filter(e=>I(e.date).getFullYear()===t),"YTD"===n){let t=new Date;e=e.filter(e=>I(e.date)<=t)}else"ALL"!==n&&(e=e.filter(e=>{e=I(e.date).getMonth()+1;return"Q1"===n?1<=e&&e<=3:"Q2"===n?4<=e&&e<=6:"Q3"===n?7<=e&&e<=9:"Q4"===n?10<=e&&e<=12:"S1"===n?1<=e&&e<=6:"S2"===n?7<=e&&e<=12:e===parseInt(n)}));var o,c,i,d,l,s,u,m,g,y,v,E;"ALL"!==r&&(e=e.filter(e=>e.category===r)),a&&(e=e.filter(e=>e.entityName.toLowerCase().includes(a)||e.address&&e.address.toLowerCase().includes(a))),f=e,o=f.filter(e=>"INCOME"===e.type),c=o.reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),i=o.reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),d=o.filter(e=>"PAID"!==e.status).reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),l=o.filter(e=>"PAID"!==e.status).reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),s=f.filter(e=>"EXPENSE"===e.type),u=s.reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),m=s.reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),g=s.filter(e=>"PAID"!==e.status).reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),y=s.filter(e=>"PAID"!==e.status).reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),f=f.filter(e=>"SAVING"===e.type),v=o.filter(e=>"PAID"===e.status).reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),o=o.filter(e=>"PAID"===e.status).reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),E=s.filter(e=>"PAID"===e.status).reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),s=s.filter(e=>"PAID"===e.status).reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),v-=E,E=o-s,o=f.filter(e=>"USED"!==e.status).reduce((e,t)=>"ARS"===t.currency?e+t.amount:e,0),s=f.filter(e=>"USED"!==e.status).reduce((e,t)=>"USD"===t.currency?e+t.amount:e,0),L("kpi-balance-ars",v),L("kpi-balance-usd",E),L("kpi-savings-ars",o),L("kpi-savings-usd",s),L("kpi-income-expected-ars",c),L("kpi-income-expected-usd",i),L("kpi-income-pending-ars",d),L("kpi-income-pending-usd",l),L("kpi-expense-expected-ars",u),L("kpi-expense-expected-usd",m),L("kpi-expense-pending-ars",g),L("kpi-expense-pending-usd",y);{var f=e;let t=document.querySelector("#table-income tbody"),n=document.querySelector("#table-expense tbody"),a=document.querySelector("#table-saving tbody"),r=(t.innerHTML="",n.innerHTML="",a.innerHTML="",(e,t=!1)=>{var n=I(e.date).toLocaleDateString(),a=b(e.amount,e.currency);let r="badge bg-warning text-dark",o="Pendiente";return"PAID"===e.status&&(r="badge bg-success",o="Cobrado/Pagado"),"USED"===e.status&&(r="badge bg-secondary",o="Usado"),t?`
                    <tr>
                        <td>${n}</td>
                        <td>
                            <h6 class="mb-0 font-size-14 text-truncate">${e.entityName}</h6>
                        </td>
                        <td><span class="badge badge-soft-primary">${e.category}</span></td>
                        <td>${e.address||"-"}</td>
                        <td>${"ARS"===e.currency?a:"-"}</td>
                        <td>${"USD"===e.currency?a:"-"}</td>
                        <td><div class="${r}">${o}</div></td>
                        <td>
                            <div class="d-flex gap-2">
                                ${"USED"!==e.status?`<button class="btn btn-sm btn-info" onclick="useSavingForExpense('${e.id}')" title="Usar para Gasto"><i class="mdi mdi-arrow-right-bold-circle-outline"></i> Mover a Gasto</button>`:""}
                                <button class="btn btn-sm btn-soft-danger" onclick="deleteTransaction('${e.id}')"><i class="mdi mdi-trash-can"></i></button>
                            </div>
                        </td>
                    </tr>
                 `:(t="PENDING"===e.status?`<button class="btn btn-sm btn-soft-success" onclick="toggleStatus('${e.id}', 'PAID')" title="Marcar como Completado"><i class="bx bx-check"></i></button>`:`<button class="btn btn-sm btn-soft-warning" onclick="toggleStatus('${e.id}', 'PENDING')" title="Marcar Pendiente"><i class="bx bx-undo"></i></button>`,`
                <tr>
                    <td>${n}</td>
                    <td>
                        <h6 class="mb-0 font-size-14 text-truncate">${e.entityName}</h6>
                        <small class="text-muted text-truncate">${e.cuit||"-"}</small>
                    </td>
                    <td><span class="badge badge-soft-primary">${e.category}</span></td>
                    <td>${e.address||"-"}</td>
                    <td>${"ARS"===e.currency?a:"-"}</td>
                    <td>${"USD"===e.currency?a:"-"}</td>
                    <td>${e.isRecurring?'<i class="bx bx-revision text-primary"></i>':"-"}</td>
                    <td><div class="${r}">${o}</div></td>
                    <td>
                        <div class="d-flex gap-2">
                            ${t}
                            <button class="btn btn-sm btn-soft-danger" onclick="deleteTransaction('${e.id}')"><i class="mdi mdi-trash-can"></i></button>
                        </div>
                    </td>
                </tr>
            `)});f.filter(e=>"INCOME"===e.type).forEach(e=>{t.innerHTML+=r(e,!1)}),f.filter(e=>"EXPENSE"===e.type).forEach(e=>{n.innerHTML+=r(e,!1)}),f.filter(e=>"SAVING"===e.type).forEach(e=>{a.innerHTML+=r(e,!0)})}$(),S()}[...h.options].some(e=>e.value==t)||((g=document.createElement("option")).value=t,g.textContent=t,h.appendChild(g)),h.value=t,w.value=y,d.addEventListener("click",E),[h,w,x].forEach(e=>e.addEventListener("change",E));{let t=(g=new Date).getFullYear();var f,g=(g.getMonth()+1).toString().padStart(2,"0"),y=document.getElementById("filter-year"),d=document.getElementById("filter-period");y&&d&&([...y.options].some(e=>e.value==t)||((f=document.createElement("option")).value=t,f.textContent=t,y.appendChild(f)),y.value=t,d.value=g)}function S(){let r=document.querySelector("#table-agreements tbody"),d=(r.innerHTML="",document.getElementById("filter-period").value),l=document.getElementById("filter-year").value;let o=!!{"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[d];0===D.length?r.innerHTML='<tr><td colspan="7" class="text-center text-muted">No hay acuerdos registrados.</td></tr>':D.forEach(i=>{var e=b(i.amount,i.currency);let t="";if(o){var n=l+"-"+d,a=i.invoices&&i.invoices[n]&&i.invoices[n].sent;t=`
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="list-invoice-${i.id}" ${a?"checked":""} onchange="toggleInvoiceSent('${i.id}', '${n}', this)">
                        <label class="form-check-label text-muted small" for="list-invoice-${i.id}">${a?i.hasInvoice?"ENVIADA":"GENERADO":i.hasInvoice?"NO ENVIADA":"PENDIENTE"}</label>
                    </div>
                `}else{let o=0,c=0;i.invoices&&Object.keys(i.invoices).forEach(t=>{var[n,a]=t.split("-");if(n===l){var r,a=parseInt(a);let e=!1;"ALL"===d?e=!0:"YTD"===d?(r=new Date,new Date(parseInt(n),a-1,1)<=r&&(e=!0)):"Q1"===d?e=1<=a&&a<=3:"Q2"===d?e=4<=a&&a<=6:"Q3"===d?e=7<=a&&a<=9:"Q4"===d?e=10<=a&&a<=12:"S1"===d?e=1<=a&&a<=6:"S2"===d&&(e=7<=a&&a<=12),e&&i.invoices[t].sent&&(c++,o+=i.amount)}}),t=0<c?`<span class="badge bg-success-subtle text-success font-size-12 p-2">${c} Gen. (${b(o,i.currency)})</span>`:'<span class="text-muted small">-</span>'}r.innerHTML+=`
                <tr>
                    <td>
                        <h6 class="mb-0 text-truncate font-size-14">${i.name}</h6>
                        <small class="text-muted d-block d-lg-none">${i.description||"-"}</small>
                    </td>
                    <td class="d-none d-lg-table-cell">
                        <small class="d-block text-muted">${i.description||"-"}</small>
                        <small class="d-block code">${i.cuit||""}</small>
                    </td>
                    <td class="fw-bold">${e}</td>
                    <td>${i.hasInvoice?i.biller||"-":'<span class="text-muted font-size-11 fst-italic">No Factura</span>'}</td>
                    <td>${t}</td>
                    <td>
                        <button class="btn btn-sm btn-soft-primary" onclick="editAgreement('${i.id}')"><i class="mdi mdi-pencil"></i></button>
                    </td>
                </tr>
            `})}function $(){let r=document.getElementById("monthly-control-list");r.innerHTML="";var e=document.getElementById("filter-period").value,t=document.getElementById("filter-year").value,n={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"};let o="",a="";a=n[e]?(o=t+"-"+e,n[e]+" "+t):(t=((e=new Date).getMonth()+1).toString().padStart(2,"0"),o=e.getFullYear()+"-"+t,`${n[t]} ${e.getFullYear()} (Actual)`);n=D.filter(e=>"MONTHLY"===e.frequency&&!0===e.hasInvoice);0===n.length?r.innerHTML='<tr><td colspan="4" class="text-center text-muted">No hay clientes con factura mensual activos.</td></tr>':(document.querySelector("#card-monthly-control .card-title").innerHTML='<i class="mdi mdi-playlist-check me-1"></i> Control de Facturación: '+a,n.forEach(e=>{var t=b(e.amount,e.currency);let n=!1;e.invoices&&e.invoices[o]&&e.invoices[o].sent&&(n=!0);var a=`
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="ctrl-invoice-${e.id}" ${n?"checked":""} onchange="toggleInvoiceSent('${e.id}', '${o}', this)">
                    <label class="form-check-label text-muted small" for="ctrl-invoice-${e.id}">${n?"ENVIADA":"NO ENVIADA"}</label>
                </div>
             `;r.innerHTML+=`
                <tr class="${n?"bg-success-subtle":""}">
                    <td><strong>${e.name}</strong></td>
                    <td>${t}</td>
                    <td>${e.biller||"-"}</td>
                    <td>${a}</td>
                </tr>
             `}))}function L(e,t){document.getElementById(e).textContent=new Intl.NumberFormat("es-AR").format(t)}window.toggleStatus=function(e,t){u.collection("transactions").doc(e).update({status:t})},window.deleteTransaction=function(t){Swal.fire({title:"¿Eliminar?",text:"No podrás revertir esto.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#f46a6a",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&u.collection("transactions").doc(t).delete()})},window.useSavingForExpense=async function(t){let n=p.find(e=>e.id===t);n&&Swal.fire({title:"¿Mover Ahorro a Gasto?",text:`Esto convertirá el ahorro "${n.entityName}" en un Gasto.`,icon:"question",showCancelButton:!0,confirmButtonText:"Sí, convertir",cancelButtonText:"Cancelar"}).then(async e=>{e.isConfirmed&&(v("EXPENSE"),setTimeout(()=>{document.getElementById("tx-amount").value=n.amount,document.getElementById("tx-currency").value=n.currency,document.getElementById("tx-entity-name").value=n.entityName+" (Pago con Ahorro)",document.getElementById("tx-category").value=n.category},200),i.dataset.originSavingId=t,document.getElementById("tx-entity-name").value=n.entityName,document.getElementById("tx-amount").value=n.amount,document.getElementById("tx-currency").value=n.currency,Swal.fire("Listo","Completa los datos del nuevo gasto.","info"))})};i.onsubmit;window.convertSaving=async function(t){var e=p.find(e=>e.id===t);if(e){e=(await Swal.fire({title:"Mover a Gasto",text:"Ingresa el nombre del Proveedor/Entidad para este gasto:",input:"text",inputValue:e.entityName,showCancelButton:!0,confirmButtonText:"Convertir"})).value;if(e)try{await u.collection("transactions").doc(t).update({type:"EXPENSE",entityName:e,status:"PAID"}),Swal.fire("Éxito","Ahorro convertido en gasto correctamente.","success")}catch(e){console.error(e),Swal.fire("Error",e.message,"error")}}},window.useSavingForExpense=window.convertSaving;let D=[],M=new bootstrap.Modal(document.getElementById("agreement-modal")),A=document.getElementById("form-agreement");async function N(){u.collection("cashflow_agreements").where("isActive","!=",!1).onSnapshot(e=>{D=[],e.forEach(e=>D.push({id:e.id,...e.data()})),S(),$(),(async()=>{var e,t=new Date,n=t.getFullYear()+"-"+(t.getMonth()+1).toString().padStart(2,"0");let a=0;for(e of D.filter(e=>"MONTHLY"===e.frequency&&!1===e.hasInvoice))if(!(e.invoices&&e.invoices[n]&&e.invoices[n].sent))try{var r={type:"INCOME",entityName:e.name,cuit:e.cuit,address:"Cobro Recurrente Automático",category:"Honorarios",status:"PENDING",currency:e.currency,amount:e.amount,date:firebase.firestore.Timestamp.fromDate(new Date),isRecurring:!1,agreementId:e.id,periodKey:n,createdAt:new Date,createdBy:"SYSTEM"},o=await u.collection("transactions").add(r),c={};c["invoices."+n]={sent:!0,date:(new Date).toISOString().split("T")[0],incomeId:o.id},await u.collection("cashflow_agreements").doc(e.id).update(c),console.log("Auto-generated income for agreement: "+e.name),a++}catch(e){console.error("Error auto-generating agreement income:",e)}0<a&&Swal.fire({toast:!0,position:"top-end",icon:"info",title:a+" Ingresos recurrentes generados automáticamente.",showConfirmButton:!1,timer:4e3})})()})}function S(){let n=document.querySelector("#table-agreements tbody");n.innerHTML="",0===D.length?n.innerHTML='<tr><td colspan="7" class="text-center text-muted">No hay acuerdos registrados.</td></tr>':D.forEach(e=>{var t=b(e.amount,e.currency);n.innerHTML+=`
                <tr>
                    <td>
                        <h6 class="mb-0 text-truncate font-size-14">${e.name}</h6>
                        <small class="text-muted">${e.biller||"-"}</small>
                    </td>
                    <td>${e.cuit||"-"}</td>
                    <td>${e.description||"-"}</td>
                    <td><span class="badge ${"MONTHLY"===e.frequency?"bg-info":"bg-secondary"}">${"MONTHLY"===e.frequency?"Mensual":"Único"}</span></td>
                    <td class="fw-bold">${t}</td>
                    <td>${e.lastUpdate||"-"}</td>
                    <td>
                        <button class="btn btn-sm btn-soft-primary" onclick="editAgreement('${e.id}')"><i class="mdi mdi-pencil"></i></button>
                    </td>
                </tr>
            `})}function $(){let o=document.getElementById("monthly-control-list");o.innerHTML="";var e=D.filter(e=>"MONTHLY"===e.frequency);if(0===e.length)o.innerHTML='<tr><td colspan="4" class="text-center text-muted">No hay acuerdos mensuales activos.</td></tr>';else{var t=new Date;let r=t.getFullYear()+"-"+(t.getMonth()+1).toString().padStart(2,"0");e.forEach(e=>{var t=b(e.amount,e.currency);let n=!1;e.invoices&&e.invoices[r]&&e.invoices[r].sent&&(n=!0,e.invoices[r].date);var a=`
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="check-invoice-${e.id}" ${n?"checked":""} onchange="toggleInvoiceSent('${e.id}', '${r}', this)">
                    <label class="form-check-label text-muted small" for="check-invoice-${e.id}">${n?"Enviada":"Pendiente"}</label>
                </div>
            `;o.innerHTML+=`
                <tr class="${n?"bg-success-subtle":""}">
                    <td><strong>${e.name}</strong></td>
                    <td>${t}</td>
                    <td>${e.biller||"S/D"}</td>
                    <td>${a}</td>
                </tr>
            `})}}m.currentUser&&N(),document.getElementById("btn-new-agreement").addEventListener("click",()=>{A.reset(),document.getElementById("agreement-id").value="",document.getElementById("agreement-modal-title").textContent="Nuevo Acuerdo",document.getElementById("btn-delete-agreement").classList.add("d-none"),document.getElementById("agr-last-update").textContent=(new Date).toISOString().split("T")[0],document.getElementById("agr-biller").value="Lucre",document.getElementById("div-biller").style.display="block",document.getElementById("agr-currency").value="ARS",document.getElementById("agr-frequency").value="MONTHLY",document.getElementById("agr-hasInvoice").value="true",M.show()}),document.getElementById("agr-hasInvoice").addEventListener("change",e=>{var t=document.getElementById("div-biller"),n=document.getElementById("agr-biller");"true"===e.target.value?(t.style.display="block",n.value="Lucre"):(t.style.display="none",n.value="")}),window.editAgreement=function(t){var e=D.find(e=>e.id===t);e&&(document.getElementById("agreement-id").value=t,document.getElementById("agreement-modal-title").textContent="Editar Acuerdo",document.getElementById("agr-name").value=e.name,document.getElementById("agr-cuit").value=e.cuit||"",document.getElementById("agr-hasInvoice").value=e.hasInvoice?"true":"false",e.hasInvoice?(document.getElementById("div-biller").style.display="block",document.getElementById("agr-biller").value=e.biller||"Lucre"):(document.getElementById("div-biller").style.display="none",document.getElementById("agr-biller").value=""),document.getElementById("agr-desc").value=e.description||"",document.getElementById("agr-frequency").value=e.frequency||"MONTHLY",document.getElementById("agr-currency").value=e.currency||"ARS",document.getElementById("agr-amount").value=e.amount,document.getElementById("agr-last-update").textContent=e.lastUpdate||"-",document.getElementById("btn-delete-agreement").classList.remove("d-none"),M.show())},A.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("agreement-id").value,t=document.getElementById("btn-save-agreement");t.disabled=!0,t.innerHTML='<i class="bx bx-loader bx-spin"></i>';try{var n={name:document.getElementById("agr-name").value,cuit:document.getElementById("agr-cuit").value,hasInvoice:"true"===document.getElementById("agr-hasInvoice").value,biller:document.getElementById("agr-biller").value,description:document.getElementById("agr-desc").value,frequency:document.getElementById("agr-frequency").value,currency:document.getElementById("agr-currency").value,amount:parseFloat(document.getElementById("agr-amount").value)||0,lastUpdate:document.getElementById("agr-last-update").textContent,isActive:!0,updatedAt:new Date};e?await u.collection("cashflow_agreements").doc(e).update(n):(n.createdAt=new Date,n.invoices={},await u.collection("cashflow_agreements").add(n)),M.hide(),Swal.fire("Guardado","El acuerdo se actualizó correctamente.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar: "+e.message,"error")}finally{t.disabled=!1,t.textContent="Guardar Acuerdo"}}),document.getElementById("btn-delete-agreement").addEventListener("click",async()=>{let t=document.getElementById("agreement-id").value;t&&Swal.fire({title:"¿Archivar Acuerdo?",text:"No aparecerá en los listados activos.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, archivar",cancelButtonText:"Cancelar"}).then(async e=>{e.isConfirmed&&(await u.collection("cashflow_agreements").doc(t).update({isActive:!1}),M.hide())})}),document.getElementById("btn-calc-update").addEventListener("click",()=>{let e=document.getElementById("agr-amount");var t=document.getElementById("agr-calc-percent"),n=document.getElementById("agr-last-update"),a=parseFloat(e.value)||0,r=parseFloat(t.value)||0;0!==r&&(e.value=(a+a*(r/100)).toFixed(2),n.textContent=(new Date).toISOString().split("T")[0],e.classList.add("is-valid"),setTimeout(()=>e.classList.remove("is-valid"),2e3),t.value="")}),window.toggleInvoiceSent=async function(t,e,n){var a=n.checked,r=D.find(e=>e.id===t);if(r)try{var o=u.collection("cashflow_agreements").doc(t);if(a){var c={type:"INCOME",entityName:r.name,cuit:r.cuit,address:"Facturación Mensual Automática",category:"Honorarios",status:"PENDING",currency:r.currency,amount:r.amount,date:firebase.firestore.Timestamp.fromDate(new Date),isRecurring:!1,agreementId:t,periodKey:e,createdAt:new Date,createdBy:m.currentUser.uid},i=await u.collection("transactions").add(c),d={};d["invoices."+e]={sent:!0,date:(new Date).toISOString().split("T")[0],incomeId:i.id},await o.update(d),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Ingreso generado y Factura marcada.",showConfirmButton:!1,timer:3e3})}else{var l=r.invoices?r.invoices[e]:null;if(l&&l.incomeId){if(!(await Swal.fire({title:"¿Deshacer?",text:"Esto borrará el ingreso generado automáticamente.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, borrar ingreso"})).isConfirmed)return void(n.checked=!0);await u.collection("transactions").doc(l.incomeId).delete()}var s={};s["invoices."+e]=firebase.firestore.FieldValue.delete(),await o.update(s)}}catch(e){console.error(e),n.checked=!a,Swal.fire("Error",e.message,"error")}else n.checked=!a}});