document.addEventListener("DOMContentLoaded",function(){let p=window.Imala.db,g=window.Imala.auth,R=(g.onAuthStateChanged(e=>{e?((async()=>{let t=["Ventas","Honorarios","Otros"],c=["Alquiler","Expensas","Servicios","Sueldos","Impuestos","Otros"],n=["Fondo de Reserva","Inversión","Viajes","Bienes","Otros"];d={INCOME:[],EXPENSE:[],SAVING:[]};try{let a=p.collection("cashflow_categories");var e=await a.orderBy("createdAt","asc").get();let r={INCOME:new Set,EXPENSE:new Set,SAVING:new Set},o=p.batch(),i=!1;e.forEach(e=>{var t=e.data();let n=t.type;n||(n=c.includes(t.name)?"EXPENSE":"INCOME",o.update(e.ref,{type:n}),i=!0),r[n]||(r[n]=new Set),r[n].add(t.name),!1===t.active||d[n].includes(t.name)||d[n].push(t.name)});var s=(e,n)=>{e.forEach(e=>{var t;r[n].has(e)||(t=a.doc(),o.set(t,{name:e,type:n,active:!0,createdAt:new Date,createdBy:"SYSTEM"}),d[n].push(e),r[n].add(e),i=!0)})};s(t,"INCOME"),s(c,"EXPENSE"),s(n,"SAVING"),i&&(await o.commit(),console.log("Categorías sincronizadas y tipos actualizados permanentemente.")),d.INCOME.sort(),d.EXPENSE.sort(),d.SAVING.sort()}catch(e){console.error("Error loading categories:",e),0===d.INCOME.length&&(d.INCOME=[...t]),0===d.EXPENSE.length&&(d.EXPENSE=[...c]),0===d.SAVING.length&&(d.SAVING=[...n])}l("INCOME"),l("EXPENSE"),l("SAVING"),X()})(),(async()=>{let n=document.getElementById("list-entities-income"),r=document.getElementById("list-entities-expense");n&&(n.innerHTML=""),r&&(r.innerHTML=""),f={INCOME:[],EXPENSE:[]};try{(await p.collection("cashflow_entities").orderBy("name").get()).forEach(e=>{let a=e.data();var e=a.type||"BOTH",t=(e,t)=>{var n;e&&((n=document.createElement("option")).value=a.name,e.appendChild(n),f[t].includes(a.name)||f[t].push(a.name))};"CLIENT"!==e&&"BOTH"!==e||t(n,"INCOME"),"PROVIDER"!==e&&"BOTH"!==e||t(r,"EXPENSE")})}catch(e){console.error("Error loading entities",e)}})(),W(),ie(),p.collection("cashflow_accounts").where("uid","==",B()).onSnapshot(e=>{E=[],e.forEach(e=>E.push({id:e.id,...e.data()}));{let e=document.querySelectorAll(".select-account"),t=E.filter(e=>!1!==e.isActive);e.forEach(n=>{var e=n.value;n.innerHTML='<option value="">Seleccione cuenta...</option>',t.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name+` (${e.currency})`,n.appendChild(t)}),n.value=e})}{let n=document.getElementById("table-accounts-list");n.innerHTML="",E.forEach(e=>{var t;!1!==e.isActive&&((t=document.createElement("tr")).innerHTML=`
                <td>${e.name}</td>
                <td><span class="badge bg-soft-info text-info">${e.currency}</span></td>
                <td>${h(e.initialBalance,e.currency)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-soft-primary btn-edit-account" data-id="${e.id}"><i class="mdi mdi-pencil"></i></button>
                    <button class="btn btn-sm btn-soft-danger btn-delete-account" data-id="${e.id}"><i class="mdi mdi-trash-can"></i></button>
                </td>
            `,n.appendChild(t))}),n.querySelectorAll(".btn-edit-account").forEach(t=>{t.addEventListener("click",()=>{var e=E.find(e=>e.id===t.dataset.id);e&&(document.getElementById("acc-id").value=e.id,document.getElementById("acc-name").value=e.name,document.getElementById("acc-currency").value=e.currency,document.getElementById("acc-initial-balance").value=e.initialBalance,document.getElementById("title-account-form").textContent="Editar Cuenta")})}),n.querySelectorAll(".btn-delete-account").forEach(t=>{t.addEventListener("click",async()=>{var e=t.dataset.id;(await Swal.fire({title:"¿Eliminar cuenta?",text:"Se mantendrá el historial de movimientos pero no podrás usarla para nuevos registros.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, desactivar",cancelButtonText:"Cancelar"})).isConfirmed&&(await p.collection("cashflow_accounts").doc(e).update({isActive:!1,updatedAt:new Date}),Swal.fire("Desactivada","La cuenta ha sido desactivada.","success"))})})}de()}),console.log("Initializing Assets Module..."),p.collection("cashflow_assets").where("uid","==",B()).onSnapshot(e=>{b=[],e.forEach(e=>{b.push({id:e.id,...e.data()})}),console.log("Assets loaded:",b.length);{let c=document.getElementById("portfolio-grid");c&&(c.innerHTML="",0===b.length?c.innerHTML=`
                <div class="col-12 text-center text-muted py-5">
                    <i class="mdi mdi-briefcase-outline display-4"></i>
                    <p class="mt-3">Aún no tienes activos registrados.</p>
                    <button class="btn btn-sm btn-primary" onclick="window.document.getElementById('btn-new-asset').click()">Crear Primer Activo</button>
                </div>
            `:(b.forEach(e=>{var t=Number(e.currentValuation)||0,n=Number(e.investedAmount)||0,a=Number(e.targetAmount)||0;let r=0<a?n/a*100:100;100<r&&(r=100);var o=(e=>{switch(e){case"REAL_ESTATE":return"mdi mdi-office-building";case"CRYPTO":return"mdi mdi-bitcoin";case"STOCK":return"mdi mdi-trending-up";case"RESERVE_FUND":return"mdi mdi-safe";default:return"mdi mdi-briefcase"}})(e.type),i=document.createElement("div");i.className="col-md-6 col-xl-4",i.innerHTML=`
                <div class="card shadow-sm h-100 border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-3">
                                    <span class="avatar-title rounded-circle bg-light text-primary font-size-20">
                                        <i class="${o}"></i>
                                    </span>
                                </div>
                                <div>
                                    <h5 class="font-size-14 mb-1 text-truncate" style="max-width: 150px;" title="${e.name}">${e.name}</h5>
                                    <span class="text-muted font-size-12">${e.type}</span>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-link font-size-16 shadow-none text-muted p-0" type="button" data-bs-toggle="dropdown">
                                    <i class="mdi mdi-dots-horizontal"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item btn-edit-asset" href="javascript:void(0);" data-id="${e.id}"><i class="mdi mdi-pencil me-2"></i>Editar</a></li>
                                    <li><a class="dropdown-item btn-delete-asset text-danger" href="javascript:void(0);" data-id="${e.id}"><i class="mdi mdi-trash-can me-2"></i>Eliminar</a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <h5 class="font-size-14 mb-0">${h(t,e.currency)}</h5>
                                <small class="text-muted">Valuación</small>
                            </div>
                            <div class="col-6 border-start">
                                <h5 class="text-success font-size-14 mb-0">${h(n,e.currency)}</h5>
                                <small class="text-muted">Invertido</small>
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="d-flex justify-content-between font-size-11 mb-1">
                                <span>Progreso Inversión</span>
                                <span>${r.toFixed(0)}%</span>
                            </div>
                            <div class="progress h-5px">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: ${r}%"></div>
                            </div>
                            <small class="text-muted d-block mt-1 text-end">Meta: ${0<a?h(a,e.currency):"N/A"}</small>
                        </div>
                    </div>
                </div>
            `,c.appendChild(i)}),c.querySelectorAll(".btn-edit-asset").forEach(e=>{e.addEventListener("click",()=>openAssetModal(e.dataset.id))}),c.querySelectorAll(".btn-delete-asset").forEach(e=>{e.addEventListener("click",()=>deleteAsset(e.dataset.id))})))}s()},e=>{console.error("Error loading assets (possible permissions issue):",e);e=document.getElementById("portfolio-grid");e&&(e.innerHTML='<div class="alert alert-danger">Error de permisos al cargar activos. Por favor contacte al administrador para actualizar las reglas de Firestore.</div>')}),p.collection("cashflow_asset_types").where("uid","==",B()).onSnapshot(e=>{if(n=[],e.forEach(e=>{n.push({id:e.id,...e.data()})}),0!==n.length){{let t=document.getElementById("asset-type");t&&(e=t.value,t.innerHTML='<option value="">Seleccione tipo...</option>',n.filter(e=>!1!==e.active).sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{t.innerHTML+=`<option value="${e.name}">${e.name}</option>`}),e)&&(t.value=e)}{let t=document.getElementById("table-asset-types-list");t&&(t.innerHTML="",n.filter(e=>!1!==e.active).sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{t.innerHTML+=`
                    <tr>
                        <td>${e.name}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-soft-primary me-1" onclick="editAssetType('${e.id}', '${e.name}')"><i class="mdi mdi-pencil"></i></button>
                            <button class="btn btn-sm btn-soft-danger" onclick="deleteAssetType('${e.id}', '${e.name}')"><i class="mdi mdi-trash-can-outline"></i></button>
                        </td>
                    </tr>
                `}))}}else(async()=>{let n=p.batch();["Real Estate / Pozo","Fondo de Reserva / Colchón","Criptomonedas","Acciones / Bonos","Relojes / Lujo","Otro"].forEach(e=>{var t=p.collection("cashflow_asset_types").doc();n.set(t,{name:e,uid:B(),active:!0,createdAt:new Date})}),await n.commit(),console.log("Default asset types seeded.")})()},e=>{console.error("Error loading asset types (permissions):",e);e=document.getElementById("asset-type");e&&(e.innerHTML='<option value="">Error de permisos</option>'),document.getElementById("modal-asset").classList.contains("show")&&Swal.fire("Error de Permisos","No se pudieron cargar los tipos de activo. Asegúrate de haber desplegado las reglas de Firestore.","error")})):window.location.href="auth-login.html"}),new bootstrap.Modal(document.getElementById("modal-income"))),F=new bootstrap.Modal(document.getElementById("modal-expense")),P=new bootstrap.Modal(document.getElementById("modal-saving")),m=new bootstrap.Modal(document.getElementById("modal-transfer-unified")),O=new bootstrap.Modal(document.getElementById("modal-asset")),V=new bootstrap.Modal(document.getElementById("modal-investment")),_=new bootstrap.Modal(document.getElementById("modal-withdrawal")),G=new bootstrap.Modal(document.getElementById("modal-asset-transfer")),z=new bootstrap.Modal(document.getElementById("modal-manage-asset-types")),v=[],E=[],d={INCOME:[],EXPENSE:[],SAVING:[]},f={INCOME:[],EXPENSE:[]},I=[],b=[];let n=[],t=!1,U=!1,q=!1,w={INCOME:{column:"date",direction:"desc"},EXPENSE:{column:"date",direction:"desc"},SAVING:{column:"date",direction:"desc"}},h=(e,t)=>new Intl.NumberFormat("es-AR",{style:"currency",currency:t}).format(e),B=()=>window.getEffectiveUID?window.getEffectiveUID():sessionStorage.getItem("effectiveUID")||g.currentUser.uid,S=e=>e?e.seconds?new Date(1e3*e.seconds):new Date(e):null;function l(e){let t="",n=("INCOME"===e?t="in-category":"EXPENSE"===e?t="ex-category":"SAVING"===e&&(t="sav-category"),document.getElementById(t));n&&(n.innerHTML='<option value="">Seleccione...</option>',d[e].forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`}))}function X(){let t=document.getElementById("filter-category");var e;t&&(e=t.value,t.innerHTML='<option value="ALL">Todas</option>',[...new Set([...d.INCOME,...d.EXPENSE])].sort().forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}),e)&&(t.value=e)}[{check:"in-recurring",container:"container-in-installments"},{check:"ex-recurring",container:"container-ex-installments"},{check:"sav-recurring",container:"container-sav-installments"}].forEach(e=>{let t=document.getElementById(e.check),n=document.getElementById(e.container);t&&n&&t.addEventListener("change",()=>{var e;n.style.display=t.checked?"block":"none",t.checked||(e=n.querySelector("input"))&&(e.value="")})}),document.addEventListener("click",async t=>{t=t.target.closest("button");if(t){if(t.classList.contains("btn-add-category")){var n=t.dataset.type;let e="";"INCOME"===n?e="container-new-category-in":"EXPENSE"===n?e="container-new-category-ex":"SAVING"===n&&(e="container-new-category-sav");var n=document.getElementById(e);n&&(a=n.querySelector(".input-new-cat"),n.style.display="block",a)&&a.focus()}if(t.classList.contains("btn-cancel-new-cat")&&(n=t.closest(".container-new-cat"))&&(n.style.display="none"),t.classList.contains("btn-save-new-cat")){var a=t.dataset.type,n=t.closest(".container-new-cat"),e=n.querySelector(".input-new-cat"),r=e.value.trim();if(!r)return;var o=t,i=o.innerHTML;try{o.innerHTML='<i class="bx bx-loader bx-spin"></i>',o.disabled=!0,await p.collection("cashflow_categories").add({name:r,type:a,active:!0,createdAt:new Date,createdBy:g.currentUser.uid}),d[a].push(r),d[a].sort(),l(a),X();var c="INCOME"===a?"in-category":"EXPENSE"===a?"ex-category":"sav-category",s=document.getElementById(c);s&&(s.value=r),n.style.display="none",e.value=""}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar la categoría.","error")}finally{o.innerHTML=i,o.disabled=!1}}t.classList.contains("btn-manage-categories")&&(await J(j=t.dataset.type),Y.show())}});let Y=new bootstrap.Modal(document.getElementById("modal-manage-categories")),j="INCOME";async function J(n){let a=document.querySelector("#table-manage-categories tbody");a.innerHTML="<tr><td>Cargando...</td></tr>";var e=document.querySelector("#modal-manage-categories .modal-title");let t="Ingresos";"EXPENSE"===n?t="Gastos":"SAVING"===n&&(t="Ahorros"),e&&(e.textContent=`Gestionar Categorías (${t})`);try{var r=await p.collection("cashflow_categories").where("type","==",n).get();a.innerHTML="";let t=[];r.forEach(e=>{t.push({id:e.id,...e.data()})}),t.sort((e,t)=>{e=e.createdAt?e.createdAt.toDate?e.createdAt.toDate():new Date(e.createdAt):new Date(0);return(t.createdAt?t.createdAt.toDate?t.createdAt.toDate():new Date(t.createdAt):new Date(0))-e}),t.forEach(e=>{!1!==e.active&&(a.innerHTML+=`
                    <tr>
                        <td class="align-middle">${e.name}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-soft-danger" onclick="softDeleteCategory('${e.id}', '${e.name}', '${n}')">
                                <i class="mdi mdi-trash-can-outline"></i>
                            </button>
                        </td>
                    </tr>
                 `)}),""===a.innerHTML&&(a.innerHTML='<tr><td colspan="2" class="text-center text-muted">No hay categorías personalizadas para este tipo.</td></tr>')}catch(e){console.error(e),a.innerHTML="<tr><td>Error al cargar.</td></tr>"}}window.softDeleteCategory=async function(e,t,n){confirm(`¿Eliminar "${t}" del selector?`)&&(await p.collection("cashflow_categories").doc(e).update({active:!1}),d[n]=d[n].filter(e=>e!==t),l(n),J(n))};document.getElementById("form-transaction");var e=document.getElementById("btn-new-income"),a=document.getElementById("btn-new-expense"),r=document.getElementById("btn-new-saving"),o=(r&&r.classList.add("d-none"),document.getElementById("btn-transfer-saving")),e=(e&&e.addEventListener("click",()=>i("INCOME")),a&&a.addEventListener("click",()=>i("EXPENSE")),r&&r.addEventListener("click",()=>i("SAVING")),o&&o.addEventListener("click",async function(){let n=document.getElementById("trans-source"),t=document.getElementById("trans-dest"),e=document.getElementById("trans-amount"),a=(n.innerHTML='<option value="">Seleccione origen...</option>',t.innerHTML='<option value="">Seleccione destino...</option>',e.value="",v.filter(e=>"SAVING"===e.type&&"USED"!==e.status));0===a.length?Swal.fire("Atención","No tienes ahorros activos para transferir.","info"):(a.forEach(e=>{var t=h(e.amount,e.currency);n.innerHTML+=`<option value="${e.id}" data-currency="${e.currency}" data-amount="${e.amount}">${e.entityName} (${t})</option>`}),a.forEach(e=>{t.innerHTML+=`<option value="TRANS_TO_SAV_${e.id}">${e.entityName} (Existente)</option>`}),d.SAVING.forEach(e=>{t.innerHTML+=`<option value="TRANS_TO_CAT_${e}">Nueva meta: ${e}</option>`}),transferModal.show())}),document.getElementById("form-transfer-saving")),a=(e&&e.addEventListener("submit",async function(t){t.preventDefault();let n=document.getElementById("trans-source").value,a=document.getElementById("trans-dest").value,r=parseFloat(document.getElementById("trans-amount").value),e=document.getElementById("btn-do-transfer");if(n&&a&&r){t=v.find(e=>e.id===n);if(r>t.amount)Swal.fire("Monto excedido","No puedes transferir más del saldo disponible en el origen.","error");else{e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i>';try{var o=p.batch(),i=firebase.firestore.Timestamp.fromDate(new Date),c=p.collection("transactions").doc(),s=(o.set(c,{type:"SAVING",entityName:"Reducción por Transferencia: "+t.entityName,category:t.category,amount:-r,currency:t.currency,date:i,isInitial:!0,status:"ACTIVE",address:"Transferencia interna hacia: "+(a.includes("SAV_")?"otra meta":a.split("CAT_")[1]),createdAt:new Date,createdBy:g.currentUser.uid}),p.collection("transactions").doc());let e="",n="";if(a.startsWith("TRANS_TO_SAV_")){let t=a.replace("TRANS_TO_SAV_","");var d=v.find(e=>e.id===t);e=d.entityName,n=d.category}else e=a.replace("TRANS_TO_CAT_",""),n=e;o.set(s,{type:"SAVING",entityName:"Recibo por Transferencia: "+e,category:n,amount:r,currency:t.currency,date:i,isInitial:!0,status:"ACTIVE",address:"Transferencia interna desde: "+t.entityName,createdAt:new Date,createdBy:g.currentUser.uid}),await o.commit(),m.hide(),Swal.fire("Transferencia Exitosa","Monto reasignado correctamente.","success"),W()}catch(e){console.error(e),Swal.fire("Error","Error al procesar: "+e.message,"error")}finally{e.disabled=!1,e.textContent="Confirmar Transferencia"}}}}),document.getElementById("trans-source"));function i(e,t=null){"INCOME"===e?(document.getElementById("form-income").reset(),document.getElementById("in-id").value="",document.getElementById("in-date").valueAsDate=new Date,R.show()):"EXPENSE"===e?(document.getElementById("form-expense").reset(),document.getElementById("ex-id").value="",document.getElementById("ex-date").valueAsDate=new Date,F.show()):"SAVING"===e&&(document.getElementById("form-saving").reset(),document.getElementById("sav-id").value="",document.getElementById("sav-date").valueAsDate=new Date,t&&(document.getElementById("sav-id").value=t.id||"",document.getElementById("sav-name").value=t.entityName||"",document.getElementById("sav-amount").value=t.amount||0,document.getElementById("sav-target-amount").value=t.targetAmount||"",document.getElementById("sav-currency").value=t.currency||"ARS",document.getElementById("sav-category").value=t.category||"Fondo de Reserva",document.getElementById("sav-status").value=t.status||"ACTIVE",document.getElementById("sav-is-initial").checked=t.isInitial||!1,document.getElementById("sav-recurring").checked=t.isRecurring||!1,t.isRecurring&&(document.getElementById("container-sav-installments").style.display="block",document.getElementById("sav-installments").value=t.installmentsTotal||""),t.date&&(document.getElementById("sav-date").valueAsDate=S(t.date)),document.getElementById("sav-address").value=t.address||""),P.show())}async function Q(e,t){e.preventDefault();var n="INCOME"===t?"in":"ex",e=e.target.querySelector('button[type="submit"]'),a=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i> Guardando...';try{var r=document.getElementById(n+"-id").value,o=document.getElementById(n+"-entity-name").value,i=o,c=t;if(i){var s="INCOME"===c?"CLIENT":"PROVIDER",d=c;if(!f[d].some(e=>e.toLowerCase()===i.toLowerCase()))try{await p.collection("cashflow_entities").add({name:i,type:s,createdAt:new Date,uid:B()}),f[d].push(i);var l,u="INCOME"===c?"list-entities-income":"list-entities-expense",m=document.getElementById(u);m&&((l=document.createElement("option")).value=i,m.appendChild(l)),console.log(`New entity ${i} saved as ${s}.`)}catch(e){console.error("Error auto-saving entity",e)}}await 0;var y={type:t,entityName:o,cuit:document.getElementById(n+"-cuit").value,address:document.getElementById(n+"-address").value,category:document.getElementById(n+"-category").value,status:document.getElementById(n+"-status").value,currency:document.getElementById(n+"-currency").value,accountId:document.getElementById(n+"-account").value,amount:parseFloat(document.getElementById(n+"-amount").value)||0,date:firebase.firestore.Timestamp.fromDate(document.getElementById(n+"-date").valueAsDate||new Date),isRecurring:document.getElementById(n+"-recurring").checked,installmentsTotal:parseInt(document.getElementById(n+"-installments").value)||null,installmentNumber:1,updatedAt:new Date};r?await p.collection("transactions").doc(r).update(y):(y.createdAt=new Date,y.createdBy=g.currentUser.uid,await p.collection("transactions").add(y)),("INCOME"===t?R:F).hide(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Guardado correctamente.",showConfirmButton:!1,timer:3e3})}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar el movimiento: "+e.message,"error")}finally{e.disabled=!1,e.innerHTML=a}}a&&a.addEventListener("change",function(){var e=document.getElementById("trans-source"),e=e.options[e.selectedIndex],t=document.getElementById("trans-currency");e&&e.dataset.currency?t.value=e.dataset.currency:t.value=""}),document.getElementById("btn-save-asset-type")?.addEventListener("click",async()=>{var e=document.getElementById("new-asset-type-name"),t=document.getElementById("manage-asset-type-id"),e=e.value.trim(),t=t.value;if(e)try{t?await p.collection("cashflow_asset_types").doc(t).update({name:e,updatedAt:new Date}):await p.collection("cashflow_asset_types").add({name:e,uid:B(),active:!0,createdAt:new Date}),cancelAssetTypeEdit()}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar el tipo de activo.","error")}}),window.editAssetType=(e,t)=>{document.getElementById("manage-asset-type-id").value=e,document.getElementById("new-asset-type-name").value=t,document.getElementById("btn-save-asset-type-text").textContent="Actualizar",document.getElementById("btn-cancel-edit-asset-type").classList.remove("d-none")},window.cancelAssetTypeEdit=()=>{document.getElementById("manage-asset-type-id").value="",document.getElementById("new-asset-type-name").value="",document.getElementById("btn-save-asset-type-text").textContent="Guardar",document.getElementById("btn-cancel-edit-asset-type").classList.add("d-none")},document.getElementById("btn-cancel-edit-asset-type")?.addEventListener("click",cancelAssetTypeEdit),window.deleteAssetType=async(e,t)=>{t=(await Swal.fire({title:`¿Eliminar "${t}"?`,text:"Se quitará del listado, pero se mantendrá la referencia en activos creados previamente.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed;t&&await p.collection("cashflow_asset_types").doc(e).update({active:!1,updatedAt:new Date})},document.getElementById("btn-manage-asset-types")?.addEventListener("click",()=>{cancelAssetTypeEdit(),z.show()}),document.getElementById("form-income").addEventListener("submit",e=>Q(e,"INCOME")),document.getElementById("form-expense").addEventListener("submit",e=>Q(e,"EXPENSE"));r=document.getElementById("form-saving");function W(){p.collection("transactions").where("createdBy","==",B()).onSnapshot(e=>{v=[],e.forEach(e=>v.push({id:e.id,...e.data()})),(async a=>{if(!t&&!q){t=!0;try{var r=a.filter(e=>e.isRecurring&&!e.parentRecurringId);let n=new Date;var o=new Date(n.getFullYear(),n.getMonth(),1);let e=0;for(let t of r){var i,c,s,d=S(t.date);o<=d||a.find(e=>e.parentRecurringId===t.id&&S(e.date).getMonth()===n.getMonth()&&S(e.date).getFullYear()===n.getFullYear())||(i=a.filter(e=>e.parentRecurringId===t.id).length,t.installmentsTotal&&i+1>=t.installmentsTotal)||(c=new Date(n.getFullYear(),n.getMonth(),1),delete(s={...t}).id,delete s.createdAt,s.isRecurring=!1,s.parentRecurringId=t.id,s.status="SAVING"===t.type?"ACTIVE":"PENDING",s.date=c,s.createdAt=new Date,s.description=`${t.address||""} (Recurrente Mes ${n.getMonth()+1})`,t.installmentsTotal&&(s.installmentNumber=i+2),"SAVING"===t.type&&(s.isInitial=!1),console.log("Generating recurring tx for",t.entityName,t.installmentsTotal?`(Cuota ${s.installmentNumber}/${t.installmentsTotal})`:""),await p.collection("transactions").add(s),e++)}0<e&&console.log(`Generated ${e} recurring transactions.`),q=!0}catch(e){console.error("Error in checkRecurrences:",e)}finally{t=!1}}})(v),s()})}r&&r.addEventListener("submit",async function(e){e.preventDefault(),e.target;var t=(e=document.getElementById("btn-save-saving")).innerHTML;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i> Guardando...';try{var n=document.getElementById("sav-id").value,a={type:"SAVING",entityName:document.getElementById("sav-name").value,category:document.getElementById("sav-category").value,status:document.getElementById("sav-status").value,currency:document.getElementById("sav-currency").value,accountId:document.getElementById("sav-account").value,amount:parseFloat(document.getElementById("sav-amount").value)||0,targetAmount:parseFloat(document.getElementById("sav-target-amount").value)||0,isInitial:document.getElementById("sav-is-initial").checked,isRecurring:document.getElementById("sav-recurring").checked,date:firebase.firestore.Timestamp.fromDate(document.getElementById("sav-date").valueAsDate||new Date),address:document.getElementById("sav-address").value,installmentsTotal:parseInt(document.getElementById("sav-installments").value)||null,installmentNumber:1,updatedAt:new Date};n?await p.collection("transactions").doc(n).update(a):(a.createdAt=new Date,a.createdBy=g.currentUser.uid,await p.collection("transactions").add(a)),P.hide(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Ahorro guardado.",showConfirmButton:!1,timer:3e3})}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar el ahorro.","error")}finally{e.disabled=!1,e.innerHTML=t}});let A=document.getElementById("filter-year"),K=document.getElementById("filter-period"),Z=document.getElementById("filter-search"),ee=document.getElementById("filter-category"),te=document.getElementById("filter-only-recurring");o=document.getElementById("btn-apply-filters"),e=new Date;let c=e.getFullYear();a=(e.getMonth()+1).toString().padStart(2,"0");function s(){let e=[...v];parseInt(A.value);let t=K.value,n=Z.value.toLowerCase(),a=ee.value,r=te.checked,o=(r&&(e=e.filter(e=>(!0===e.isRecurring||"true"===e.isRecurring)&&!e.parentRecurringId)),"ALL"!==a&&(e=e.filter(e=>e.category===a)),n&&(e=e.filter(e=>e.entityName.toLowerCase().includes(n)||e.address&&e.address.toLowerCase().includes(n))),parseInt(A.value||(new Date).getFullYear())),i=e=>{var e=S(e.date);return!(!e||e.getFullYear()!==o||"ALL"!==t&&!("YTD"===t?e<=new Date:(e=e.getMonth()+1,"Q1"===t?1<=e&&e<=3:"Q2"===t?4<=e&&e<=6:"Q3"===t?7<=e&&e<=9:"Q4"===t?10<=e&&e<=12:"S1"===t?1<=e&&e<=6:"S2"===t?7<=e&&e<=12:e===parseInt(t))))};var c=e.filter(e=>"SAVING"!==e.type&&(!!r||i(e))),s=e.filter(e=>"SAVING"===e.type&&(!!r||"ACTIVE"===e.status||i(e))),d=e.filter(e=>i(e)),l=(e,r)=>e.sort((e,t)=>{let n=e[r.column],a=t[r.column];return"date"===r.column&&(n=S(e.date).getTime(),a=S(t.date).getTime()),"string"==typeof n&&(n=n.toLowerCase()),"string"==typeof a&&(a=a.toLowerCase()),n<a?"asc"===r.direction?-1:1:n>a?"asc"===r.direction?1:-1:0}),u=l(c.filter(e=>"INCOME"===e.type),w.INCOME),c=l(c.filter(e=>"EXPENSE"===e.type),w.EXPENSE),l=l(s,w.SAVING);{s=d,t;var d=(e,n)=>e.reduce((e,t)=>t.currency===n?e+(Number(t.amount)||0):e,0),m=s.filter(e=>"INCOME"===e.type),s=s.filter(e=>"EXPENSE"===e.type);x("kpi-income-expected-ars",d(m,"ARS")),x("kpi-income-expected-usd",d(m,"USD")),x("kpi-income-pending-ars",d(m.filter(e=>"PAID"!==e.status),"ARS")),x("kpi-income-pending-usd",d(m.filter(e=>"PAID"!==e.status),"USD")),x("kpi-expense-expected-ars",d(s,"ARS")),x("kpi-expense-expected-usd",d(s,"USD")),x("kpi-expense-pending-ars",d(s.filter(e=>"PAID"!==e.status),"ARS")),x("kpi-expense-pending-usd",d(s.filter(e=>"PAID"!==e.status),"USD"));let n=0,a=0,r=(E.forEach(e=>{var t=T(e.id);"ARS"===e.currency&&(n+=t),"USD"===e.currency&&(a+=t)}),x("kpi-balance-ars",n),x("kpi-balance-usd",a),0),o=0;b.forEach(e=>{var t=Number(e.currentValuation)||Number(e.investedAmount)||0;"ARS"===e.currency&&(r+=t),"USD"===e.currency&&(o+=t)}),x("kpi-invested-ars",r),x("kpi-invested-usd",o);var y=n+r,g=a+o,y=(x("kpi-net-worth-ars",y),x("kpi-net-worth-usd",g),d(m.filter(e=>"PAID"===e.status),"ARS")-d(s.filter(e=>"PAID"===e.status),"ARS")),g=d(m.filter(e=>"PAID"===e.status),"USD")-d(s.filter(e=>"PAID"===e.status),"USD");re(y,g,n,a),de()}{m=[...u,...c,...l];let t=document.querySelector("#table-income tbody"),n=document.querySelector("#table-expense tbody"),a=(t.innerHTML="",n.innerHTML="",(e,t=!1)=>{var n=S(e.date),n=n?n.toLocaleDateString():"N/A",a=h(e.amount||0,e.currency||"ARS");let r="badge bg-warning text-dark",o="Pendiente";return"PAID"===e.status&&(r="badge bg-success",o="Cobrado/Pagado"),"USED"===e.status&&(r="badge bg-secondary",o="Usado"),t?"":(t="PENDING"===e.status?`<button class="btn btn-sm btn-soft-success" onclick="toggleStatus('${e.id}', 'PAID')" title="Marcar como Completado"><i class="bx bx-check"></i></button>`:`<button class="btn btn-sm btn-soft-warning" onclick="toggleStatus('${e.id}', 'PENDING')" title="Marcar Pendiente"><i class="bx bx-undo"></i></button>`,`
                <tr>
                    <td>${n}</td>
                    <td>
                        <h6 class="mb-0 font-size-14 text-truncate">${e.entityName}</h6>
                        <small class="text-muted text-truncate">
                            ${e.cuit||"-"} 
                            ${e.installmentsTotal?` <span class="badge badge-soft-info ms-1" style="border: 1px solid #0ab39c;">Cuota ${e.installmentNumber||1}/${e.installmentsTotal}</span>`:""}
                        </small>
                    </td>
                    <td><span class="badge badge-soft-primary">${e.category}</span></td>
                    <td>${e.address||"-"}</td>
                    <td>${"ARS"===e.currency?a:"-"}</td>
                    <td>${"USD"===e.currency?a:"-"}</td>
                    <td>${!0===e.isRecurring||"true"===e.isRecurring?'<i class="bx bx-revision text-primary"></i>':"-"}</td>
                    <td><div class="${r}">${o}</div></td>
                    <td>
                        <div class="d-flex gap-2">
                            ${t}
                            <button class="btn btn-sm btn-soft-danger" onclick="deleteTransaction('${e.id}')"><i class="mdi mdi-trash-can"></i></button>
                        </div>
                    </td>
                </tr>
            `)});m.filter(e=>"INCOME"===e.type).forEach(e=>{t.innerHTML+=a(e,!1)}),m.filter(e=>"EXPENSE"===e.type).forEach(e=>{n.innerHTML+=a(e,!1)})}ae(),ne()}[...A.options].some(e=>e.value==c)||((r=document.createElement("option")).value=c,r.textContent=c,A.appendChild(r)),A.value=c,K.value=a,o&&o.addEventListener("click",s),[A,K,ee,te].forEach(e=>e.addEventListener("change",s)),["table-income","table-expense","table-saving"].forEach(i=>{var e=document.getElementById(i);e&&e.querySelectorAll("th[data-sort]").forEach(o=>{o.style.cursor="pointer",o.addEventListener("click",()=>{var e=i.split("-")[1].toUpperCase(),t=o.dataset.sort,n=(w[e].column===t?w[e].direction="asc"===w[e].direction?"desc":"asc":(w[e].column=t,w[e].direction="asc"),i),a=t,r=w[e].direction;(n=(n=document.getElementById(n)).querySelectorAll("th[data-sort]")).forEach(e=>{var t;e.querySelectorAll(".sort-icon").forEach(e=>e.remove()),e.dataset.sort===a&&((t=document.createElement("i")).className=`mdi mdi-arrow-${"asc"===r?"up":"down"} ms-1 sort-icon`,e.appendChild(t))}),s()})})});{let t=(e=new Date).getFullYear();e=(e.getMonth()+1).toString().padStart(2,"0"),r=document.getElementById("filter-year"),a=document.getElementById("filter-period"),r&&a&&([...r.options].some(e=>e.value==t)||((o=document.createElement("option")).value=t,o.textContent=t,r.appendChild(o)),r.value=t,a.value=e)}function ne(){let r=document.querySelector("#table-agreements tbody"),s=(r.innerHTML="",document.getElementById("filter-period").value),d=document.getElementById("filter-year").value;let o=!!{"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[s];0===I.length?r.innerHTML='<tr><td colspan="7" class="text-center text-muted">No hay acuerdos registrados.</td></tr>':I.forEach(c=>{var e=h(c.amount,c.currency);let t="";if(o){var n=d+"-"+s,a=c.invoices&&c.invoices[n]&&c.invoices[n].sent;t=`
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="list-invoice-${c.id}" ${a?"checked":""} onchange="toggleInvoiceSent('${c.id}', '${n}', this)">
                        <label class="form-check-label text-muted small" for="list-invoice-${c.id}">${a?c.hasInvoice?"ENVIADA":"GENERADO":c.hasInvoice?"NO ENVIADA":"PENDIENTE"}</label>
                    </div>
                `}else{let o=0,i=0;c.invoices&&Object.keys(c.invoices).forEach(t=>{var[n,a]=t.split("-");if(n===d){var r,a=parseInt(a);let e=!1;"ALL"===s?e=!0:"YTD"===s?(r=new Date,new Date(parseInt(n),a-1,1)<=r&&(e=!0)):"Q1"===s?e=1<=a&&a<=3:"Q2"===s?e=4<=a&&a<=6:"Q3"===s?e=7<=a&&a<=9:"Q4"===s?e=10<=a&&a<=12:"S1"===s?e=1<=a&&a<=6:"S2"===s&&(e=7<=a&&a<=12),e&&c.invoices[t].sent&&(i++,o+=c.amount)}}),t=0<i?`<span class="badge bg-success-subtle text-success font-size-12 p-2">${i} Gen. (${h(o,c.currency)})</span>`:'<span class="text-muted small">-</span>'}r.innerHTML+=`
                <tr>
                    <td>
                        <h6 class="mb-0 text-truncate font-size-14">${c.name}</h6>
                        <small class="text-muted d-block d-lg-none">${c.description||"-"}</small>
                    </td>
                    <td class="d-none d-lg-table-cell">
                        <small class="d-block text-muted">${c.description||"-"}</small>
                        <small class="d-block code">${c.cuit||""}</small>
                    </td>
                    <td class="fw-bold">${e}</td>
                    <td>${c.hasInvoice?c.biller||"-":'<span class="text-muted font-size-11 fst-italic">No Factura</span>'}</td>
                    <td>${t}</td>
                    <td>
                        <button class="btn btn-sm btn-soft-primary" onclick="editAgreement('${c.id}')"><i class="mdi mdi-pencil"></i></button>
                    </td>
                </tr>
            `})}function ae(){let o=document.getElementById("monthly-control-list");o.innerHTML="";var e=document.getElementById("filter-period").value,t=document.getElementById("filter-year").value,n={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"};let i="",a="";a=n[e]?(i=t+"-"+e,n[e]+" "+t):(t=((e=new Date).getMonth()+1).toString().padStart(2,"0"),i=e.getFullYear()+"-"+t,`${n[t]} ${e.getFullYear()} (Actual)`);n=I.filter(e=>"MONTHLY"===e.frequency);0===n.length?o.innerHTML='<tr><td colspan="6" class="text-center text-muted">No hay acuerdos mensuales activos.</td></tr>':(document.querySelector("#card-monthly-control .card-title").innerHTML='<i class="mdi mdi-playlist-check me-1"></i> Control de Facturación: '+a,n.forEach(e=>{var t=h(e.amount,e.currency);let n=!1;e.invoices&&e.invoices[i]&&e.invoices[i].sent&&(n=!0);var a=`
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="ctrl-invoice-${e.id}" ${n?"checked":""} onchange="toggleInvoiceSent('${e.id}', '${i}', this)">
                    <label class="form-check-label text-muted small" for="ctrl-invoice-${e.id}">${n?"GENERADO":"PENDIENTE"}</label>
                </div>
             `,r=e.hasInvoice?'<span class="badge bg-success-subtle text-success">Sí</span>':'<span class="badge bg-secondary-subtle text-secondary">No</span>';o.innerHTML+=`
                <tr class="${n?"bg-success-subtle":""}">
                    <td><strong>${e.name}</strong></td>
                    <td><small class="text-muted coding">${e.cuit||"-"}</small></td>
                    <td>${r}</td>
                    <td class="fw-bold">${t}</td>
                    <td>${e.biller||"-"}</td>
                    <td>${a}</td>
                </tr>
             `}))}function re(e,t,n,a){var r=document.getElementById("surplus-assistant-container"),o=document.getElementById("surplus-msg"),i=document.getElementById("filter-period").value;if(100<e||0<t){n=Math.min(e,n),a=Math.min(t,a);if(n<=0&&a<=0)return void(r.style.display="none");n={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[i];if(n)return r.style.display="block",void(o.innerHTML=`Ganaste <strong>${h(e,"ARS")}</strong> / <strong>${h(t,"USD")}</strong> netos en <strong>${n}</strong>. ¿Deseas ahorrar una parte?`)}r.style.display="none"}function x(e,t){document.getElementById(e).textContent=new Intl.NumberFormat("es-AR").format(t)}window.openCapitalizeModal=async function(){var e=parseFloat(document.getElementById("kpi-balance-ars").textContent.replace(/[$.]/g,"").replace(",","."))||0,t=parseFloat(document.getElementById("kpi-balance-usd").textContent.replace(/[$.]/g,"").replace(",","."))||0,n=document.getElementById("filter-period").value,a=document.getElementById("filter-year").value,r={"01":"Enero","02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio","07":"Julio","08":"Agosto","09":"Septiembre",10:"Octubre",11:"Noviembre",12:"Diciembre"}[n],e=(await Swal.fire({title:"Capitalizar Excedente - "+r,html:`
                <div class="text-start">
                    <p class="text-muted small">Decide cuánto mover del saldo disponible actual a tus ahorros.</p>
                    <div class="mb-3">
                        <label class="form-label">Monto en Pesos (ARS) - Disponible: ${h(e,"ARS")}</label>
                        <input id="swal-ars" class="form-control" type="number" step="0.01" value="${0<e?e:0}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto en Dólares (USD) - Disponible: ${h(t,"USD")}</label>
                        <input id="swal-usd" class="form-control" type="number" step="0.01" value="${0<t?t:0}">
                    </div>
                </div>
            `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Confirmar Ahorro",cancelButtonText:"Cancelar",preConfirm:()=>({ars:parseFloat(document.getElementById("swal-ars").value)||0,usd:parseFloat(document.getElementById("swal-usd").value)||0})})).value;e&&(async(e,t,a,r)=>{let o=new Date(a,parseInt(t),0),i=p.batch(),c=p.collection("transactions"),s=0,n=(e,t)=>{var n;e<=0||(n=c.doc(),i.set(n,{type:"SAVING",entityName:`Capitalización Excedente ${r} `+a,category:"Fondo de Reserva",status:"ACTIVE",currency:t,amount:e,date:firebase.firestore.Timestamp.fromDate(o),address:`Traspaso de saldo sobrante del periodo filtrado (${r} ${a}).`,createdAt:new Date,createdBy:g.currentUser.uid}),s++)};if(n(e.ars,"ARS"),n(e.usd,"USD"),0<s)try{await i.commit(),Swal.fire("¡Éxito!","Excedente capitalizado correctamente.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo realizar el traspaso.","error")}})(e,n,a,r)},window.toggleStatus=function(e,t){p.collection("transactions").doc(e).update({status:t})},window.deleteTransaction=async function(e){if((await Swal.fire({title:"¿Eliminar?",text:"No podrás revertir esto.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#f46a6a",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{await p.collection("transactions").doc(e).delete(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Eliminado correctamente.",showConfirmButton:!1,timer:2e3})}catch(e){console.error("Error al eliminar:",e),Swal.fire("Error","No se pudo eliminar: "+e.message,"error")}},window.editSaving=function(t){var e=v.find(e=>e.id===t);e&&i("SAVING",e)},window.convertSaving=async function(t){var e=v.find(e=>e.id===t);if(e){e=(await Swal.fire({title:"Mover a Gasto",text:"Ingresa el nombre del Proveedor/Entidad para este gasto:",input:"text",inputValue:e.entityName,showCancelButton:!0,confirmButtonText:"Convertir"})).value;if(e)try{await p.collection("transactions").doc(t).update({type:"EXPENSE",entityName:e,status:"PAID"}),Swal.fire("Éxito","Ahorro convertido en gasto correctamente.","success")}catch(e){console.error(e),Swal.fire("Error",e.message,"error")}}},window.useSavingForExpense=window.convertSaving;let u=new bootstrap.Modal(document.getElementById("agreement-modal")),oe=document.getElementById("form-agreement");async function ie(){p.collection("cashflow_agreements").where("isActive","!=",!1).onSnapshot(e=>{I=[],e.forEach(e=>I.push({id:e.id,...e.data()})),ne(),ae(),(async()=>{U||console.log("Automatic agreement processing is disabled (Manual Mode).")})()})}g.currentUser&&ie();o=document.getElementById("btn-new-agreement"),o&&o.addEventListener("click",()=>{oe.reset(),document.getElementById("agreement-id").value="",document.getElementById("agreement-modal-title").textContent="Nuevo Acuerdo",document.getElementById("btn-delete-agreement").classList.add("d-none"),document.getElementById("agr-last-update").textContent=(new Date).toISOString().split("T")[0],document.getElementById("agr-biller").value="Lucre",document.getElementById("div-biller").style.display="block",document.getElementById("agr-currency").value="ARS",document.getElementById("agr-frequency").value="MONTHLY",document.getElementById("agr-account").value="",document.getElementById("agr-hasInvoice").value="true",u.show()}),r=document.getElementById("agr-hasInvoice"),r&&r.addEventListener("change",e=>{var t=document.getElementById("div-biller"),n=document.getElementById("agr-biller");"true"===e.target.value?(t&&(t.style.display="block"),n&&(n.value="Lucre")):(t&&(t.style.display="none"),n&&(n.value=""))}),window.editAgreement=function(t){var e=I.find(e=>e.id===t);e&&(document.getElementById("agreement-id").value=t,document.getElementById("agreement-modal-title").textContent="Editar Acuerdo",document.getElementById("agr-name").value=e.name,document.getElementById("agr-cuit").value=e.cuit||"",document.getElementById("agr-hasInvoice").value=e.hasInvoice?"true":"false",e.hasInvoice?(document.getElementById("div-biller").style.display="block",document.getElementById("agr-biller").value=e.biller||"Lucre"):(document.getElementById("div-biller").style.display="none",document.getElementById("agr-biller").value=""),document.getElementById("agr-desc").value=e.description||"",document.getElementById("agr-frequency").value=e.frequency||"MONTHLY",document.getElementById("agr-currency").value=e.currency||"ARS",document.getElementById("agr-account").value=e.accountId||"",document.getElementById("agr-amount").value=e.amount,document.getElementById("agr-last-update").textContent=e.lastUpdate||"-",document.getElementById("btn-delete-agreement").classList.remove("d-none"),u.show())},oe.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("agreement-id").value,t=document.getElementById("btn-save-agreement");t.disabled=!0,t.innerHTML='<i class="bx bx-loader bx-spin"></i>';try{var n={name:document.getElementById("agr-name").value,cuit:document.getElementById("agr-cuit").value,hasInvoice:"true"===document.getElementById("agr-hasInvoice").value,biller:document.getElementById("agr-biller").value,description:document.getElementById("agr-desc").value,frequency:document.getElementById("agr-frequency").value,currency:document.getElementById("agr-currency").value,accountId:document.getElementById("agr-account").value,amount:parseFloat(document.getElementById("agr-amount").value)||0,lastUpdate:document.getElementById("agr-last-update").textContent,isActive:!0,updatedAt:new Date};e?await p.collection("cashflow_agreements").doc(e).update(n):(n.createdAt=new Date,n.uid=B(),n.invoices={},await p.collection("cashflow_agreements").add(n)),u.hide(),Swal.fire("Guardado","El acuerdo se actualizó correctamente.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar: "+e.message,"error")}finally{t.disabled=!1,t.textContent="Guardar Acuerdo"}}),a=document.getElementById("btn-delete-agreement"),a&&a.addEventListener("click",async()=>{let t=document.getElementById("agreement-id").value;t&&Swal.fire({title:"¿Archivar Acuerdo?",text:"No aparecerá en los listados activos.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, archivar",cancelButtonText:"Cancelar"}).then(async e=>{e.isConfirmed&&(await p.collection("cashflow_agreements").doc(t).update({isActive:!1}),u.hide())})}),e=document.getElementById("btn-calc-update");e&&e.addEventListener("click",()=>{let e=document.getElementById("agr-amount");var t=document.getElementById("agr-calc-percent"),n=document.getElementById("agr-last-update"),a=parseFloat(e.value)||0,r=parseFloat(t.value)||0;0!==r&&(e.value=(a+a*(r/100)).toFixed(2),n.textContent=(new Date).toISOString().split("T")[0],e.classList.add("is-valid"),setTimeout(()=>e.classList.remove("is-valid"),2e3),t.value="")}),window.toggleInvoiceSent=async function(r,o,i){var t=i.checked,c=I.find(e=>e.id===r);if(c)try{var s=p.collection("cashflow_agreements").doc(r);if(t){let t=c.currency,n=c.amount,a="";var d="USD"===c.currency?"ARS":"USD",l=await Swal.fire({title:"Moneda de Cobro",text:`El acuerdo es de ${h(c.amount,c.currency)}. ¿En qué moneda se cobró?`,icon:"question",showDenyButton:!0,showCancelButton:!0,confirmButtonText:"Cobrar en "+c.currency,denyButtonText:"Convertir a "+d,cancelButtonText:"Cancelar"});if(l.isDismissed)i.checked=!1;else{if(l.isDenied){var u=(await Swal.fire({title:"Tipo de Cambio",text:`Ingrese la cotización para convertir de ${c.currency} a `+d,input:"number",inputAttributes:{min:0,step:.01},showCancelButton:!0,confirmButtonText:"Aplicar Conversión",inputValidator:e=>{if(!e||e<=0)return"Ingrese un valor válido"}})).value;if(!u)return void(i.checked=!1);var m=parseFloat(u);t=d,a="USD"===c.currency&&"ARS"===t?(n=c.amount*m,` [Conv. de USD a tasa ${m}]`):(n=c.amount/m,` [Conv. de ARS a tasa ${m}]`)}var y,g=await p.collection("transactions").where("agreementId","==",r).where("periodKey","==",o).get();let e;g.empty?(y={type:"INCOME",entityName:c.name+a,cuit:c.cuit,address:"Facturación Mensual Automática",category:"Honorarios",status:"PAID",currency:t,accountId:c.accountId||null,amount:n,date:firebase.firestore.Timestamp.fromDate(new Date),isRecurring:!1,agreementId:r,periodKey:o,createdAt:new Date,createdBy:B()},e=await p.collection("transactions").add(y)):(e=g.docs[0],console.log("Found existing transaction for agreement period, linking...",e.id),Swal.fire({toast:!0,position:"top-end",icon:"warning",title:"Ingreso ya existía. Vinculado.",showConfirmButton:!1,timer:3e3}));var v={};v["invoices."+o]={sent:!0,date:(new Date).toISOString().split("T")[0],incomeId:e.id},await s.update(v),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Ingreso generado y Factura marcada.",showConfirmButton:!1,timer:3e3})}}else{var e=c.invoices?c.invoices[o]:null;if(e&&e.incomeId){if(!(await Swal.fire({title:"¿Deshacer cobro?",text:"Esto eliminará el ingreso asociado a esta factura. ¿Estás seguro?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar ingreso",cancelButtonText:"No, mantener"})).isConfirmed)return void(i.checked=!0);await p.collection("transactions").doc(e.incomeId).delete()}var n={};n["invoices."+o]=firebase.firestore.FieldValue.delete(),await s.update(n),Swal.fire({toast:!0,position:"top-end",icon:"info",title:"Factura desmarcada.",showConfirmButton:!1,timer:2e3})}}catch(e){console.error(e),i.checked=!t,Swal.fire("Error",e.message,"error")}else console.error("Acuerdo no encontrado")};let ce=new bootstrap.Modal(document.getElementById("modal-manage-accounts")),se=document.getElementById("form-account");o=document.getElementById("btn-config-accounts");function de(){var e=document.getElementById("account-summary-container");let a=document.getElementById("account-summary-list");E&&0!==E.length?(e.style.display="block",a.innerHTML="",E.filter(e=>!1!==e.isActive).forEach(e=>{var t=T(e.id),n=document.createElement("tr");n.innerHTML=`
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-xs me-2">
                            <span class="avatar-title rounded-circle bg-soft-primary text-primary font-size-10">
                                <i class="mdi mdi-bank"></i>
                            </span>
                        </div>
                        <div>
                            <h5 class="font-size-13 mb-0">${e.name}</h5>
                            <small class="text-muted">${e.currency}</small>
                        </div>
                    </div>
                </td>
                <td class="text-end">
                    <h5 class="font-size-14 mb-0 ${t<0?"text-danger":"text-success"}">${h(t,e.currency)}</h5>
                    <small class="text-muted">Disponible</small>
                </td>
            `,a.appendChild(n)})):e.style.display="none"}function T(t){var e=E.find(e=>e.id===t);return e?(Number(e.initialBalance)||0)+(e=v.filter(e=>e.accountId===t&&"PAID"===e.status)).filter(e=>"INCOME"===e.type).reduce((e,t)=>e+(Number(t.amount)||0),0)-e.filter(e=>"EXPENSE"===e.type).reduce((e,t)=>e+(Number(t.amount)||0),0)-v.filter(e=>e.accountId===t&&"SAVING"===e.type&&"ACTIVE"===e.status&&!0!==e.isInitial).reduce((e,t)=>e+(Number(t.amount)||0),0)-e.filter(e=>"INVESTMENT"===e.type).reduce((e,t)=>e+(Number(t.amount)||0),0)+e.filter(e=>"WITHDRAWAL"===e.type).reduce((e,t)=>e+(Number(t.amount)||0),0):0}o&&o.addEventListener("click",()=>ce.show()),se.addEventListener("submit",async function(e){e.preventDefault();var e=document.getElementById("acc-id").value,t=document.getElementById("btn-save-account"),n=t.innerHTML,a={name:document.getElementById("acc-name").value,currency:document.getElementById("acc-currency").value,initialBalance:parseFloat(document.getElementById("acc-initial-balance").value)||0,updatedAt:new Date,isActive:!0};try{if(!g.currentUser)throw new Error("Usuario no autenticado");t.disabled=!0,t.innerHTML='<i class="bx bx-loader bx-spin"></i>',e?await p.collection("cashflow_accounts").doc(e).update(a):(a.uid=B(),a.createdAt=new Date,await p.collection("cashflow_accounts").add(a)),se.reset(),document.getElementById("acc-id").value="",document.getElementById("title-account-form").textContent="Agregar Nueva Cuenta",Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Cuenta guardada.",showConfirmButton:!1,timer:2e3})}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar la cuenta.","error")}finally{t.disabled=!1,t.innerHTML=n}});let le=document.getElementById("acc-trans-source"),y=document.getElementById("acc-source-balance-info");le&&le.addEventListener("change",()=>{let t=le.value;var e,n;t?(e=E.find(e=>e.id===t))&&(n=T(t),y.innerHTML=`<i class="mdi mdi-information-outline me-1"></i> Disponible: <span class="text-primary fw-bold">${h(n,e.currency)}</span>`):y.innerHTML=""});r=document.getElementById("btn-transfer-saving");r&&r.addEventListener("click",()=>{y&&(y.innerHTML=""),m.show()});let ue=document.getElementById("form-account-transfer");ue.addEventListener("submit",async e=>{e.preventDefault();let t=document.getElementById("acc-trans-source").value,n=document.getElementById("acc-trans-dest").value;var a=parseFloat(document.getElementById("acc-trans-amount").value),r=document.getElementById("acc-trans-date").valueAsDate||new Date;if(t===n)Swal.fire("Error","La cuenta origen y destino no pueden ser la misma.","warning");else{var o=E.find(e=>e.id===t),i=E.find(e=>e.id===n);if(o&&i){var c=T(t);if(c<a)Swal.fire("Saldo Insuficiente",`La cuenta ${o.name} solo dispone de ${h(c,o.currency)}.`,"warning");else{c=e.target.querySelector('button[type="submit"]'),e=c.innerHTML;try{if(!g.currentUser)throw new Error("Usuario no autenticado");c.disabled=!0,c.innerHTML='<i class="bx bx-loader bx-spin"></i> Procesando...';var s="TRANS_"+Date.now(),d={type:"EXPENSE",entityName:"Transf. a "+i.name,category:"Transferencia Enviada",status:"PAID",currency:o.currency,accountId:t,amount:a,date:firebase.firestore.Timestamp.fromDate(r),transferId:s,createdAt:new Date,createdBy:B(),description:"Transferencia entre cuentas propias"},l={type:"INCOME",entityName:"Transf. de "+o.name,category:"Transferencia Recibida",status:"PAID",currency:i.currency,accountId:n,amount:a,date:firebase.firestore.Timestamp.fromDate(r),transferId:s,createdAt:new Date,createdBy:B(),description:"Transferencia entre cuentas propias"},u=p.batch();u.set(p.collection("transactions").doc(),d),u.set(p.collection("transactions").doc(),l),await u.commit(),m.hide(),ue.reset(),Swal.fire("Éxito","Transferencia realizada correctamente.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo realizar la transferencia.","error")}finally{c.disabled=!1,c.innerHTML=e}}}}});a=document.getElementById("btn-sync-agreements");a&&a.addEventListener("click",async()=>{var e=document.getElementById("btn-sync-agreements");if((await Swal.fire({title:"¿Sincronizar Acuerdos?",html:"Esto asignará la cuenta configurada actualmente en cada acuerdo a todos sus ingresos históricos que no tengan cuenta asignada.<br><br><b>¡Esto afectará los saldos de las cuentas!</b>",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, sincronizar",cancelButtonText:"Cancelar"})).isConfirmed){e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i> Procesando...';try{let n=p.batch(),a=0;for(let t of I.filter(e=>e.accountId&&!1!==e.isActive))v.filter(e=>e.agreementId===t.id&&"INCOME"===e.type&&e.accountId!==t.accountId).forEach(e=>{e=p.collection("transactions").doc(e.id);n.update(e,{accountId:t.accountId}),a++});0<a?(490<a&&console.warn("Large batch update, implementing chunking not included in this snippet. Proceeding with risk or partial."),await n.commit(),Swal.fire("Sincronización Completa",`Se actualizaron ${a} transacciones.`,"success"),W()):Swal.fire("Todo en orden","No se encontraron transacciones pendientes de actualizar.","info")}catch(e){console.error(e),Swal.fire("Error","Falló la sincronización: "+e.message,"error")}finally{e.disabled=!1,e.innerHTML='<i class="mdi mdi-refresh me-1"></i> Sync Acuerdos'}}}),window.openAssetModal=function(t=null){var e=document.getElementById("form-asset");e&&(e.reset(),document.getElementById("asset-id").value="",t&&(e=b.find(e=>e.id===t))&&(document.getElementById("asset-id").value=e.id,document.getElementById("asset-name").value=e.name,document.getElementById("asset-type").value=e.type,document.getElementById("asset-currency").value=e.currency,document.getElementById("asset-target").value=e.targetAmount,document.getElementById("asset-valuation").value=e.currentValuation),O.show())};e=document.getElementById("form-asset"),e&&e.addEventListener("submit",async e=>{e.preventDefault();var e=e.target.querySelector('button[type="submit"]'),t=e.innerHTML,n=document.getElementById("asset-id").value,a={name:document.getElementById("asset-name").value,type:document.getElementById("asset-type").value,currency:document.getElementById("asset-currency").value,targetAmount:parseFloat(document.getElementById("asset-target").value)||0,currentValuation:parseFloat(document.getElementById("asset-valuation").value)||0,updatedAt:new Date};try{e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i>',n?await p.collection("cashflow_assets").doc(n).update(a):(a.uid=B(),a.createdAt=new Date,a.investedAmount=0,await p.collection("cashflow_assets").add(a)),O.hide(),Swal.fire("Guardado","Activo actualizado.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo guardar.","error")}finally{e.disabled=!1,e.innerHTML=t}}),o=document.getElementById("btn-new-asset"),o&&o.addEventListener("click",()=>openAssetModal()),r=document.getElementById("btn-new-investment");r&&r.addEventListener("click",()=>{{let t=document.getElementById("inv-account"),n=document.getElementById("inv-asset"),e=document.getElementById("inv-exchange-section");t&&n&&(t.innerHTML='<option value="">Seleccione cuenta...</option>',n.innerHTML='<option value="">Seleccione activo...</option>',E.filter(e=>!1!==e.isActive).forEach(e=>{t.innerHTML+=`<option value="${e.id}">${e.name} (${e.currency})</option>`}),b.forEach(e=>{n.innerHTML+=`<option value="${e.id}">${e.name} (${e.currency})</option>`}),e&&(e.style.display="none"),document.getElementById("form-investment").reset(),V.show())}});let me=document.getElementById("inv-account"),ye=document.getElementById("inv-asset"),ge=document.getElementById("inv-amount"),ve=document.getElementById("inv-exchange-rate"),pe=document.getElementById("inv-final-asset-amount");a=()=>{let t=me.value,n=ye.value;var e,a,r=document.getElementById("inv-exchange-section");t&&n&&r&&(e=E.find(e=>e.id===t),a=b.find(e=>e.id===n),e&&a&&e.currency!==a.currency?(r.style.display="block",document.getElementById("inv-src-curr").innerText=e.currency,document.getElementById("inv-dst-curr").innerText=a.currency,Ee()):r.style.display="none")};let Ee=()=>{var e=parseFloat(ge.value)||0,t=parseFloat(ve.value)||0;pe.value=0<e&&0<t?(e/t).toFixed(2):""};me&&me.addEventListener("change",a),ye&&ye.addEventListener("change",a),ge&&ge.addEventListener("input",Ee),ve&&ve.addEventListener("input",Ee);e=document.getElementById("form-investment"),e&&e.addEventListener("submit",async e=>{e.preventDefault();var e=e.target.querySelector('button[type="submit"]'),t=e.innerHTML;let n=document.getElementById("inv-account").value,a=document.getElementById("inv-asset").value;var r=parseFloat(document.getElementById("inv-amount").value)||0,o=document.getElementById("inv-date").value,i=parseFloat(document.getElementById("inv-exchange-rate").value)||0,c=parseFloat(document.getElementById("inv-final-asset-amount").value)||r;if(!n||!a||r<=0||!o)Swal.fire("Error","Complete los campos.","warning");else{var s=E.find(e=>e.id===n),d=b.find(e=>e.id===a);if(s&&d&&s.currency!==d.currency&&i<=0)Swal.fire("Error","Ingrese la tasa de cambio para la conversión.","warning");else try{e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i>';var l={type:"INVESTMENT",accountId:n,assetId:a,amount:r,exchangeRate:0<i?i:1,assetAmount:c,date:firebase.firestore.Timestamp.fromDate(new Date(o)),category:"Inversión",status:"PAID",description:document.getElementById("inv-description").value||"Inversión",createdAt:new Date,createdBy:B()},u=(s&&(l.currency=s.currency),p.batch());u.set(p.collection("transactions").doc(),l),u.update(p.collection("cashflow_assets").doc(a),{investedAmount:firebase.firestore.FieldValue.increment(c),updatedAt:new Date}),await u.commit(),V.hide(),Swal.fire("Éxito","Inversión registrada.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo registrar.","error")}finally{e.disabled=!1,e.innerHTML=t}}}),window.deleteAsset=async function(e){if((await Swal.fire({title:"¿Eliminar Activo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar"})).isConfirmed)try{await p.collection("cashflow_assets").doc(e).delete(),Swal.fire("Eliminado","Activo borrado.","success")}catch(e){Swal.fire("Error","No se pudo eliminar.","error")}},o=document.getElementById("btn-new-withdrawal"),o&&o.addEventListener("click",()=>openWithdrawalModal()),r=document.getElementById("btn-new-asset-transfer");r&&r.addEventListener("click",()=>openAssetTransferModal());let N=document.getElementById("with-account"),L=document.getElementById("with-asset"),M=document.getElementById("with-amount"),D=document.getElementById("with-exchange-rate"),fe=document.getElementById("with-final-account-amount"),C=document.getElementById("trans-asset-src"),$=document.getElementById("trans-asset-dst"),k=document.getElementById("trans-amount"),H=document.getElementById("trans-exchange-rate"),Ie=document.getElementById("trans-final-amount");window.openWithdrawalModal=function(){N&&L&&(N.innerHTML='<option value="">Seleccione cuenta...</option>',L.innerHTML='<option value="">Seleccione activo...</option>',E.filter(e=>!1!==e.isActive).forEach(e=>{N.innerHTML+=`<option value="${e.id}">${e.name} (${e.currency})</option>`}),b.forEach(e=>{L.innerHTML+=`<option value="${e.id}">${e.name} (${e.currency})</option>`}),document.getElementById("with-asset-balance").textContent="",document.getElementById("with-exchange-section").style.display="none",document.getElementById("form-withdrawal").reset(),_.show())};let be=()=>{let t=N.value,n=L.value;var e,a,r=document.getElementById("with-exchange-section");t&&n&&r&&(e=E.find(e=>e.id===t),a=b.find(e=>e.id===n),e&&a&&e.currency!==a.currency?(r.style.display="block",document.getElementById("with-src-curr").innerText=a.currency,document.getElementById("with-dst-curr").innerText=e.currency,we()):r.style.display="none")},we=()=>{var e=parseFloat(M.value)||0,t=parseFloat(D.value)||0;fe.value=0<e&&0<t?(e*t).toFixed(2):""};N&&N.addEventListener("change",be),L&&L.addEventListener("change",()=>{let t=L.value;var e,n=document.getElementById("with-asset-balance");t&&n&&(e=b.find(e=>e.id===t),n.textContent=e?"Saldo disponible: "+h(e.investedAmount||0,e.currency):"",be())}),M&&M.addEventListener("input",we),D&&D.addEventListener("input",we);a=document.getElementById("form-withdrawal");a&&a.addEventListener("submit",async e=>{e.preventDefault();var e=e.target.querySelector('button[type="submit"]'),t=e.innerHTML;let n=N.value,a=L.value;var r=parseFloat(M.value)||0,o=document.getElementById("with-date").value,i=parseFloat(D.value)||0,c=parseFloat(fe.value)||r;if(!n||!a||r<=0||!o)Swal.fire("Error","Complete los campos.","warning");else{var s=E.find(e=>e.id===n),d=b.find(e=>e.id===a);if(!d||r>(d.investedAmount||0))Swal.fire("Error","El monto a retirar excede el saldo disponible en este activo.","error");else if(s&&d&&s.currency!==d.currency&&i<=0)Swal.fire("Error","Ingrese la tasa de cambio.","warning");else try{e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i>';var l={type:"WITHDRAWAL",accountId:n,assetId:a,amount:c,exchangeRate:0<i?i:1,assetAmount:r,date:firebase.firestore.Timestamp.fromDate(new Date(o)),category:"Retiro Inversión",status:"PAID",description:document.getElementById("with-description").value||"Retiro de activo",createdAt:new Date,createdBy:B()},u=(s&&(l.currency=s.currency),p.batch());u.set(p.collection("transactions").doc(),l),u.update(p.collection("cashflow_assets").doc(a),{investedAmount:firebase.firestore.FieldValue.increment(-r),updatedAt:new Date}),await u.commit(),_.hide(),Swal.fire("Éxito","Retiro registrado.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo realizar el retiro.","error")}finally{e.disabled=!1,e.innerHTML=t}}}),window.openAssetTransferModal=function(){C&&$&&(C.innerHTML='<option value="">Activo Origen...</option>',$.innerHTML='<option value="">Activo Destino...</option>',b.forEach(e=>{e=`<option value="${e.id}">${e.name} (${e.currency})</option>`;C.innerHTML+=e,$.innerHTML+=e}),document.getElementById("trans-asset-src-balance").textContent="",document.getElementById("trans-exchange-section").style.display="none",document.getElementById("form-asset-transfer").reset(),G.show())};let he=()=>{let t=C.value,n=$.value;var e,a,r=document.getElementById("trans-exchange-section");t&&n&&r&&(e=b.find(e=>e.id===t),a=b.find(e=>e.id===n),e&&a&&e.currency!==a.currency?(r.style.display="block",document.getElementById("trans-src-curr").innerText=e.currency,document.getElementById("trans-dst-curr").innerText=a.currency,Be()):r.style.display="none")},Be=()=>{var e=parseFloat(k.value)||0,t=parseFloat(H.value)||0;Ie.value=0<e&&0<t?(e*t).toFixed(2):""};C&&C.addEventListener("change",()=>{let t=C.value;var e,n=document.getElementById("trans-asset-src-balance");t&&n&&(e=b.find(e=>e.id===t),n.textContent=e?"Saldo disponible: "+h(e.investedAmount||0,e.currency):"",he())}),$&&$.addEventListener("change",he),k&&k.addEventListener("input",Be),H&&H.addEventListener("input",Be);e=document.getElementById("form-asset-transfer");e&&e.addEventListener("submit",async e=>{e.preventDefault();var e=e.target.querySelector('button[type="submit"]'),t=e.innerHTML;let n=C.value,a=$.value;var r=parseFloat(k.value)||0,o=document.getElementById("trans-date").value,i=parseFloat(H.value)||0,c=parseFloat(Ie.value)||r;if(!n||!a||r<=0||!o||n===a)Swal.fire("Error","Complete los campos correctamente. Origen y destino deben ser diferentes.","warning");else{var s=b.find(e=>e.id===n),d=b.find(e=>e.id===a);if(!s||r>(s.investedAmount||0))Swal.fire("Error","Monto insuficiente en el activo de origen.","error");else if(s&&d&&s.currency!==d.currency&&i<=0)Swal.fire("Error","Ingrese la tasa de cambio.","warning");else try{e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin"></i>';var l={type:"ASSET_TRANSFER",assetId:n,assetDstId:a,amount:r,exchangeRate:0<i?i:1,assetAmount:c,date:firebase.firestore.Timestamp.fromDate(new Date(o)),category:"Transferencia Activos",status:"PAID",description:document.getElementById("trans-description").value||"Transferencia entre activos",createdAt:new Date,createdBy:B(),currency:s.currency},u=p.batch();u.set(p.collection("transactions").doc(),l),u.update(p.collection("cashflow_assets").doc(n),{investedAmount:firebase.firestore.FieldValue.increment(-r),updatedAt:new Date}),u.update(p.collection("cashflow_assets").doc(a),{investedAmount:firebase.firestore.FieldValue.increment(c),updatedAt:new Date}),await u.commit(),G.hide(),Swal.fire("Éxito","Transferencia realizada.","success")}catch(e){console.error(e),Swal.fire("Error","No se pudo realizar la transferencia.","error")}finally{e.disabled=!1,e.innerHTML=t}}})});