let clientId=null,clientData=null;async function loadClientProfile(){try{var e,t=await db.collection("clients").doc(clientId).get();t.exists?(renderProfileHeader(clientData=t.data()),renderProfileInfo(clientData),clientData.nextContact&&(e=new Date(1e3*clientData.nextContact.seconds),document.getElementById("next-contact-date").value=e.toISOString().split("T")[0])):Swal.fire("Error","Cliente no encontrado.","error")}catch(e){console.error("Error loading profile",e)}}function renderProfileHeader(e){document.getElementById("profile-name").textContent=e.name,document.getElementById("profile-type").textContent="OFFICE"===e.type?"Oficina":"Cliente";var t,a=document.getElementById("profile-avatar");"OFFICE"===e.type?(a.className="avatar-title bg-primary-subtle text-primary display-4 m-0 rounded-circle",a.innerHTML='<i class="bx bxs-building-house"></i>'):(t=e.name.substring(0,2).toUpperCase(),a.className="avatar-title bg-light-subtle text-primary display-4 m-0 rounded-circle",a.textContent=t),document.getElementById("profile-email").textContent=e.email||"",document.getElementById("profile-phone").textContent=e.phone||""}function renderProfileInfo(e){document.getElementById("profile-desc").innerHTML=e.description?`<p>${e.description}</p>`:'<p class="text-muted">Sin descripción.</p>',document.getElementById("info-email").textContent=e.email||" - ",document.getElementById("info-phone").textContent=e.phone||" - ";var t=e.birthDate?new Date(e.birthDate).toLocaleDateString("es-ES",{timeZone:"UTC"}):" - ";document.getElementById("info-bday").textContent=t,e.parentId?db.collection("clients").doc(e.parentId).get().then(e=>{e.exists&&(document.getElementById("info-office").textContent=e.data().name)}):document.getElementById("info-office").textContent="OFFICE"===e.type?"Es Oficina":"Independiente"}document.addEventListener("DOMContentLoaded",function(){window.Imala.auth.checkAuth(e=>{var t=new URLSearchParams(window.location.search);(clientId=t.get("id"))?(loadClientProfile(),loadBitacora(),loadRelatedTasks(),loadAttachments()):Swal.fire("Error","No se especificó un cliente.","error")})});let bitacoraNotes=[],bitacoraTasks=[];function loadBitacora(){db.collection("clients").doc(clientId).collection("bitacora").orderBy("createdAt","desc").onSnapshot(e=>{bitacoraNotes=[],e.forEach(e=>{bitacoraNotes.push({id:e.id,...e.data(),_source:"NOTE"})}),renderUnifiedBitacora()}),db.collection("tasks").where("clientId","==",clientId).onSnapshot(e=>{bitacoraTasks=[],e.forEach(e=>{var t=e.data();bitacoraTasks.push({id:e.id,text:`Tarea: ${t.title} (${getStatusLabel(t.status)})`,type:"TASK",createdAt:t.createdAt,_source:"TASK"})}),renderUnifiedBitacora()})}function renderUnifiedBitacora(){let n=document.getElementById("bitacora-list");n.innerHTML="";var e=[...bitacoraNotes,...bitacoraTasks];e.sort((e,t)=>{e=e.createdAt?e.createdAt.seconds||new Date(e.createdAt).getTime()/1e3:0;return(t.createdAt?t.createdAt.seconds||new Date(t.createdAt).getTime()/1e3:0)-e}),0===e.length?n.innerHTML='<li class="text-center text-muted p-3">No hay registros en la bitácora todavía.</li>':e.forEach(e=>{var t=e.createdAt?e.createdAt.seconds?new Date(1e3*e.createdAt.seconds):new Date(e.createdAt):new Date,t=t.toLocaleDateString()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let a="bx-pencil";"TASK"===e.type&&(a="bx-task"),"MEETING"===e.type&&(a="bx-microphone"),"SYSTEM"===e.type&&(a="bx-cog"),n.innerHTML+=`
            <li class="event-list">
                <div class="event-timeline-dot">
                    <i class="bx ${a} font-size-18"></i>
                </div>
                <div class="d-flex mb-2">
                    <div class="flex-shrink-0 me-3">
                        <i class="bx ${a} h2 text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div>
                            <h5 class="font-size-15 mb-0">${e.text}</h5>
                            <small class="text-muted">${t}</small>
                        </div>
                    </div>
                </div>
            </li>
        `})}function addBitacoraNote(){var e=document.getElementById("note-input").value;e.trim()&&db.collection("clients").doc(clientId).collection("bitacora").add({text:e,type:"MANUAL",createdAt:new Date,createdBy:auth.currentUser.uid}).then(()=>{document.getElementById("note-input").value="",Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Nota agregada",showConfirmButton:!1,timer:1500})})}function loadRelatedTasks(){db.collection("tasks").where("clientId","==",clientId).limit(10).get().then(e=>{let n=document.getElementById("tasks-list");if(n.innerHTML="",e.empty)n.innerHTML='<li class="list-group-item text-center text-muted">No hay tareas pendientes.</li>';else{let t=[];e.forEach(e=>t.push(e.data())),t.sort((e,t)=>(e.dueDate||"")>(t.dueDate||"")?1:-1),t.forEach(e=>{var t=(e.createdAt?e.createdAt.seconds?new Date(1e3*e.createdAt.seconds):new Date(e.createdAt):new Date).toLocaleDateString(),a=getStatusBadgeHTML(e.status);n.innerHTML+=`
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${e.title}</h6>
                        <small class="text-muted">Creación: ${t}</small>
                    </div>
                    ${a}
                </li>`})}}).catch(e=>{console.error("Error loading tasks:",e),document.getElementById("tasks-list").innerHTML=`<li class="list-group-item text-danger text-center">Error al cargar tareas: ${e.message}</li>`})}function getStatusLabel(e){return"TODO"===e?"Pendiente":"COMPLETED"===e?"Completado":"LATE"===e?"Atrasado":e}function getStatusBadgeHTML(e){return"TODO"===e?'<span class="badge bg-warning">Pendiente</span>':"COMPLETED"===e?'<span class="badge bg-success">Completado</span>':"LATE"===e?'<span class="badge bg-danger">Atrasado</span>':`<span class="badge bg-secondary">${e}</span>`}async function updateNextContact(){var e,t,a=document.getElementById("next-contact-date").value;a&&(e=new Date(a),await db.collection("clients").doc(clientId).update({nextContact:e}),t="Seguimiento: "+clientData.name,await db.collection("tasks").add({title:t,description:"Tarea generada automáticamente desde Perfil de Cliente (Próximo Contacto).",dueDate:e,clientId:clientId,clientName:clientData.name,status:"PENDING",createdAt:new Date,createdBy:auth.currentUser.uid}),await db.collection("clients").doc(clientId).collection("bitacora").add({text:"Se programó un próximo contacto para el "+a,type:"SYSTEM",createdAt:new Date}),Swal.fire("Agenda Actualizada","Se creó la tarea de seguimiento automáticamente.","success"))}function loadAttachments(){db.collection("clients").doc(clientId).collection("attachments").orderBy("createdAt","desc").onSnapshot(e=>{let i=document.getElementById("attachments-list");i.innerHTML="",e.empty?i.innerHTML='<tr><td colspan="4" class="text-center text-muted p-4">No hay archivos adjuntos.</td></tr>':e.forEach(e=>{var t=e.data(),a=t.createdAt?(t.createdAt.seconds?new Date(1e3*t.createdAt.seconds):new Date).toLocaleDateString():"-";let n="bx-file";t.type.includes("pdf")?n="bxs-file-pdf text-danger":t.type.includes("image")?n="bxs-image text-success":t.type.includes("word")||t.type.includes("officedocument")?n="bxs-file-doc text-primary":(t.type.includes("spreadsheet")||t.type.includes("excel"))&&(n="bxs-file-json text-success"),i.innerHTML+=`
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bx ${n} font-size-24 me-2"></i>
                                <div>
                                    <h5 class="font-size-14 mb-1"><a href="${t.url}" target="_blank" class="text-dark">${t.name}</a></h5>
                                    <small class="text-muted">${t.type}</small>
                                </div>
                            </div>
                        </td>
                        <td>${a}</td>
                        <td>${formatBytes(t.size)}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <a href="${t.url}" target="_blank" class="btn btn-sm btn-soft-primary"><i class="bx bx-download"></i></a>
                                <button class="btn btn-sm btn-soft-danger" onclick="deleteAttachment('${e.id}', '${t.name}')">
                                    <i class="bx bx-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `})})}async function uploadAttachment(){var e=document.getElementById("attachment-input"),t=e.files[0];if(t)if(window.Imala.storage){var a=window.Imala.storage.ref().child(`clients/${clientId}/`+t.name);Swal.fire({title:"Subiendo...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});try{var n=await(await a.put(t)).ref.getDownloadURL();await db.collection("clients").doc(clientId).collection("attachments").add({name:t.name,type:t.type,size:t.size,url:n,createdAt:new Date,createdBy:auth.currentUser.uid}),Swal.fire("Completado","Archivo subido correctamente","success"),e.value=""}catch(e){console.error("Upload error",e),Swal.fire("Error","No se pudo subir el archivo: "+e.message,"error")}}else Swal.fire("Error","Firebase Storage no está habilitado.","error");else Swal.fire("Atención","Selecciona un archivo primero","warning")}async function deleteAttachment(e,t){if((await Swal.fire({title:"¿Seguro?",text:"Se eliminará el archivo permanentemente",icon:"warning",showCancelButton:!0})).isConfirmed)try{Swal.showLoading(),window.Imala.storage&&await window.Imala.storage.ref().child(`clients/${clientId}/`+t).delete().catch(e=>console.warn("File not found in storage, deleting doc only",e)),await db.collection("clients").doc(clientId).collection("attachments").doc(e).delete(),Swal.fire("Eliminado","Archivo eliminado.","success")}catch(e){console.error(e),Swal.fire("Error","Error al eliminar: "+e.message,"error")}}function formatBytes(e,t=2){var a;return 0===e?"0 Bytes":(t=t<0?0:t,a=Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,a)).toFixed(t))+" "+["Bytes","KB","MB","GB","TB"][a])}