document.addEventListener("DOMContentLoaded",function(){var t=window.Imala.auth;let o=window.Imala.db,n=document.getElementById("dashboard-user-name"),s=document.getElementById("dashboard-user-role");document.getElementById("dashboard-user-avatar");t.onAuthStateChanged(a=>{a&&o.collection("users").doc(a.uid).get().then(e=>{var t=e.exists?e.data():{};e.exists&&(n&&(n.textContent=t.displayName||"Usuario"),s)&&(s.textContent=t.role||"Rol"),a.uid,o.collection("tasks").onSnapshot(u=>{let m=[];u.forEach(e=>{"settings_categories"!==e.id&&(e={id:e.id,...e.data()},m.push(e))}),d=m,i();{u=m;let e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),s=t+`-${a}-`+n,o=e=>{var t;return e.dueDate&&e.dueDate.seconds?`${(t=new Date(1e3*e.dueDate.seconds)).getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0"):e.dueDate&&"string"==typeof e.dueDate?e.dueDate.split("T")[0]:"9999-99-99"},d=u.filter(e=>"COMPLETED"!==e.status&&o(e)===s).length,i=u.filter(e=>"COMPLETED"!==e.status&&(o(e)<s||"LATE"===e.status)).length,l=u.filter(e=>"COMPLETED"===e.status).length,r=document.getElementById("kpi-tasks-pending"),c=document.getElementById("kpi-tasks-late-badge");document.getElementById("stat-pending")&&(document.getElementById("stat-pending").textContent=d),document.getElementById("stat-late")&&(document.getElementById("stat-late").textContent=i),document.getElementById("stat-completed")&&(document.getElementById("stat-completed").textContent=l),r&&(r.textContent=d),c&&(c.textContent=i+" Atrasadas",c.classList.remove("d-none"))}{u=m;let a=document.getElementById("dashboard-tasks-list");if(a){a.innerHTML="";var e=new Date,t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),e=String(e.getDate()).padStart(2,"0");let n=t+`-${s}-`+e;t=u.filter(e=>{var t,a;return"COMPLETED"!==e.status&&(t=(a=e).dueDate&&a.dueDate.seconds?`${(t=new Date(1e3*a.dueDate.seconds)).getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0"):"string"==typeof a.dueDate?a.dueDate.split("T")[0]:"9999-99-99",a="LATE"===e.status||t<n,e=t===n,a||e)});t.sort((e,t)=>{var a=e=>{var t;return e.dueDate&&e.dueDate.seconds?(t=new Date(1e3*e.dueDate.seconds)).getFullYear()+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0"):e.dueDate?e.dueDate.split("T")[0]:"9999-99-99"},n=a(e),a=a(t),s=new Date,s=s.getFullYear()+`-${String(s.getMonth()+1).padStart(2,"0")}-`+String(s.getDate()).padStart(2,"0"),e="LATE"===e.status||n<s,t="LATE"===t.status||a<s;return e&&!t?-1:!e&&t?1:(e=a===s,(t=n===s)&&!e?-1:!t&&e?1:n.localeCompare(a))}),0===t.length?a.innerHTML='<tr><td colspan="5" class="text-center text-muted p-4">¡Todo listo! No tienes tareas pendientes.</td></tr>':t.slice(0,20).forEach((e,t)=>a.appendChild(((t,e)=>{let a="-",n=!1,s=new Date,o=s.getFullYear(),d=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getDate()).padStart(2,"0"),l=`${o}-${d}-`+i,r="9999-99-99";var c;t.dueDate&&(t.dueDate.seconds?(c=new Date(1e3*t.dueDate.seconds),a=c.toLocaleDateString(),r=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}-`+String(c.getDate()).padStart(2,"0")):"string"==typeof t.dueDate&&(c=t.dueDate.split("-"),a=3===c.length?c[2]+"/"+c[1]:t.dueDate,r=t.dueDate.split("T")[0])),r===l&&(n=!0);let u="LATE"===t.status?'<span class="badge bg-danger-subtle text-danger font-size-11">Atrasada</span>':'<span class="badge bg-warning-subtle text-warning font-size-11">Pendiente</span>',m=(n&&"LATE"!==t.status&&"COMPLETED"!==t.status&&(u='<span class="badge bg-info-subtle text-info font-size-11">HOY</span>'),'<span class="text-muted font-size-11">-</span>');if(t.assignedTo){var g=t.assignedTo,p=g.charAt(0).toUpperCase();let e="Ambos"===g?"info":"Lucre"===g?"pink":"primary";m=`
                <div class="avatar-xs" title="${g}">
                    <span class="avatar-title rounded-circle bg-${e} text-white font-size-12 d-flex align-items-center justify-content-center">
                        ${p}
                    </span>
                </div>
             `}let v="";return v="LATE"===t.status?`<button class="btn btn-sm btn-outline-danger" onclick="completeTask('${t.id}')" title="Regularizar"><i class="bx bx-check"></i></button>`:`<button class="btn btn-sm btn-outline-success" onclick="completeTask('${t.id}')" title="Completar"><i class="bx bx-check"></i></button>`,(g=document.createElement("tr")).innerHTML=`
            <td><h6 class="mb-0 font-size-13">${e}</h6></td>
            <td>
                <h6 class="text-truncate font-size-14 mb-1" style="max-width: 250px;">
                    <a href="apps-tareas.html" class="text-dark">${t.title}</a>
                </h6>
            </td>
            <td>${m}</td>
            <td>
               <div class="font-size-13"><i class="bx bx-calendar me-1 text-muted"></i> ${a}</div>
            </td>
            <td>${u}</td>
            <td>${v}</td>
        `,g})(e,t+1)))}}s=m,e=document.getElementById("dashboard-noti-list-widget");if(e){let a=[],n=(s.forEach(e=>{(e.hasUserUnread||e.userUnreadCount&&0<e.userUnreadCount)&&a.push({type:"message",title:"Mensaje Nuevo",text:"En: "+e.title,time:"Reciente",icon:"bx-chat",color:"danger"})}),Date.now()),t=(s.forEach(e=>{var t;"COMPLETED"!==e.status&&e.createdAt&&(t=e.createdAt.seconds?1e3*e.createdAt.seconds:null)&&n-t<864e5&&!e.hasUserUnread&&a.push({type:"task",title:"Nueva Tarea",text:e.title,time:"Hoy",icon:"bx-task",color:"primary"})}),0===a.length&&a.push({type:"system",title:"Sistema",text:"Bienvenido a Imalá OS v2.0",time:"Ahora",icon:"bx-info-circle",color:"info"}),"");a.slice(0,5).forEach(e=>{t+=`
                <li class="activity-list activity-border">
                    <div class="activity-icon avatar-md">
                        <span class="avatar-title bg-${e.color}-subtle text-${e.color} rounded-circle">
                            <i class="bx ${e.icon} font-size-20"></i>
                        </span>
                    </div>
                    <div class="timeline-list-item">
                        <div class="d-flex">
                            <div class="flex-grow-1 overflow-hidden me-4">
                                <h5 class="font-size-14 mb-1">${e.title}</h5>
                                <p class="text-truncate text-muted font-size-13">${e.text}</p>
                            </div>
                            <div class="flex-shrink-0 text-end">
                                <span class="font-size-11">${e.time}</span>
                            </div>
                        </div>
                    </div>
                </li>
            `}),e.innerHTML=t}}),o.collection("clients").where("type","==","CLIENT").get().then(e=>{var e=e.size,t=document.getElementById("kpi-clients-count");t&&(t.textContent=e)}).catch(e=>console.error("Error loading clients:",e))}).catch(e=>{console.error("Error loading user profile:",e)})});let d=[];function i(){let a=new Date,n=!1;d.forEach(e=>{var t;"google"===e.source&&"COMPLETED"!==e.status&&e.dueDate&&(t=e.dueDate+(e.dueTime?"T"+e.dueTime:"T23:59:59"),new Date(t)<a)&&(o.collection("tasks").doc(e.id).update({status:"COMPLETED"}),n=!0)}),n&&Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0}).fire({icon:"info",title:"Tareas de Google actualizadas automáticamente"})}setInterval(i,3e5),window.completeTask=function(e){o.collection("tasks").doc(e).update({status:"COMPLETED"}).then(()=>{Swal.fire({icon:"success",title:"¡Tarea Completada!",showConfirmButton:!1,timer:1500,toast:!0,position:"top-end"})})};t=document.getElementById("event-modal");if(t){let a=new bootstrap.Modal(t),e=document.getElementById("form-event"),n=[],s=[];function l(){o.collection("clients").where("type","==","CLIENT").get().then(e=>{n=[],e.forEach(e=>{n.push({id:e.id,...e.data()})});{let a=document.getElementById("event-client-id");a&&(a.innerHTML='<option value="">- Ninguno -</option>',n.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,a.appendChild(t)}))}}),o.collection("users").get().then(e=>{s=[],e.forEach(e=>{var t=e.data();s.push({uid:e.id,name:t.displayName||"Usuario"})});{let a=document.getElementById("event-assignedTo");a&&(a.innerHTML=`
                <option value="David">David</option>
                <option value="Ambos">Ambos</option>
            `,s.forEach(e=>{var t;"David"!==e.name&&((t=document.createElement("option")).value=e.name,t.textContent=e.name,a.appendChild(t))}))}})}document.querySelectorAll('a[href="apps-tareas.html"]').forEach(e=>{e.textContent.includes("Nueva Tarea")&&e.addEventListener("click",e=>{e.preventDefault(),openNewTaskModal()})}),window.openNewTaskModal=function(){l(),e.reset(),document.getElementById("task-id").value="",document.getElementById("event-dueDate").value=(new Date).toISOString().split("T")[0],document.getElementById("event-status").value="TODO",a.show()},e.addEventListener("submit",e=>{e.preventDefault();let t={title:document.getElementById("event-title").value,description:document.getElementById("event-description").value,category:document.getElementById("event-category").value,priority:document.getElementById("event-priority").value,status:"TODO",assignedTo:document.getElementById("event-assignedTo").value,recurrence:document.getElementById("event-recurrence").value,dueDate:document.getElementById("event-dueDate").value,dueTime:document.getElementById("event-dueTime").value,clientId:document.getElementById("event-client-id").value||null,createdAt:new Date,userAgent:"Dashboard"};t.clientId&&(e=n.find(e=>e.id===t.clientId))&&(t.clientName=e.name),o.collection("tasks").add(t).then(()=>{a.hide(),Swal.fire({icon:"success",title:"Tarea Creada",showConfirmButton:!1,timer:1500,toast:!0,position:"top-end"})}).catch(e=>{console.error(e),Swal.fire("Error","No se pudo crear la tarea","error")})})}});