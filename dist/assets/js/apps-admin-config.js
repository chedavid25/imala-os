document.addEventListener("DOMContentLoaded",function(){let a=window.Imala.db;var e=window.Imala.auth;let i=new bootstrap.Modal(document.getElementById("user-modal")),l=new bootstrap.Modal(document.getElementById("structure-modal")),s=[],m=[],u=[],t;e.onAuthStateChanged(e=>{e?a.collection("users").doc(e.uid).get().then(e=>{e.exists&&e.data().role,a.collection("offices").onSnapshot(e=>{m=[],e.forEach(e=>m.push({id:e.id,...e.data()})),v(),I()}),a.collection("teams").onSnapshot(e=>{u=[],e.forEach(e=>u.push({id:e.id,...e.data()})),v(),I()}),a.collection("users").onSnapshot(e=>{console.log("Admin Panel: Recibida actualizaciÃ³n de usuarios. Cantidad:",e.size),s=[],e.forEach(e=>{var t=e.data();console.log("Usuario encontrado:",t.displayName,t.email),s.push({id:e.id,...t})});{t&&t.destroy();let o=document.querySelector("#datatable-users tbody");o.innerHTML="",s.forEach(t=>{var e,d=document.createElement("tr"),n=m.find(e=>e.id===t.officeId)?.name||"-",a=u.find(e=>e.id===t.teamId)?.name||"-";let i="-",l=("ASSISTANT"===t.role&&t.assignedToId&&("USER"===t.assignedToType?(e=s.find(e=>e.id===t.assignedToId),i=`Asiste a: <b>${e?e.displayName:"Usuario Desconocido"}</b>`):"TEAM"===t.assignedToType?(e=u.find(e=>e.id===t.assignedToId),i=`Asiste al Equipo: <b>${e?e.name:"Desc."}</b>`):"OFFICE"===t.assignedToType&&(e=m.find(e=>e.id===t.assignedToId),i=`Asiste a Oficina: <b>${e?e.name:"Desc."}</b>`)),"bg-secondary");"ADMIN"===t.role&&(l="bg-danger"),"BROKER"===t.role&&(l="bg-primary"),"TEAM_LEADER"===t.role&&(l="bg-info"),"MEMBER"===t.role&&(l="bg-success"),"ASSISTANT"===t.role&&(l="bg-warning text-dark"),d.innerHTML=`
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-xs me-2">
                            <span class="avatar-title rounded-circle bg-light text-primary font-size-12">
                                ${t.displayName?t.displayName.charAt(0):"U"}
                            </span>
                        </div>
                        <div>
                            <h5 class="font-size-14 mb-0">${t.displayName||"Sin Nombre"}</h5>
                            <small class="text-muted">ID: ${t.id.substring(0,6)}...</small>
                        </div>
                    </div>
                </td>
                <td>${t.email}</td>
                <td><span class="badge ${l} font-size-11">${t.role||"MEMBER"}</span></td>
                <td>
                    <div class="d-flex flex-column font-size-11">
                        <span>Ofi: ${n}</span>
                        <span>Eq: ${a}</span>
                    </div>
                </td>
                <td><small>${i}</small></td>
                <td>
                    <button class="btn btn-sm btn-soft-primary edit-user-btn" data-id="${t.id}"><i class="mdi mdi-pencil"></i></button>
                </td>
            `,o.appendChild(d)}),t=$("#datatable-users").DataTable({language:{emptyTable:"No hay usuarios"}}),o.onclick=e=>{e=e.target.closest(".edit-user-btn");e&&c(e.dataset.id)}}v()},e=>{console.error("Error cargando usuarios:",e)})}):window.location.href="auth-login.html"});let d=document.getElementById("edit-user-role"),n=document.querySelectorAll(".context-field");e=document.getElementsByName("assist-type");function o(){let t=d.value;n.forEach(e=>{e.dataset.visibleFor.split(" ").includes(t)?e.classList.remove("d-none"):e.classList.add("d-none")}),"ASSISTANT"===t&&r()}function r(){var e=document.querySelector('input[name="assist-type"]:checked').value;let d=document.getElementById("edit-assist-target");d.innerHTML="","USER"===e?s.forEach(e=>{var t;e.id!==document.getElementById("edit-user-id").value&&((t=document.createElement("option")).value=e.id,t.textContent=e.displayName+` (${e.role||"MEMBER"})`,d.appendChild(t))}):"TEAM"===e?u.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,d.appendChild(t)}):"OFFICE"===e&&m.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,d.appendChild(t)})}function c(t){var e,d=s.find(e=>e.id===t);d&&(document.getElementById("edit-user-id").value=t,document.getElementById("edit-user-name").value=d.displayName||d.email,document.getElementById("edit-user-role").value=d.role||"MEMBER",o(),d.officeId&&(document.getElementById("edit-user-office").value=d.officeId),d.teamId&&(document.getElementById("edit-user-team").value=d.teamId),"ASSISTANT"===d.role&&(e=d.assignedToType||"USER",e=document.querySelector(`input[name="assist-type"][value="${e}"]`))&&(e.checked=!0,r(),document.getElementById("edit-assist-target").value=d.assignedToId||""),i.show())}d.addEventListener("change",o),e.forEach(e=>e.addEventListener("change",r)),document.getElementById("form-user").addEventListener("submit",e=>{e.preventDefault();var e=document.getElementById("edit-user-id").value,t=document.getElementById("edit-user-role").value,d={role:t};["BROKER","TEAM_LEADER","MEMBER","ASSISTANT"].includes(t)?d.officeId=document.getElementById("edit-user-office").value||null:d.officeId=null,["TEAM_LEADER","MEMBER","ASSISTANT"].includes(t)?d.teamId=document.getElementById("edit-user-team").value||null:d.teamId=null,"ASSISTANT"===t?(d.assignedToType=document.querySelector('input[name="assist-type"]:checked').value,d.assignedToId=document.getElementById("edit-assist-target").value):(d.assignedToType=null,d.assignedToId=null),a.collection("users").doc(e).update(d).then(()=>{i.hide()}).catch(e=>alert("Error: "+e.message))});var e=document.getElementById("btn-add-office"),E=document.getElementById("btn-add-team"),g=document.getElementById("form-structure");function y(e){if(document.getElementById("struct-type").value=e,document.getElementById("struct-id").value="",document.getElementById("struct-name").value="","OFFICE"===e)document.getElementById("structure-modal-title").textContent="Nueva Oficina",document.getElementById("struct-office-group").classList.add("d-none");else{document.getElementById("structure-modal-title").textContent="Nuevo Equipo",document.getElementById("struct-office-group").classList.remove("d-none");let d=document.getElementById("struct-parent-office");d.innerHTML="",m.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,d.appendChild(t)})}l.show()}function v(){let d=document.getElementById("office-list"),n=(d.innerHTML="",m.forEach(e=>{var t=document.createElement("div");t.className="card mb-1 border border-primary border-opacity-25",t.innerHTML=`
                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="mdi mdi-building text-primary me-2"></i> 
                        <b>${e.name}</b>
                        <br><small class="text-muted text-xs ms-4">ID: ${e.id.substring(0,4)}...</small>
                    </div>
                </div>
            `,d.appendChild(t)}),document.getElementById("team-list")),a=(n.innerHTML="",u.forEach(t=>{var e=m.find(e=>e.id===t.officeId)?.name||"Sin Oficina",d=document.createElement("div");d.className="card mb-1 border border-info border-opacity-25",d.innerHTML=`
                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="mdi mdi-account-group text-info me-2"></i> 
                        <b>${t.name}</b>
                        <br><small class="text-muted ms-4">Ofi: ${e}</small>
                    </div>
                </div>
            `,n.appendChild(d)}),document.getElementById("independent-list"));a.innerHTML="",s.filter(e=>!e.officeId&&!e.teamId).forEach(e=>{var t=document.createElement("div");t.className="card mb-1 border border-warning border-opacity-25",t.innerHTML=`
                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                    <div class="text-truncate" style="max-width: 80%;">
                        <i class="mdi mdi-account text-warning me-2"></i> 
                        <b>${e.displayName||e.email||"Sin Nombre"}</b>
                        <br><small class="text-muted ms-4">${e.role||"Member"}</small>
                    </div>
                    <button class="btn btn-sm btn-ghost-secondary edit-user-btn" data-id="${e.id}"><i class="mdi mdi-pencil"></i></button>
                </div>
            `,a.appendChild(t)}),a.querySelectorAll(".edit-user-btn").forEach(e=>{e.addEventListener("click",()=>c(e.dataset.id))})}e.addEventListener("click",()=>{y("OFFICE")}),E.addEventListener("click",()=>{y("TEAM")}),g.addEventListener("submit",e=>{e.preventDefault();var e=document.getElementById("struct-type").value,t=document.getElementById("struct-name").value,d=document.getElementById("struct-parent-office").value,n="OFFICE"===e?"offices":"teams",t={name:t,createdAt:new Date};"TEAM"===e&&(t.officeId=d),a.collection(n).add(t).then(()=>{l.hide()}).catch(e=>alert(e.message))});e=document.getElementById("btn-add-user-struct");e&&e.addEventListener("click",()=>{document.getElementById("edit-user-id").value="",document.getElementById("edit-user-name").value="",document.getElementById("edit-user-name").removeAttribute("readonly"),document.getElementById("edit-user-email").value="",document.getElementById("edit-user-email").removeAttribute("readonly"),document.getElementById("email-warning").classList.add("d-none"),document.getElementById("edit-user-role").value="MEMBER",document.getElementById("edit-user-office").value="",document.getElementById("edit-user-team").value="",document.getElementById("user-modal-title").textContent="Nuevo Usuario",o(),i.show()});function I(){let d=document.getElementById("edit-user-office"),n=document.getElementById("edit-user-team");var e=d.value,t=n.value;d.innerHTML='<option value="">Sin Oficina</option>',m.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,d.appendChild(t)}),n.innerHTML='<option value="">Sin Equipo</option>',u.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,n.appendChild(t)}),d.value=e,n.value=t}c=function(t){var e,d=s.find(e=>e.id===t);d&&(document.getElementById("edit-user-id").value=t,document.getElementById("edit-user-name").value=d.displayName||"",document.getElementById("edit-user-name").removeAttribute("readonly"),document.getElementById("edit-user-email").value=d.email||"",document.getElementById("edit-user-email").setAttribute("readonly",!0),document.getElementById("email-warning").classList.remove("d-none"),document.getElementById("edit-user-role").value=d.role||"MEMBER",document.getElementById("user-modal-title").textContent="Editar Usuario",o(),d.officeId&&(document.getElementById("edit-user-office").value=d.officeId),d.teamId&&(document.getElementById("edit-user-team").value=d.teamId),"ASSISTANT"===d.role&&(e=d.assignedToType||"USER",e=document.querySelector(`input[name="assist-type"][value="${e}"]`))&&(e.checked=!0,r(),document.getElementById("edit-assist-target").value=d.assignedToId||""),i.show())},document.getElementById("form-user").addEventListener("submit",e=>{e.preventDefault();var e=document.getElementById("edit-user-id").value,t=document.getElementById("edit-user-name").value,d=document.getElementById("edit-user-email").value,n=document.getElementById("edit-user-role").value,t={displayName:t,role:n,updatedAt:new Date};e||(t.email=d,t.createdAt=new Date),["BROKER","TEAM_LEADER","MEMBER","ASSISTANT"].includes(n)?t.officeId=document.getElementById("edit-user-office").value||null:t.officeId=null,["TEAM_LEADER","MEMBER","ASSISTANT"].includes(n)?t.teamId=document.getElementById("edit-user-team").value||null:t.teamId=null,"ASSISTANT"===n?(t.assignedToType=document.querySelector('input[name="assist-type"]:checked').value,t.assignedToId=document.getElementById("edit-assist-target").value):(t.assignedToType=null,t.assignedToId=null),e?a.collection("users").doc(e).update(t).then(()=>i.hide()).catch(e=>alert("Error: "+e.message)):a.collection("users").add(t).then(()=>{i.hide(),alert("Usuario creado en base de datos. Nota: Esto no crea la cuenta de acceso (Auth), solo el perfil.")}).catch(e=>alert("Error: "+e.message))})});